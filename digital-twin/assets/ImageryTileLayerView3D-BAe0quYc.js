import{pD as z,pE as $,pF as G,pG as T,jc as E,pH as S,pI as F,pJ as M,pK as p,pL as U,r as c,m as d,a as j,F as N,R as W,w as k,pM as J}from"./index-Bmji7YKu.js";import{_ as Z,x as v,O as H}from"./rasterProjectionHelper-Cwt8Q15R.js";import{l as q}from"./LayerView3D-CQaKjHif.js";import{p as Y}from"./TiledLayerView3D-DgLzKCYt.js";import{V as K,t as w,n as Q}from"./rasterFieldUtils-CQDAVfap.js";import{i as X}from"./timeSupport-FsTfSZo_.js";import{p as ee}from"./popupUtils-CrgURn2V.js";import{y as te}from"./LayerView-BcbGCHYn.js";import{i as re}from"./RefreshableLayerView-DrbX9lTS.js";import{r as ie}from"./drapedUtils-DPWMnFq5.js";function se(r,e,t="nearest",i=!1){const s=!(i&&e.pixelType==="u8"),n=s?G.FLOAT:G.UNSIGNED_BYTE,h=e.pixels==null||e.pixels.length===0?null:s?e.getAsRGBAFloat():e.getAsRGBA(),m=r.capabilities.textureFloatLinear,a=new z;return a.width=e.width,a.height=e.height,a.internalFormat=s?$.RGBA32F:M.RGBA,a.samplingMode=!m||t!=="bilinear"&&t!=="cubic"?T.NEAREST:T.LINEAR,a.dataType=n,a.wrapMode=E.CLAMP_TO_EDGE,new S(r,a,h)}function ae(r,e){const{spacing:t,offsets:i,coefficients:s,size:[n,h]}=e,m=t[0]>1,a=new z;a.width=m?4*n:n,a.height=h,a.internalFormat=$.RGBA32F,a.dataType=G.FLOAT,a.samplingMode=T.NEAREST,a.wrapMode=E.CLAMP_TO_EDGE;const l=new Float32Array(m?n*h*16:2*i.length);if(m&&s!=null)for(let u=0,o=0;u<s.length;u++)l[o++]=s[u],u%3==2&&(l[o++]=1);else for(let u=0;u<h;u++)for(let o=0;o<n;o++){const _=4*(u*n+o),x=2*(o*h+u);l[_]=i[x],l[_+1]=i[x+1],l[_+3]=i[x]===-1?0:1}return new S(r,a,l)}function L(r,e){const t=new z;return t.internalFormat=M.RGBA,t.width=e.length/4,t.height=1,t.samplingMode=T.NEAREST,t.wrapMode=E.CLAMP_TO_EDGE,new S(r,t,e)}function ne(r,e,t,i=1,s=!0){return{u_flipY:s,u_applyTransform:!!r,u_opacity:i,u_transformSpacing:r?r.spacing:F,u_transformGridSize:r?r.size:F,u_targetImageSize:e,u_srcImageSize:t}}function le(r,e){return{u_colormapOffset:e||0,u_colormapMaxIndex:r?r.length/4-1:0}}function oe(r){return{u_bandCount:r.bandCount,u_minOutput:r.minOutput,u_maxOutput:r.maxOutput,u_minCutOff:r.minCutOff,u_maxCutOff:r.maxCutOff,u_factor:r.factor,u_useGamma:r.useGamma,u_gamma:r.gamma,u_gammaCorrection:r.gammaCorrection}}function ue(r){return{u_hillshadeType:r.hillshadeType,u_sinZcosAs:r.sinZcosAs,u_sinZsinAs:r.sinZsinAs,u_cosZs:r.cosZs,u_weights:r.weights,u_factor:r.factor,u_minValue:r.minValue,u_maxValue:r.maxValue}}const C={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class he{constructor(e,t,i=null,s=null){this.lij=e,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=t,this.width=i||t.width,this.height=s||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=p(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...C,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||C}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){e!=null&&e.length>0?this._bandIds&&e.every((t,i)=>{var s;return!!((s=this._bandIds)!=null&&s[i])&&t===this._bandIds[i]})||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,this._rasterTexture!=null){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(t==="bilinear"?T.LINEAR:T.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=p(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((this._rasterTexture==null||this._dirty)&&this._updateRasterTexture(e,this.bandIds),this._rasterTexture!=null&&(this._updateColormapTexture(e),this.transformGrid&&this._transformGridTexture==null&&(this._transformGridTexture=ae(e,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:e,transformGrid:t,width:i,height:s,opacity:n}=this,h=ne(t,[i,s],[this.source.width,this.source.height],n),m=le(e.colormap,e.colormapOffset),a=this.symbolizerParameters.type==="stretch"?oe(this.symbolizerParameters):null,l=this.symbolizerParameters.type==="hillshade"?ue(this.symbolizerParameters):null;return new U(h,m,a||l,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return this.interpolation==="bilinear"&&e.colormap!=null&&e.type==="stretch"}get memoryUsage(){if(this._memoryUsed==null){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(t=>t!=null?t.descriptor.width*t.descriptor.height*4:0).reduce((t,i)=>t+i,0)}return this._memoryUsed}release(){return this._rasterTexture=p(this._rasterTexture),this._transformGridTexture=p(this._transformGridTexture),this._colormapTexture=p(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){const i=this.source?this.source.extractBands(t):null;if(!(i!=null&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture=p(this._rasterTexture));const s=t==null&&this.bandIds==null||t!=null&&this.bandIds!=null&&t.join("")===this.bandIds.join("");if(this._rasterTexture!=null&&s)return;this._rasterTexture=p(this._rasterTexture);const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=se(e,i,n,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,i=this.symbolizerParameters.colormap;return i?t?i.length!==t.length||i.some((s,n)=>s!==t[n])?(this._colormapTexture=p(this._colormapTexture),this._colormapTexture=L(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=L(e,i),void(this._colormap=i)):(this._colormapTexture=p(this._colormapTexture),void(this._colormap=null))}}const me=r=>{let e=class extends r{constructor(){super(...arguments),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){var t;return X(this.layer,(t=this.view)==null?void 0:t.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){try{return this.layer.loaded?Z(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(t){try{return!this.layer.loaded||!!v(this.layer.serviceRasterInfo,t)}catch{return!1}}async fetchPopupFeaturesAtLocation(t,i){var _,x;const{layer:s}=this;if(!t)throw new N("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:n}=s,h=ee(s,i);if(!n||h==null)return[];const m=[],{value:a,magdirValue:l,processedValue:u}=await s.identify(t,{timeExtent:this.timeExtent,signal:i==null?void 0:i.signal});let o="";if(a!=null&&a.length){o=s.type==="imagery-tile"&&s.hasStandardTime()&&a[0]!=null?a.map(I=>s.getStandardTimeValue(I)).join(", "):a.join(", ");const y={ObjectId:0};y[w.servicePixelValue]=s.type==="imagery-tile"&&s.raster.datasetFormat==="Function"?u==null?void 0:u.join(", "):o,y[w.rawServicePixelValue]=o;const b=((_=s.raster)==null?void 0:_.rasterInfo)??s.serviceRasterInfo,O=b==null?void 0:b.attributeTable;if(O!=null){const{fields:I,features:D}=O,A=I.find(({name:f})=>f.toLowerCase()==="value"),B=y[w.servicePixelValue],R=A?D.find(f=>String(f.attributes[A.name])===B):null;if(R)for(const f in R.attributes)R.attributes.hasOwnProperty(f)&&(y[Q+f]=R.attributes[f])}const P=b==null?void 0:b.dataType;if(P!=="vector-magdir"&&P!=="vector-uv"||(y[w.magnitude]=l==null?void 0:l[0],y[w.direction]=l==null?void 0:l[1]),s.type==="imagery-tile"){const{multidimensionalDefinition:I}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});K(s.rasterFields,y,I)}const V=new W({geometry:(x=this.fullExtent)==null?void 0:x.clone(),attributes:y,layer:s,sourceLayer:s});m.push(V)}return m}async getSourceScale(){return await this.layer.load(),H(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return v(this.layer.serviceRasterInfo,this.view.spatialReference)}};return c([d()],e.prototype,"fullExtent",null),c([d()],e.prototype,"layer",void 0),c([d({readOnly:!0})],e.prototype,"timeExtent",null),c([d()],e.prototype,"tileInfo",void 0),c([d({readOnly:!0})],e.prototype,"hasTilingEffects",null),c([d()],e.prototype,"datumTransformation",null),e=c([j("esri.views.layers.ImageryTileLayerView")],e),e};let g=class extends me(re(Y(q(te)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this._isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new N("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const r=k(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.basemapTerrain)==null?void 0:t.tilingSchemeLocked}).then(()=>{const e=this.view.basemapTerrain.tilingScheme,t=this.layer.tileInfo;this._isAlignedMapTile=["png","png24","png32","jpg","mixed"].includes(t.format)&&e.compatibleWith(t),this.tileInfo=this._isAlignedMapTile?t:e.toTileInfo(),this._updatingHandles.add(()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this.refresh())});this.addResolvingPromise(r)}destroy(){this.layer.decreaseRasterJobHandlerUsage()}get _blankTile(){const r=document.createElement("canvas"),e=r.getContext("2d"),[t,i]=this.tileInfo.size;return r.width=t,r.height=i,e.clearRect(0,0,t,i),e.getImageData(0,0,t,i)}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){var i,s;const r=this.layer.tileInfo,e=(i=this.tileInfo.lodAt(0))==null?void 0:i.scale,t=(s=this.layer.tileInfo.lodAt(r.lods.length-1))==null?void 0:s.scale;return this.levelRangeFromScaleRange(e,t)}_getFullExtent(){var r;return v(this.layer.serviceRasterInfo,((r=this.view.basemapTerrain)==null?void 0:r.spatialReference)??this.view.spatialReference)}async fetchTile(r,e){const t=this.tileInfo,i=this._canSymbolizeInWebGL(),s={tileInfo:t,requestRawData:i,signal:e.signal,timeExtent:this.timeExtent,requestAsImageElement:this._isAlignedMapTile,noClip:!1},{layer:n}=this,[h,m,a]=r,l=await n.fetchTile(h,m,a,s);if(l instanceof HTMLImageElement)return l;let u=l==null?void 0:l.pixelBlock;if(u==null)return this._blankTile;if(!i&&(u=await n.applyRenderer(l),u==null))return this._blankTile;const o=new he([h,m,a],u,t.size[0],t.size[1]);return i?(o.symbolizerRenderer=n.symbolizer.rendererJSON,o.symbolizerParameters=n.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(h)),o.transformGrid=l.transformGrid,o.bandIds=n.bandIds):(o.isRendereredSource=!0,o.bandIds=null),o.interpolation=n.interpolation,o}_getSymbolizerOptions(r){var t;const e=this.tileInfo.lodAt(r).resolution;return{pixelBlock:null,isGCS:((t=this.view.basemapTerrain)==null?void 0:t.spatialReference)!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(r){this._canSymbolizeInWebGL()&&JSON.stringify(r.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(r.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(r.lij[0])))}createFetchPopupFeaturesQueryGeometry(r,e){return ie(r,e,this.view)}refresh(){this.emit("data-changed")}async doRefresh(){this.suspended||this.emit("data-changed")}_canSymbolizeInWebGL(){var n,h,m;const r=J(),{symbolizer:e}=this.layer,t=(h=(n=e.lookup)==null?void 0:n.colormapLut)==null?void 0:h.indexedColormap,i=!!((m=this.layer.rasterFunction)!=null&&m.hasClipFunction),s=t&&t.length>4*(r.maxTextureSize||4906);return e.canRenderInWebGL&&!s&&!i}};c([d({readOnly:!0})],g.prototype,"_blankTile",null),c([d({readOnly:!0})],g.prototype,"imageFormatIsOpaque",null),c([d({readOnly:!0})],g.prototype,"hasMixedImageFormats",null),c([d({readOnly:!0})],g.prototype,"dataLevelRange",null),g=c([j("esri.views.3d.layers.ImageryTileLayerView3D")],g);const Ie=g;export{Ie as default};
