import{iK as z,ft as E,fw as F,fx as k,fy as S,iL as G,iM as K}from"./index-6KFIOGeK.js";class L{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(t){return this._resourceMap.get(t)??null}async fetchResource(t,u){const n=this._resourceMap.get(t);if(n)return{width:n.width,height:n.height};let o=this._inFlightResourceMap.get(t);return o?o.then(s=>({width:s.width,height:s.height})):(o=z(t,u),this._inFlightResourceMap.set(t,o),o.then(s=>(this._inFlightResourceMap.delete(t),this._resourceMap.set(t,s),{width:s.width,height:s.height}),()=>({width:0,height:0})))}deleteResource(t){this._inFlightResourceMap.delete(t),this._resourceMap.delete(t)}loadFont(t){return E(t)}}const q=96/72;class O{constructor(t){this._spatialReference=t,this._imageDataCanvas=null,this._cimResourceManager=new L}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(t,u,n,o,s,a,c,l,_){if(!t)return null;const{data:d}=t;if(!d||d.type!=="CIMSymbolReference"||!d.symbol)return null;const{symbol:f}=d;a||(a=F(f));const h=await k.resolveSymbolOverrides(d,u,this._spatialReference,s,a,c,l),y=this._cimResourceManager,p=[];S.fetchResources(h,y,p),S.fetchFonts(h,y,p),p.length>0&&await Promise.all(p);const{width:i,height:r}=n,b=P(a,i,r,o),e=S.getEnvelope(h,b,y);if(!e)return null;let g=1,x=0,C=0;switch(f.type){case"CIMPointSymbol":case"CIMTextSymbol":{let w=1;e.width>i&&(w=i/e.width);let M=1;e.height>r&&(M=r/e.height),o==="preview"&&(e.width<i&&(w=i/e.width),e.height<r&&(M=r/e.height)),g=Math.min(w,M),x=e.x+e.width/2,C=e.y+e.height/2}break;case"CIMLineSymbol":{(_||e.height>r)&&(g=r/e.height),C=e.y+e.height/2;const w=e.x*g+i/2,M=(e.x+e.width)*g+i/2,{paths:R}=b;R[0][0][0]-=w/g,R[0][2][0]-=(M-i)/g}break;case"CIMPolygonSymbol":{x=e.x+e.width/2,C=e.y+e.height/2;const w=e.x*g+i/2,M=(e.x+e.width)*g+i/2,R=e.y*g+r/2,I=(e.y+e.height)*g+r/2,{rings:m}=b;w<0&&(m[0][0][0]-=w,m[0][3][0]-=w,m[0][4][0]-=w),R<0&&(m[0][0][1]+=R,m[0][1][1]+=R,m[0][4][1]+=R),M>i&&(m[0][1][0]-=M-i,m[0][2][0]-=M-i),I>r&&(m[0][2][1]+=I-r,m[0][3][1]+=I-r)}}const D={type:"cim",data:{type:"CIMSymbolReference",symbol:h}};return this.rasterize(D,i,r,x,C,g,a,1,b)}rasterize(t,u,n,o,s,a,c,l=0,_=null){const{data:d}=t;if(!d||d.type!=="CIMSymbolReference"||!d.symbol)return null;const{symbol:f}=d,h=this._canvas,y=(window.devicePixelRatio||1)*q;h.width=u*y,h.height=n*y,c||(c=F(f)),_||(_=P(c,u,n,"legend")),h.width+=2*l,h.height+=2*l;const p=h.getContext("2d",{willReadFrequently:!0}),i=K.createIdentity();return i.translate(-o,-s),i.scale(a*y,-a*y),i.translate(u*y/2+l,n*y/2+l),p.clearRect(0,0,h.width,h.height),new G(p,this._cimResourceManager,i,!0).drawSymbol(f,_),p.getImageData(0,0,h.width,h.height)}}function P(v,t,u,n){const s=-t/2+1,a=t/2-1,c=u/2-1,l=-u/2+1;switch(v){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[s,0],[0,0],[a,0]]]};default:return n==="legend"?{rings:[[[s,c],[a,0],[a,l],[s,l],[s,c]]]}:{rings:[[[s,c],[a,c],[a,l],[s,l],[s,c]]]}}}export{O as CIMSymbolRasterizer};
