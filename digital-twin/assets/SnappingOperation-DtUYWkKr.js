import{oh as Te,oi as Ae,oj as He,bo as v,br as Ie,dF as g,dH as te,dq as ie,cX as je,cc as Fe,dI as N,dJ as Z,dK as re,G as Pe,dL as ke,dz as Ve,k9 as Ne,cG as Ze,dS as F,dj as ne,dT as se,dM as ae,cN as k,hN as Ue,cH as C,cK as W,dr as Oe,e9 as Le,cE as qe,l7 as w,ok as ye,ol as X,kc as Be,kl as U,a2 as oe,om as We,cU as Xe,h1 as le,on as Ke,oo as ce,d$ as Qe,cY as Ye,la as ue,op as Je,d0 as $e,oq as we,or as et,X as L,i0 as Se,gY as tt,g0 as De,e as S,y as G,a as it,S as rt}from"./index-CQXxPdCL.js";import{m as nt,f as st,u as at,l as ot}from"./geodesicLengthMeasurementUtils-CLkoLR89.js";import{G as lt,M as ct}from"./ExtendedLineVisualElement-EFBVjMeo.js";import{r as ut}from"./vec4f32-CjrfB-0a.js";import{t as dt}from"./EngineVisualElement-D8MbRS5Q.js";import{x as de}from"./PointVisualElement-6D-0yl0L.js";import{D as ht}from"./RightAngleQuadVisualElement-BXN9ub3U.js";import{o as pt,e as q,h as ft,i as _t,T as he,k as f,E as mt,m as gt,l as vt,q as V}from"./SnappingManagerPool-DkOnch55.js";import{n as xt}from"./PointSnappingHint-CHTKX0yQ.js";import{a as Pt}from"./LineVisualElement-Djf5b5N4.js";import{b as pe,w as Ot}from"./ShadedColorMaterial.glsl-C1Be8O3K.js";import{a as yt}from"./dehydratedFeatureComparison-CQkGq3TN.js";function Kt(i){return nt(i)??Te(i)}function Qt(i,e){return st(i,e)??Ae(i,e)}function Yt(i,e,t){return D[0]=i[0],D[1]=i[1],D[2]=i.length===3?i[2]:0,R[0]=e[0],R[1]=e[1],R[2]=e.length===3?e[2]:0,at(D,R,t)??He(D,R,t)}const D=v(),R=v();let $t=class extends dt{constructor(e){super(e),this._location=v(),this._direction=Ie(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=ut(1,0,1,1),this._renderOccluded=g.OccludeAndTransparent,this.applyProperties(e)}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:wt,recreateGeometry:(t,r)=>this._recreateObject3DGeometry(t,r),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:St,recreateGeometry:t=>this._recreateDrapedGeometry(t)}}get location(){return this._location}set location(e){te(this._location,e)||(ie(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){te(this._direction,e)||(ie(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){je(this._direction,Fe(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){N(e,this._color)||(Z(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){const t=new re(this.materialParameters),r=new Array;return this._createObject3DGeometry(t,e,r),{material:t,geometries:r,forEach:s=>{s(t),r.forEach(s)}}}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,r){const[s,n]=fe(e);t.addGeometry(s),t.addGeometry(n),r.push(s),r.push(n),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new re(this.materialParameters),t=Pe(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()});return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const t=fe(e);return this._updateVerticesDraped(t),t.map(r=>new ke(r))}_updateMaterial(){var t,r;const{materialParameters:e}=this;(t=this.object3dResources.resources)==null||t.material.setParameters(e),(r=this.drapedResources.resources)==null||r.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this.view.state.camera;t.projectToScreen(this.location,M),Ve(m,this.location,this.direction),t.projectToScreen(m,O),Ne(O,Ze(O,O,M)),this._updateVertexAttributesObject3D(t,e,0,M,O,1),this._updateVertexAttributesObject3D(t,e,1,M,O,-1)}_updateVertexAttributesObject3D(e,t,r,s,n,a){var h;const o=t.geometries[r],l=(h=o.getMutableAttribute(F.POSITION))==null?void 0:h.data;if(!l)return;const{start:c,end:u}=_e(n,s,a,this.offset,this.width,this.length);e.unprojectFromScreen(ne(c),m),l[0]=m[0],l[1]=m[1],l[2]=m[2],e.unprojectFromScreen(ne(u),m),l[3]=m[0],l[4]=m[1],l[5]=m[2],t.geometryVertexAttributeUpdated(o,F.POSITION)}_updateVerticesDraped(e){const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:r}}}=this,{location:s,width:n,length:a,offset:o}=this,l=Dt;l.spatialReference=t.renderer.spatialReference,l.x=s[0],l.y=s[1];const c=this.view.overlayPixelSizeInMapUnits(l)*r,u=n*c,h=a*c,d=o*c;this._updateVertexAttributesDraped(e[0],u,h,d,-1),this._updateVertexAttributesDraped(e[1],u,h,d,1)}_updateVertexAttributesDraped(e,t,r,s,n){var h;const a=(h=e.getMutableAttribute(F.POSITION))==null?void 0:h.data;if(!a)return;const{location:o,direction:l}=this,{start:c,end:u}=_e(l,o,n,s,t,r);a[0]=c[0],a[1]=c[1],a[2]=se,a[3]=u[0],a[4]=u[1],a[5]=se,e.invalidateBoundingInfo()}};function fe(i){return[ae(i,[v(),v()]),ae(i,[v(),v()])]}function _e(i,e,t,r,s,n){const a=k(me,Ue(me,i[1]*t,i[0]*-t),r+s/2),o=C(E,C(E,C(E,e,k(E,i,n/2)),a),a);return{start:o,end:C(ge,o,k(ge,i,-n))}}function wt(i){i.geometries.length=0}function St(i){i.pixelRatioHandle.remove(),i.geometries=[]}const m=v(),me=W(),E=W(),ge=W(),M=Oe(),O=Oe(),Dt=Le(0,0,void 0,null);class Rt{draw(e,t){const r=bt(e),s=this.sortUniqueHints(r),n=[];for(const a of s)a instanceof pt&&n.push(this.visualizeIntersectionPoint(a,t)),a instanceof q&&n.push(this.visualizeLine(a,t)),a instanceof ft&&n.push(this.visualizeParallelSign(a,t)),a instanceof _t&&n.push(this.visualizeRightAngleQuad(a,t)),a instanceof xt&&n.push(this.visualizePoint(a,t));return qe(n)}sortUniqueHints(e){return e}}function bt(i){const e=[];for(const t of i){let r=!0;for(const s of e)if(t.equals(s)){r=!1;break}r&&e.push(t)}return e}class ei extends Rt{sortUniqueHints(e){return e.sort((t,r)=>(r instanceof q?r.length:0)-(t instanceof q?t.length:0))}visualizeIntersectionPoint(e,t){const{spatialReference:r,view:s}=t,n=b(t);return w(new de({view:s,primitive:"circle",geometry:he(e.intersectionPoint,r),elevationInfo:e.isDraped?ye:X,size:20,outlineSize:2,color:n.intersectionPointColor,outlineColor:n.intersectionPointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizePoint(e,t){const{view:r,spatialReference:s}=t,n=b(t),a=x(e.point,e.domain,t);return w(new de({view:r,primitive:"circle",geometry:he(a,s),elevationInfo:T(e),size:20,outlineSize:2,color:n.pointColor,outlineColor:n.pointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizeLine(e,t){const{view:r,spatialReference:s}=t,n=b(t),a=x(e.lineStart,e.domain,t),o=x(e.lineEnd,e.domain,t);return w(zt(e.type,a,o,s,T(e),r,n,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:r,spatialReference:s}=t,n=b(t),{isDraped:a}=e,o=T(e),l=x(e.lineStart,e.domain,t),c=x(e.lineEnd,e.domain,t),u=P(l,s,o,r,a),h=P(c,s,o,r,a),d=Be(h,u,h,.5),p=new $t({view:r,attached:!1,offset:f.parallelLineHintOffset,length:f.parallelLineHintLength,width:f.parallelLineHintWidth,color:n.parallelSignColor,location:d,renderOccluded:a?g.OccludeAndTransparent:g.Opaque,isDraped:a,renderGroup:U.SnappingHint,isDecoration:!0});return p.setDirectionFromPoints(u,d),p.attached=!0,w(p)}visualizeRightAngleQuad(e,t){const{view:r,spatialReference:s}=t,n=b(t),a=T(e),{isDraped:o}=e,l=x(e.previousVertex,e.domain,t),c=x(e.centerVertex,e.domain,t),u=x(e.nextVertex,e.domain,t),h=P(l,s,a,r,o),d=P(c,s,a,r,o),p=P(u,s,a,r,o);return w(new ht({view:r,attached:!0,color:o?n.rightAngleColorDraped:n.rightAngleColor,renderOccluded:o?g.OccludeAndTransparent:g.Transparent,outlineRenderOccluded:o?g.OccludeAndTransparent:g.Opaque,outlineColor:n.rightAngleOutlineColor,outlineSize:f.rightAngleHintOutlineSize,size:f.rightAngleHintSize,isDraped:o,geometry:{previous:h,center:d,next:p},renderGroup:U.SnappingHint,isDecoration:!0}))}}function b(i){const{effectiveTheme:e}=i.view,t=oe.toUnitRGBA(e.accentColor),r=[0,0,0,0];return{intersectionPointColor:r,intersectionPointOutlineColor:t,pointColor:r,pointOutlineColor:t,lineColor:t,lineOutlineColor:void 0,parallelSignColor:t,rightAngleColor:t,rightAngleColorDraped:oe.toUnitRGBA(We(e.accentColor,.5)),rightAngleOutlineColor:t}}function x(i,e,{selfSnappingZ:t,view:r,spatialReference:s}){return e&mt.SELF&&gt(i)&&t!=null?vt(i,t,r,s):i}function T(i){return i.isDraped?ye:X}function zt(i,e,t,r,s,n,a,o=!1,l=!0,c=!0){const u=P(e,r,s,n,o),h=P(t,r,s,n,o),d=new lt({view:n,extensionType:ct.FADED,start:u,end:h,isDraped:o,color:a.lineColor,renderOccluded:o?g.OccludeAndTransparent:g.Opaque,renderGroup:U.SnappingHint,isDecoration:!0});switch(i){case V.TARGET:d.width=f.lineHintWidthTarget,d.fadedExtensions={start:0,end:f.lineHintFadedExtensions};break;case V.REFERENCE_EXTENSION:d.width=f.lineHintWidthReference,d.fadedExtensions={start:0,end:0};break;case V.REFERENCE:d.width=f.lineHintWidthReference,d.fadedExtensions={start:l?f.lineHintFadedExtensions:0,end:c?f.lineHintFadedExtensions:0}}return d.attached=!0,d}function P(i,e,t,r,s){const n=v();if(s){const a=r.basemapTerrain.overlayManager.renderer.spatialReference;Xe(i,e,n,a)}else ot(i,e,t,r,n);return n}function Ct(i,e,t,r,s){const n=le(3*i.length),a=le(n.length);i.forEach((c,u)=>{n[3*u]=c[0],n[3*u+1]=c[1],n[3*u+2]=c.length>2?c[2]:0});const o=Ke(n,e,0,a,0,n,0,n.length/3,t,r,s),l=o!=null;return{numVertices:i.length,position:n,mapPositions:a,projectionSuccess:l,sampledElevation:o}}let ti=class extends Pt{constructor(e){super(e),this.view=null,this._renderOccluded=g.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=ce([1,127/255,0,1]),this._size=11,this._outlineColor=ce([0,0,0,.5]),this._outlineSize=1,this._elevationInfo=null,this.applyProperties(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){N(e,this._color)||(Z(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){N(e,this._outlineColor)||(Z(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,screenSizeScale:this.size,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(e==null||e.length===0)return[];const t=.5,r=.5,s=Ct(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Qe.fromElevationInfo(this.elevationInfo)),n=[],a=s.numVertices,o=s.position;for(let l=0;l<a;++l){const c=Ye(Gt,o[3*l],o[3*l+1],o[3*l+2]),u=ve(this._vertexMaterial,t,c),h=ve(this._vertexOutlineMaterial,r,c);n.push({vertexGeometry:u,vertexOutlineGeometry:h})}return n}createGeometries(e){const t=this._createRenderGeometries();for(const{vertexGeometry:r,vertexOutlineGeometry:s}of t)e.addGeometry(r),e.addGeometry(s)}createExternalResources(){this._vertexMaterial=new pe({...this._vertexMaterialParameters,writeDepth:!0,cullFace:ue.Back,screenSizeEnabled:!0}),this._vertexOutlineMaterial=new pe({...this._vertexOutlineMaterialParameters,forceTransparentMode:!0,writeDepth:!0,cullFace:ue.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this._vertexMaterial),e(this._vertexOutlineMaterial)}};const Gt=v();function ve(i,e,t){return Je(i,e,16,16,{offset:t})}class Et{constructor(e){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.selfSnappingZ=null,this.drawConstraints=null,this.editGeometryOperations=e.editGeometryOperations,this.elevationInfo=e.elevationInfo,this.pointer=e.pointer,this.vertexHandle=e.vertexHandle,this.excludeFeature=e.excludeFeature,this.feature=e.feature,this.visualizer=e.visualizer,this.selfSnappingZ=e.selfSnappingZ,this.drawConstraints=e.drawConstraints}get coordinateHelper(){return this.editGeometryOperations.data.coordinateHelper}get spatialReference(){return this.coordinateHelper.spatialReference}}function ri({predicate:i=()=>!0,snappingManager:e,snappingContext:t,updatingHandles:r,useZ:s=!0}){const n=new Ot;if(e==null)return{snappingStep:[xe,n],cancelSnapping:xe};let a,o=null,l=null,c=null;const u=()=>{o=L(o),e.doneSnapping(),l==null||l.frameTask.remove(),l=null,a=Se(a),c=null},h=Mt(e,s,n);let d=null,p=null,K=null;return{snappingStep:[_=>{if(!i(_))return _;const{action:A}=_;if(A==="start"){const{info:z}=_,H=Tt(e.view);if(l=At(t,_,H),l.context.selfSnappingZ=null,!s&&z!=null){const $=It(t.coordinateHelper,z.handle.component);$!=null&&(l.context.selfSnappingZ={value:$,elevationInfo:t.elevationInfo??X})}}if(l!=null){const{context:z,originalScenePos:H,originalPos:$}=l,{mapEnd:Q,mapStart:Y,scenePoints:ze}=_,I=Re($,B(Q,Y)),J=B(Y,$),Ce={..._,action:"update"},Ge=l.context,j=Ht(H,ze),ee=e.update({point:I,scenePoint:j,context:z});if(K=ee,be(Q,ee,J,s),d=I,p=j,A!=="end"){const{frameTask:Ee}=l;o==null&&(o=new AbortController),c=Me=>{r.addPromise(tt(h({frameTask:Ee,event:Ce,context:Ge,point:I,scenePoint:j,delta:J,getLastState:()=>({point:d,scenePoint:p,updatePoint:Me.forceUpdate?null:K})},o.signal)))},c({forceUpdate:!1}),a==null&&(a=Pe(()=>e.options.effectiveEnabled,()=>c==null?void 0:c({forceUpdate:!0})))}}return A==="end"&&u(),_},n],cancelSnapping:_=>(u(),_)}}function Mt(i,e,t){return De(async({frameTask:r,point:s,scenePoint:n,context:a,event:o,delta:l,getLastState:c},u)=>{const h=await r.schedule(()=>i.snap({point:s,scenePoint:n,context:a,signal:u}),u);if(h.valid){let d=await r.schedule(()=>h.apply(),u);const p=c();p.point!=null&&s!==p.point&&(d=i.update({point:p.point,scenePoint:p.scenePoint,context:a})),p.updatePoint!=null&&yt(d,p.updatePoint)||(be(o.mapEnd,d,l,e),t.execute(o))}})}function Tt(i){return i.type==="3d"?i.resourceController.scheduler.registerTask($e.SNAPPING):we}function At(i,e,t){return{context:new Et({editGeometryOperations:i.editGeometryOperations,elevationInfo:i.elevationInfo,pointer:i.pointer,vertexHandle:e.info!=null?e.info.handle:null,excludeFeature:i.excludeFeature,feature:i.feature,visualizer:i.visualizer}),originalPos:e.snapOrigin!=null?i.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,originalScenePos:e.scenePoints!=null?e.scenePoints.sceneStart:null,frameTask:t}}function Re(i,[e,t,r]){const s=et(i);return s.x+=e,s.y+=t,s.hasZ&&(s.z+=r),s}function Ht(i,e){return i==null||e==null?null:Re(i,B(e.sceneEnd,e.sceneStart))}function B(i,e){const t=i.hasZ&&e.hasZ?i.z-e.z:0;return[i.x-e.x,i.y-e.y,t]}function be(i,e,[t,r,s],n){i.x=e.x+t,i.y=e.y+r,n&&i.hasZ&&e.hasZ&&(i.z=e.z+s)}function It(i,e){if(!i.hasZ())return null;const t=e.vertices;let r=null;for(const s of t){const n=i.getZ(s.pos);if(r!=null&&n!=null&&Math.abs(n-r)>1e-6)return null;r==null&&(r=n)}return r}function xe(i){return i}let y=class extends rt{constructor(i){super(i),this.constrainResult=e=>e,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=De(async(e,t,r,s)=>{const n=this._frameTask;if(n==null)return;const a=await n.schedule(()=>t.snap({...e,context:r,signal:s}),s);a.valid&&await n.schedule(()=>{this.stagedPoint=a.apply(),e!==this._snapPoints&&this._snapPoints!=null&&(this.stagedPoint=t.update({...this._snapPoints,context:r}))},s)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(i){this._stagedPoint=this.constrainResult(i)}initialize(){var e,t;const i=this.view.type==="3d"?(t=(e=this.view)==null?void 0:e.resourceController)==null?void 0:t.scheduler:null;this._frameTask=i!=null?i.registerTask($e.SNAPPING):we}destroy(){this._abortController=L(this._abortController),this._frameTask=Se(this._frameTask)}update(i,e,t){this._snapPoints=i;const{point:r,scenePoint:s}=i,n=e.update({point:r,scenePoint:s,context:t});return this.stagedPoint=n,n}async snap(i,e,t){const{point:r,scenePoint:s}=i;return this.stagedPoint=e.update({point:r,scenePoint:s,context:t}),this._snapPoints=i,this._abortController==null&&(this._abortController=new AbortController),this._snap(i,e,t,this._abortController.signal)}async snapAgainNearPreviousMapPoint(i,e){this._snapPoints!=null&&await this.snap(this._snapPoints,i,e)}abort(){this._abortController=L(this._abortController),this._snapPoints=null}};S([G({constructOnly:!0})],y.prototype,"view",void 0),S([G()],y.prototype,"stagedPoint",null),S([G()],y.prototype,"constrainResult",void 0),S([G()],y.prototype,"_stagedPoint",void 0),y=S([it("esri.views.interactive.snapping.SnappingOperation")],y);export{ei as R,Kt as c,ti as d,Et as e,ri as f,Qt as m,y as p,Yt as u};
