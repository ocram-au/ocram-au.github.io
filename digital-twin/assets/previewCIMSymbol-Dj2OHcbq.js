import{gu as F,cY as M,gq as G,an as w,gj as b,gv as O,gw as p}from"./index-h6vmjViw.js";import{CIMSymbolRasterizer as R}from"./CIMSymbolRasterizer-BcoEYlns.js";const y=new R(null),m=w(b.size),S=w(b.maxSize),C=w(b.lineWidth),V=1;async function $(i,e,o){const a=e==null?void 0:e.size;let t=a!=null&&typeof a=="object"&&"width"in a?a.width:a,n=a!=null&&typeof a=="object"&&"height"in a?a.height:a;if(t==null||n==null)if(o==="esriGeometryPolygon")t=m,n=m;else{const l=await q(i,e,o);l&&(t=l.width,n=l.height),o==="esriGeometryPolyline"&&(t=C),t=t!=null&&isFinite(t)?Math.min(t,S):m,n=n!=null&&isFinite(n)?Math.max(Math.min(n,S),V):m}return e.style==="legend"&&o==="esriGeometryPolyline"&&(t=C),{width:t,height:n}}async function q(i,e,o){const{feature:a,fieldMap:t,viewParams:n}=e.cimOptions||e,l=await O.resolveSymbolOverrides(i.data,a,null,t,o,null,n);if(!l)return null;(i=i.clone()).data={type:"CIMSymbolReference",symbol:l},i.data.primitiveOverrides=void 0;const r=[];return p.fetchResources(l,y.resourceManager,r),p.fetchFonts(l,y.resourceManager,r),r.length>0&&await Promise.all(r),p.getEnvelope(l,null,y.resourceManager)}async function U(i,e={}){var v;const{node:o,opacity:a,symbolConfig:t}=e,n=t!=null&&typeof t=="object"&&"isSquareFill"in t&&t.isSquareFill,l=e.cimOptions||e,r=l.geometryType||F((v=i==null?void 0:i.data)==null?void 0:v.symbol),h=await $(i,e,r),{feature:P,fieldMap:I}=l,L=n||r!=="esriGeometryPolygon"?"preview":"legend",f=await y.rasterizeCIMSymbolAsync(i,P,h,L,I,r,null,l.viewParams,l.allowScalingUp);if(!f)return null;const{width:j,height:x}=f,c=document.createElement("canvas");c.width=j,c.height=x,c.getContext("2d").putImageData(f,0,0);const g=M(h.width),d=M(h.height),s=new Image(g,d);s.src=c.toDataURL(),s.ariaLabel=e.ariaLabel??null,s.alt=e.ariaLabel??"",a!=null&&(s.style.opacity=`${a}`);let u=s;if(e.effectView!=null){const z={shape:{type:"image",x:0,y:0,width:g,height:d,src:s.src},fill:null,stroke:null,offset:[0,0]};u=G([[z]],[g,d],{effectView:e.effectView,ariaLabel:e.ariaLabel})}return o&&u&&o.appendChild(u),u}export{U as previewCIMSymbol};
