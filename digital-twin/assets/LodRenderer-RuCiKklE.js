import{sx as ne,sy as re,sz as f,sA as me,sB as he,sC as Ie,bF as o,km as q,sD as O,nq as oe,nw as M,g as ye,cC as Ee,bY as x,kB as Te,aV as Ae,ay as R,kt as ve,jQ as be,sE as Ce,pm as Se,jP as Re,cG as le,sF as j,kn as Le,py as Oe,sG as Me,sw as k,r as I,m as y,a as ce,kS as $,sH as De,kR as xe,hb as B,a_ as we,sI as Fe,mX as Ne,sJ as He,sK as G,fO as de,d5 as ue,q as _e,o as ge,dG as Ve,dH as W,sL as $e,sM as Be,sN as Ge,bd as Ue,sO as ze,mW as w,aJ as Pe,c as F,mV as C,mm as qe,j8 as J,sP as je,bg as N,u as ke,sQ as H,sR as We,aZ as Y,F as K,hp as Je,sS as Ye,bo as L,sT as Ke,sU as Qe,sV as Ze,sW as Xe}from"./index-Bmji7YKu.js";class et{constructor(e,s,i){this._elementSize=s,this._buffer=ne.createVertex(e,re.STATIC_DRAW),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(e,s,i,a=0){const n=new Uint8Array(this.array,e*this.elementSize,(s-e)*this.elementSize);new Uint8Array(i.array,a*this.elementSize).set(n)}transferAll(){this._buffer.setData(this._array)}transferRange(e,s){const i=e*this._elementSize,a=s*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),i,i,a)}resize(e){const s=e*this._elementSize,i=new ArrayBuffer(s);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setSize(s),this._capacity=e}}class tt{constructor(e){this.modelOriginHi=e.getField(o.INSTANCEMODELORIGINHI,q),this.modelOriginLo=e.getField(o.INSTANCEMODELORIGINLO,q),this.model=e.getField(o.INSTANCEMODEL,O),this.modelNormal=e.getField(o.INSTANCEMODELNORMAL,O),this.featureAttribute=e.getField(o.INSTANCEFEATUREATTRIBUTE,oe),this.color=e.getField(o.INSTANCECOLOR,M),this.objectAndLayerIdColor=e.getField(o.INSTANCEOBJECTANDLAYERIDCOLOR,M)}}class st{constructor(e,s){this._rctx=e,this._instanceBufferLayout=s,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,s=this._tailIndex;return e>=s?e-s:e+this._capacity-s}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){var e;return((e=this._buffer)==null?void 0:e.usedMemory)??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){f(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){f(this._updating,"not updating"),this.size<me*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){f(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),f(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){f(this._updating,"not updating"),f(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max(D,Math.floor(this._capacity*he));this._resize(e)}_shrink(){const e=Math.max(D,Math.floor(this._capacity*Ie));this._resize(e)}_resize(e){if(f(this._updating,"not updating"),e===this._capacity)return;const s=new et(this._rctx,this._instanceBufferLayout.stride,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const i=this.size,a=this._compactInstances(s);f(a===i,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=a,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=s,this._view=new tt(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){const s=this._headIndex,i=this._tailIndex;return i<s?(this._buffer.copyRange(i,s,e),s-i):i>s?(this._buffer.copyRange(i,this._capacity,e),s>0&&this._buffer.copyRange(0,s,e,this._capacity-i),s+(this._capacity-i)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,s){e<s?this._buffer.transferRange(e,s):e>s&&(s>0&&this._buffer.transferRange(0,s),this._buffer.transferRange(e,this._capacity))}}const D=64;var l;function it(t){let e=le().mat4f64(o.LOCALTRANSFORM).mat4f64(o.GLOBALTRANSFORM).vec4f64(o.BOUNDINGSPHERE).vec3f64(o.MODELORIGIN).mat3f(o.INSTANCEMODEL).mat3f(o.INSTANCEMODELNORMAL).vec2f(o.MODELSCALEFACTORS);return t.includes(o.FEATUREATTRIBUTE)&&(e=e.vec4f(o.FEATUREATTRIBUTE)),t.includes(o.COLOR)&&(e=e.vec4u8(o.COLOR)),t.includes(o.OBJECTANDLAYERIDCOLOR)&&(e=e.vec4u8(o.OBJECTANDLAYERIDCOLOR)),e=e.u8(o.STATE).u8(o.LODLEVEL),e}(function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",t[t.ACTIVE=18]="ACTIVE"})(l||(l={}));class Q{constructor(e){this.localTransform=e.getField(o.LOCALTRANSFORM,j),this.globalTransform=e.getField(o.GLOBALTRANSFORM,j),this.modelOrigin=e.getField(o.MODELORIGIN,Le),this.model=e.getField(o.INSTANCEMODEL,O),this.modelNormal=e.getField(o.INSTANCEMODELNORMAL,O),this.modelScaleFactors=e.getField(o.MODELSCALEFACTORS,Oe),this.boundingSphere=e.getField(o.BOUNDINGSPHERE,Me),this.featureAttribute=e.getField(o.FEATUREATTRIBUTE,oe),this.color=e.getField(o.COLOR,M),this.objectAndLayerIdColor=e.getField(o.OBJECTANDLAYERIDCOLOR,M),this.state=e.getField(o.STATE,k),this.lodLevel=e.getField(o.LODLEVEL,k)}}let S=class extends ye{constructor(t,e){super(t),this.events=new Ee,this._capacity=0,this._size=0,this._next=0,this._highlightOptionsMap=new Map,this._highlightOptionsMapPrev=new Map,this._layout=it(e),this._capacity=D,this._buffer=this._layout.createBuffer(this._capacity),this._view=new Q(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const t=this._findSlot();return this._view.state.set(t,l.ALLOCATED),this._size++,this.events.emit("instances-changed"),t}removeInstance(t){const e=this._view.state;f(t>=0&&t<this._capacity&&!!(e.get(t)&l.ALLOCATED),"invalid instance handle"),this._getStateFlag(t,l.ACTIVE)?this._setStateFlags(t,l.REMOVE):this.freeInstance(t),this.events.emit("instances-changed")}freeInstance(t){const e=this._view.state;f(t>=0&&t<this._capacity&&!!(e.get(t)&l.ALLOCATED),"invalid instance handle"),e.set(t,0),this._size--}setLocalTransform(t,e,s=!0){this._view.localTransform.setMat(t,e),s&&this.updateModelTransform(t)}getLocalTransform(t,e){this._view.localTransform.getMat(t,e)}setGlobalTransform(t,e,s=!0){this._view.globalTransform.setMat(t,e),s&&this.updateModelTransform(t)}getGlobalTransform(t,e){this._view.globalTransform.getMat(t,e)}updateModelTransform(t){const e=this._view,s=m,i=T;e.localTransform.getMat(t,Z),e.globalTransform.getMat(t,V);const a=Te(V,V,Z);Ae(s,a[12],a[13],a[14]),e.modelOrigin.setVec(t,s),ve(i,a),e.model.setMat(t,i);const n=Ce(m,a);n.sort(),e.modelScaleFactors.set(t,0,n[1]),e.modelScaleFactors.set(t,1,n[2]),Se(i,i),Re(i,i),e.modelNormal.setMat(t,i),this._setStateFlags(t,l.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:t})}getModelTransform(t,e){const s=this._view;s.model.getMat(t,T),s.modelOrigin.getVec(t,m),e[0]=T[0],e[1]=T[1],e[2]=T[2],e[3]=0,e[4]=T[3],e[5]=T[4],e[6]=T[5],e[7]=0,e[8]=T[6],e[9]=T[7],e[10]=T[8],e[11]=0,e[12]=m[0],e[13]=m[1],e[14]=m[2],e[15]=1}applyShaderTransformation(t,e){this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedModelTransform(t,e){return this.getModelTransform(t,e),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e),e}getCombinedLocalTransform(t,e){this._view.localTransform.getMat(t,e),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedMaxScaleFactor(t){let e=this._view.modelScaleFactors.get(t,1);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(m,this,t),e*=Math.max(m[0],m[1],m[2])),e}getCombinedMedianScaleFactor(t){let e=this._view.modelScaleFactors.get(t,0);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(m,this,t),e*=at(m[0],m[1],m[2])),e}getModel(t,e){this._view.model.getMat(t,e)}setFeatureAttribute(t,e){this._view.featureAttribute.setVec(t,e)}getFeatureAttribute(t,e){this._view.featureAttribute.getVec(t,e)}setColor(t,e){this._view.color.setVec(t,e)}setObjectAndLayerIdColor(t,e){this._view.objectAndLayerIdColor.setVec(t,e)}setVisible(t,e){e!==this.getVisible(t)&&(this._setStateFlag(t,l.VISIBLE,e),this.events.emit("instance-visibility-changed",{index:t}))}getVisible(t){return this._getStateFlag(t,l.VISIBLE)}setHighlight(t,e){const{_highlightOptionsMap:s}=this,i=s.get(t);e?e!==i&&(s.set(t,e),this._setStateFlag(t,l.HIGHLIGHT,!0),this.events.emit("instance-highlight-changed")):i&&(s.delete(t),this._setStateFlag(t,l.HIGHLIGHT,!1),this.events.emit("instance-highlight-changed"))}get highlightOptionsMap(){return this._highlightOptionsMap}getHighlightStateFlag(t){return this._getStateFlag(t,l.HIGHLIGHT)}geHighlightOptionsPrev(t){const e=this._highlightOptionsMapPrev.get(t)??null;return this._highlightOptionsMapPrev.delete(t),e}getHighlightName(t){const e=this.highlightOptionsMap.get(t)??null;return e?this._highlightOptionsMapPrev.set(t,e):this._highlightOptionsMapPrev.delete(t),e}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let e=0;for(let s=0;s<this._capacity;++s)this.getState(s)&t&&++e;return e}_setStateFlags(t,e){const s=this._view.state;e=s.get(t)|e,s.set(t,e)}_clearStateFlags(t,e){const s=this._view.state;e=s.get(t)&~e,s.set(t,e)}_setStateFlag(t,e,s){s?this._setStateFlags(t,e):this._clearStateFlags(t,e)}_getStateFlag(t,e){return!!(this._view.state.get(t)&e)}_grow(){this._capacity=Math.max(D,Math.floor(this._capacity*he)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new Q(this._buffer)}_findSlot(){const t=this._view.state;let e=this._next;for(;t.get(e)&l.ALLOCATED;)e=e+1===this._capacity?0:e+1;return this._next=e+1===this._capacity?0:e+1,e}};function at(t,e,s){return Math.max(Math.min(t,e),Math.min(Math.max(t,e),s))}I([y({constructOnly:!0})],S.prototype,"shaderTransformation",void 0),I([y()],S.prototype,"_size",void 0),I([y({readOnly:!0})],S.prototype,"size",null),S=I([ce("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],S);const m=R(),T=be(),Z=x(),V=x();class nt extends ${constructor(e,s){super(i=>De(this._instanceData.view.boundingSphere.getVec(i,this._tmpSphere)),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=s,this._tmpSphere=xe(),this._tmpMat4=x()}addInstance(e){const s=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);B(we(this._tmpSphere),this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*Fe(i),s.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}}class rt{constructor(e,s){this._worldSpaceRadius=e,this._minScreenSpaceRadii=s}selectLevel(e,s,i){const a=i.computeScreenPixelSizeAt(e),n=this._worldSpaceRadius*s/a;let r=0;for(let d=1;d<this._minScreenSpaceRadii.length;++d)n>=this._minScreenSpaceRadii[d]&&(r=d);return r}}let ht=class{constructor(e,s){const i=e.renderContext.rctx,a=s.geometry,n=s.geometry.getRenderGeometry(),r=n.material;this._materials=e.materials,r.setParameters({instancedDoublePrecision:!0}),this.geometry=a,this.material=r,this.glMaterials=new Ne(r,this._materials),this.vertexBufferLayout=n.vertexBufferLayout,this.vbo=ne.createVertex(i,re.STATIC_DRAW,n.buffer),this.vao=new He(i,G,new Map([["geometry",de(n.vertexBufferLayout)]]),new Map([["geometry",this.vbo]])),this.vertexCount=n.elementCount}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,s,i,a,n,r,d,h){return this.geometry.intersect(e,s,i,a,n,r,d,h)}};class U{static async create(e,s,i){const a=await Promise.allSettled(s.components.map(r=>e.controller.schedule(()=>new ht(e,r),i))),n=a.map(r=>r.status==="fulfilled"?r.value:null).filter(ue);if(_e(i)||n.length!==a.length){n.forEach(r=>r.destroy()),ge(i);for(const r of a)if(r.status==="rejected")throw r.reason}return new U(s.minScreenSpaceRadius,n)}constructor(e,s){this.minScreenSpaceRadius=e,this.components=s}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,s,i,a,n,r,d){this.components.forEach(h=>h.intersect(e,s,i,a,n,r,this.boundingSphere,d))}get boundingBox(){if(this._boundingBox==null){const e=Ve();this.components.forEach(s=>{s.boundingInfo!=null&&(W(e,s.boundingInfo.bbMin),W(e,s.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){const e=this.boundingBox,s=R();$e(e,s),this._boundingSphere={center:s,radius:.5*Be(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,s)=>e+s.triangleCount,0)}}const ot=t=>{const e=t.baseBoundingSphere.radius,s=t.levels.map(i=>i.minScreenSpaceRadius);return new rt(e,s)};let A=class extends Ge{constructor(t,e){super(t),this.type=Ue.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new ze,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[w.OPAQUE_MATERIAL,s=>this._produces(s)],[w.TRANSPARENT_MATERIAL,s=>!!this._hasTransparentLevels()&&this._produces(s)]]),this._instanceData=new S({shaderTransformation:t.shaderTransformation},t.optionalFields),this.addHandles(e.registerTask(Pe.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=ct(this.optionalFields),this._glInstanceBufferLayout=de(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:t})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)}),this._instanceData.events.on("instance-visibility-changed",({index:t})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){const t=[this._defaultRenderInstanceData];for(const e of this._highlightRenderInstanceDataMap)t.push(e[1]);return t}get _allRenderInstanceDataExceptHighlightShadow(){const t=[this._defaultRenderInstanceData];for(const e of this._highlightRenderInstanceDataMap)e[0]!==F&&t.push(e[1]);return t}hasHighlightOptions(t){return this._highlightRenderInstanceDataMap.has(t)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get hasEmissions(){return this._levels.some(t=>t.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((t,e)=>e.reduce((s,i)=>s+i.usedMemory,t),this._levels.reduce((t,e)=>t+e.components.reduce((s,i)=>s+i.usedMemory,0),0))}get renderStats(){const t=this._instanceData.size,e=[];return this._levels.forEach((s,i)=>{const a=this._allRenderInstanceData[0][i].size+this._allRenderInstanceData[1][i].size,n=s.triangleCount;e.push({renderedInstances:a,renderedTriangles:a*n,trianglesPerInstance:n})}),{totalInstances:t,renderedInstances:e.reduce((s,i)=>s+i.renderedInstances,0),renderedTriangles:e.reduce((s,i)=>s+i.renderedTriangles,0),levels:e}}_createRenderInstanceDataArray(t=[]){const{rctx:e}=this._context.renderContext;return this.symbol.levels.map(s=>{t.push(new st(e,this._instanceBufferLayout))}),t}async initializeRenderContext(t,e){this._context=t,this._createRenderInstanceDataArray(this._defaultRenderInstanceData);const s=await Promise.allSettled(this.symbol.levels.map(a=>U.create(t,a,e))),i=s.map(a=>a.status==="fulfilled"?a.value:null).filter(ue);if(_e(e)||i.length!==s.length){i.forEach(a=>a.destroy()),ge(e);for(const a of s)if(a.status==="rejected")throw a.reason}this._levels=i,this._levelSelector=ot(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(t=>t.destroy()),this._defaultRenderInstanceData.forEach(t=>t.destroy()),this._highlightRenderInstanceDataMap.forEach(t=>t.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(t=>t.components.some(e=>{const s=e.material.produces.get(w.TRANSPARENT_MATERIAL);return s==null?void 0:s(C.Color)}))}hasHighlights(){return qe(this._highlightRenderInstanceDataMap,t=>t.some(e=>e.size>0))}_produces(t){return(t!==C.Highlight||this.hasHighlights())&&(t!==C.ShadowHighlight||this.hasHighlightOptions(F))}prepareRender(t){if(!J.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const e=t.bind.contentCamera.equals(this._camera);this._camera.copyFrom(t.bind.contentCamera),e||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(je),this._needFullCycle=!1)}}acquireTechniques(t){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(t.output))return null;const e=this._getInstanceDatas(t);if(!e)return null;const s=new Array,i=this.levels;return e.forEach(a=>i.forEach(({components:n},r)=>n.forEach(d=>s.push(this._beginComponent(t,a[r],d))))),s}render(t,e){const s=this._getInstanceDatas(t);if(!s||e==null)return;let i=0;t.rctx.bindVAO();const a=this.levels;s.forEach(n=>a.forEach(({components:r},d)=>r.forEach(h=>this._renderComponent(t,e[i++],n[d],h,d))))}_getInstanceDatas(t){var d;const{output:e,bind:s}=t,i=e===C.Highlight,a=e===C.ShadowHighlight,n=!i&&!a,r=e!==C.ShadowExcludeHighlight;if(n)return r?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;if(r){if(i){const _=(d=s.highlight)==null?void 0:d.name;if(!_)return null;const u=this._highlightRenderInstanceDataMap.get(_);return u?[u]:null}const h=this._highlightRenderInstanceDataMap.get(F);return a?h?[h]:null:Array.from(this._highlightRenderInstanceDataMap.values())}return null}intersect(t,e,s,i){if(!this.baseMaterial.visible||this._octree==null)return;const a=R();N(a,i,s);const n=r=>{this._instanceData.getCombinedModelTransform(r,te),t.transform.set(te),B(se,s,t.transform.inverse),B(ie,i,t.transform.inverse);const d=this._instanceData.getState(r),h=this._instanceData.getLodLevel(r),_=this._levels.length;f(!!(d&l.ACTIVE),"invalid instance state"),f(h>=0&&h<_,"invaid lod level"),this._levels[h].intersect(t,e,se,ie,r,this.metadata,_)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(n):this._octree.forEachAlongRay(s,a,n)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){var t;if(this._octreeCached==null){const e=this._instanceData,s=(t=e.view)==null?void 0:t.state;if(!s)return null;this._octreeCached=new nt(e,this.baseBoundingSphere);for(let i=0;i<e.capacity;++i)s.get(i)&l.ACTIVE&&this._octreeCached.addInstance(i)}return this._octreeCached}_invalidateOctree(){this._octreeCached=ke(this._octreeCached)}queryDepthRange(t){if(this._octree==null)return new H;const e=t.viewForward,s=this._octree.findClosest(e,$.DepthOrder.FRONT_TO_BACK,t.frustum),i=this._octree.findClosest(e,$.DepthOrder.BACK_TO_FRONT,t.frustum);if(s==null||i==null)return new H;const a=t.eye,n=this._instanceData.view;n.boundingSphere.getVec(s,b),N(b,b,a);const r=Y(b,e)-b[3];n.boundingSphere.getVec(i,b),N(b,b,a);const d=Y(b,e)+b[3];return new H(r,d)}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,t&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(t=>t.forEach(e=>e.startUpdateCycle()))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(t){const{_enableLevelSelection:e,_camera:s,_levelSelector:i}=this;this._allRenderInstanceData.forEach(u=>u.forEach(c=>c.beginUpdate()));const a=this._instanceData,n=a.view;let r=a.size;const d=a.capacity;let h=this._instanceIndex;const _=Math.ceil(d/500);for(let u=0;u<r&&!t.done;++u){h===this._cycleStartIndex&&this._startUpdateCycle();const c=n.state.get(h);let v=0;if(!(c&l.ALLOCATED)){h=h+1===d?0:h+1,r++;continue}const p=n.lodLevel.get(h);if(c&l.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[p].freeTail(),c&l.HIGHLIGHT_ACTIVE){const g=a.geHighlightOptionsPrev(h);if(g){const E=this._highlightRenderInstanceDataMap.get(g);if(!E)throw new K("Internal error in lodRenderer");E[p].freeTail()}}if(c&l.REMOVE)a.freeInstance(h);else if(c&l.VISIBLE){let g=0;if(e&&(n.modelOrigin.getVec(h,ee),g=i.selectLevel(ee,a.getCombinedMedianScaleFactor(h),s)),v=c&~(l.ACTIVE|l.TRANSFORM_CHANGED),g>=0)if(c&l.HIGHLIGHT){const E=a.getHighlightName(h);if(E){const fe=()=>{const P=this._createRenderInstanceDataArray();return P.forEach(pe=>pe.beginUpdate()),P},z=Je(this._highlightRenderInstanceDataMap,E,fe);if(g>=z.length)throw new K(`LodRenderer internal error - missing lodLevel ${g}`);X(z[g],n,h)}v|=l.HIGHLIGHT_ACTIVE}else X(this._defaultRenderInstanceData[g],n,h),v|=l.DEFAULT_ACTIVE;n.state.set(h,v),n.lodLevel.set(h,g)}else v=c&~(l.ACTIVE|l.TRANSFORM_CHANGED),n.state.set(h,v);if(this._octreeCached!=null){const g=!!(c&l.ACTIVE),E=!!(v&l.ACTIVE);!g&&E?this._octreeCached.addInstance(h):g&&!E?this._octreeCached.removeInstance(h):g&&E&&c&l.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(h),this._octreeCached.addInstance(h))}h=h+1===d?0:h+1,h%_==0&&t.madeProgress()}this._instanceIndex=h,this._allRenderInstanceData.forEach(u=>u.forEach(c=>c.endUpdate())),this._context.requestRender()}_beginComponent(t,e,s){if(e.size===0)return null;const i=s.glMaterials.load(t.rctx,t.bind.slot,t.output);return i==null?void 0:i.beginSlot(t.bind)}_renderComponent(t,e,s,i,a){if(!e)return;const{bind:n,rctx:r}=t;r.runAppleAmdDriverHelper();const d=r.bindTechnique(e,n,i.material.parameters,dt);r.bindVAO(i.vao),e.ensureAttributeLocations(i.vao),J.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.output===C.Color&&(d.setUniform4fv("externalColor",ae[Math.min(a,ae.length-1)]),d.setUniform1i("colorMixMode",Ke.replace));const h=s.capacity,_=s.headIndex,u=s.tailIndex,c=s.firstIndex,v=this._glInstanceBufferLayout,p=(g,E)=>{Qe(r,G,s.buffer,v,g),r.drawArraysInstanced(e.primitiveType,0,i.vertexCount,E-g),Ze(r,G,s.buffer,v)};i.material.parameters.transparent&&c!=null?_>u?(f(c>=u&&c<=_,"invalid firstIndex"),p(c,_),p(u,c)):_<u&&(c<=_?(f(c>=0&&c<=_,"invalid firstIndex"),p(c,_),p(u,h),p(0,c)):(f(c>=u&&c<=h,"invalid firstIndex"),p(c,h),p(0,_),p(u,c))):_>u?p(u,_):_<u&&(p(0,_),p(u,h)),r.bindVAO(null)}};function X(t,e,s){const i=t.allocateHead();lt(e,s,t.view,i)}function lt(t,e,s,i){Xe(t.modelOrigin,e,s.modelOriginHi,s.modelOriginLo,i),s.model.copyFrom(i,t.model,e),s.modelNormal.copyFrom(i,t.modelNormal,e),t.color&&s.color&&s.color.copyFrom(i,t.color,e),t.objectAndLayerIdColor&&s.objectAndLayerIdColor&&s.objectAndLayerIdColor.copyFrom(i,t.objectAndLayerIdColor,e),t.featureAttribute&&s.featureAttribute&&s.featureAttribute.copyFrom(i,t.featureAttribute,e)}function ct(t){let e=le().vec3f(o.INSTANCEMODELORIGINHI).vec3f(o.INSTANCEMODELORIGINLO).mat3f(o.INSTANCEMODEL).mat3f(o.INSTANCEMODELNORMAL);return t!=null&&t.includes("featureAttribute")&&(e=e.vec4f(o.INSTANCEFEATUREATTRIBUTE)),t!=null&&t.includes("color")&&(e=e.vec4u8(o.INSTANCECOLOR)),t!=null&&t.includes("objectAndLayerIdColor")&&(e=e.vec4u8(o.INSTANCEOBJECTANDLAYERIDCOLOR)),e}I([y({constructOnly:!0})],A.prototype,"symbol",void 0),I([y({constructOnly:!0})],A.prototype,"optionalFields",void 0),I([y({constructOnly:!0})],A.prototype,"metadata",void 0),I([y({constructOnly:!0})],A.prototype,"shaderTransformation",void 0),I([y()],A.prototype,"_instanceData",void 0),I([y()],A.prototype,"_cycleStartIndex",void 0),I([y({readOnly:!0})],A.prototype,"_enableLevelSelection",null),I([y()],A.prototype,"_updateCyclesWithStaticCamera",void 0),I([y({readOnly:!0})],A.prototype,"running",null),A=I([ce("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],A);const ee=R(),b=We(),te=x(),se=R(),ie=R(),ae=[L(1,0,1,1),L(0,0,1,1),L(0,1,0,1),L(1,1,0,1),L(1,0,0,1)],dt=new Ye;export{A as k};
