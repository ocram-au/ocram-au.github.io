import{r,m as s,a as $,W as v,aM as x,iy as H,a8 as I,aL as O,k as _,il as g}from"./index-QRcEofMq.js";import{l as C}from"./LayerView3D-CcNCQx3h.js";import{y as N}from"./LayerView-BHwB5Nkk.js";const u=Symbol(),T=F=>{let i=class extends F{constructor(){super(...arguments),this.layerViews=new v,this._debouncedUpdate=x(async()=>{const{layer:e,parent:t}=this,n=t==null?void 0:t.footprintLayerView;let d=[];const o=this._createQuery();if(o&&n){const{features:h}=await n.queryFeatures(o);this.suspended||(d=h.map(m=>e.acquireLayer(m)))}this.removeHandles(u),this.addHandles(d,u)})}get creatingLayerViews(){var e;return((e=this.view)==null?void 0:e.layerViewManager.isCreatingLayerViewsForLayer(this.layer))??!1}isUpdating(){return this.creatingLayerViews||this.layer.updating||this.layerViews.some(e=>e.updating)}enableLayerUpdates(){return H([this._updatingHandles.addWhen(()=>{var e,t;return((t=(e=this.parent)==null?void 0:e.footprintLayerView)==null?void 0:t.dataUpdating)===!1},()=>this.updateLayers()),this._updatingHandles.add(()=>{var e,t,n,d,o;return[this.layer.maximumVisibleSublayers,(e=this.layer.parent)==null?void 0:e.orderBy,(n=(t=this.parent)==null?void 0:t.footprintLayerView)==null?void 0:n.filter,(o=(d=this.parent)==null?void 0:d.footprintLayerView)==null?void 0:o.timeExtent,this.suspended]},()=>this.updateLayers()),I(()=>this.removeHandles(u))])}updateLayers(){this.suspended?this.removeHandles(u):this._updatingHandles.addPromise(O(this._debouncedUpdate()).catch(e=>{_.getLogger(this).error(e)}))}_createQuery(){var f,V;const e=(f=this.parent)==null?void 0:f.footprintLayerView,t=(V=this.layer)==null?void 0:V.parent;if(!e||!t||t.destroyed)return null;const{layer:{maximumVisibleSublayers:n},view:{scale:d}}=this;if(!n)return null;const{itemTypeField:o,itemSourceField:h,itemNameField:m,minScaleField:c,maxScaleField:L,objectIdField:b,orderBy:w}=t,S=g(`${c} IS NULL OR ${d} <= ${c} OR ${c} = 0`,`${L} IS NULL OR ${d} >= ${L}`),l=w==null?void 0:w.find(y=>y.field&&!y.valueExpression),a=e.createQuery();if(a.returnGeometry=!1,a.num=n,a.outFields=[b,h,m],a.where=g(a.where,S),this.unsupportedItemTypes!=null){const y=`${o} NOT IN (${this.unsupportedItemTypes.map(U=>`'${U}'`)})`;a.where=g(a.where,y)}return l!=null&&l.field&&(a.orderByFields=[`${l.field} ${l.order==="descending"?"DESC":"ASC"}`],a.outFields.push(l.field)),a}};return r([s({readOnly:!0})],i.prototype,"creatingLayerViews",null),r([s()],i.prototype,"layer",void 0),r([s()],i.prototype,"layerViews",void 0),r([s({readOnly:!0})],i.prototype,"unsupportedItemTypes",void 0),r([s()],i.prototype,"parent",void 0),r([s({readOnly:!0})],i.prototype,"isUpdating",null),i=r([$("esri.views.layers.CatalogDynamicGroupLayerView")],i),i};let p=class extends T(C(N)){constructor(){super(...arguments),this.type="catalog-dynamic-group-3d",this.layerViews=new v}initialize(){this.addHandles([this.enableLayerUpdates()])}};r([s()],p.prototype,"layerViews",void 0),r([s()],p.prototype,"parent",void 0),r([s()],p.prototype,"view",void 0),p=r([$("esri.views.3d.layers.CatalogDynamicGroupLayerView3D")],p);const G=p;export{G as default};
