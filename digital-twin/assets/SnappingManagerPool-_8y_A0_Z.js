const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/FeatureServiceSnappingSource-CKAqxbnw.js","assets/index-ByUZEoNK.js","assets/index-Bkubs9t2.css","assets/memoize-DsJmrG76.js","assets/queryEngineUtils-Boe3aeFb.js","assets/VertexSnappingCandidate-B7kUHuSe.js","assets/PointSnappingHint-eBgpKkM4.js","assets/TileTreeDebugger-BfPaJMvY.js","assets/WorkerHandle-Cc_huYGz.js","assets/geodesicLengthMeasurementUtils-Dg7VdlAx.js","assets/geometryEngine-BwCZC66d.js","assets/geometryEngineBase-DBBdXduU.js","assets/hydrated-TIhYPMd9.js","assets/geometry2dUtils-CuHR2TdW.js","assets/floorFilterUtils-DZ5C6FQv.js","assets/keybindings-DOCDQMtP.js","assets/FeatureCollectionSnappingSource-CA3A7Kv3.js","assets/symbologySnappingCandidates-BBFQtIgt.js","assets/GraphicsSnappingSource-BcWgf5q6.js","assets/normalizeUtilsSync-CE5Hz5Uf.js","assets/FeatureStore-DgLXpSmf.js","assets/BoundsStore-B67LdGZa.js","assets/PooledRBush-RdN4kavU.js","assets/quickselect-CGmvo3iT.js","assets/QueryEngine-Dl1_y_2f.js","assets/WhereClause-OmQX3UeL.js","assets/TimeOnly-BU3POh7K.js","assets/json-Wa8cmqdu.js","assets/QueryEngineCapabilities-CTDe3LlQ.js","assets/utils-NYA6gdH6.js","assets/utils-ClQCN4zk.js","assets/ClassBreaksDefinition-8z1xRXdS.js","assets/optimizedFeatureQueryEngineAdapter-W5ik5KXQ.js","assets/SceneLayerSnappingSource-B_AFDVkr.js","assets/EdgeWorkerHandle-PEDfJ-DI.js","assets/workerHelper-CD8AbQx7.js"])))=>i.map(i=>d[i]);
import{e as h,y as f,a as ge,S as Te,V as Se,L as Ue,aU as vn,C as Sn,fF as li,a1 as de,P as ci,q1 as ui,mn as di,bn as We,oU as $,uC as _n,ec as it,uD as hi,dw as O,bk as y,cJ as oe,cP as Fe,cO as Ve,cM as Ae,cN as G,ci as pi,uE as $e,tN as fi,c$ as Z,gv as C,dA as M,ic as T,uF as gi,bp as fe,oC as He,cL as yi,dy as st,uG as mt,uH as En,dt as rt,tO as mn,e6 as wn,c8 as Ie,cZ as Be,uI as wt,oB as xn,i3 as $n,mv as vi,nx as Si,qM as Ln,dx as bn,ae as Tn,dK as w,bz as _i,pN as Ye,ig as Ei,rM as mi,uJ as wi,c_ as xi,pL as $i,uK as Li,r5 as bi,uL as Ti,uM as _e,uN as Pi,id as Ri,qV as Ni,uO as Mi,uP as Ai,hG as Fi,uQ as Qt,mj as Ci,a8 as Vi,cs as Nt,uR as Ii,nZ as Oi,a9 as Xe,cI as Di,ox as ze,ov as qi,d4 as je,tg as ht,h as zi,uS as ki,lk as Hi,a2 as xt,gY as ji,q as pt,d8 as Pn,kC as Gi,_ as ke,tD as Mt,ch as Zi,cX as Je,c5 as At,uT as Ui,uU as Wi,uV as Ee,uW as Ft,ik as Bi,qK as Yi,uX as Xi,uY as Rn,uZ as Nn,dC as Ji,kq as Ki,aM as Qi,d7 as en,fb as es,B as ts,a6 as ns,u_ as is}from"./index-ByUZEoNK.js";import{b as Ke,j as Ct,z as Vt,d as N,A as $t,u as Mn}from"./geodesicLengthMeasurementUtils-Dg7VdlAx.js";import{j as P,d as ss,I as Lt,N as rs}from"./geometry2dUtils-CuHR2TdW.js";import{o as as}from"./floorFilterUtils-DZ5C6FQv.js";import{c as tn}from"./keybindings-DOCDQMtP.js";function os(n){return n!=null&&typeof n=="object"&&"declaredClass"in n&&n.declaredClass==="esri.WebMap"}let le=class extends Te{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1,this.sublayerSources=new Se}};h([f({constructOnly:!0})],le.prototype,"layer",void 0),h([f()],le.prototype,"enabled",void 0),h([f()],le.prototype,"updating",void 0),h([f()],le.prototype,"availability",void 0),h([f()],le.prototype,"sublayerSources",void 0),le=h([ge("esri.views.interactive.snapping.FeatureSnappingLayerSource")],le);const It=le;let H=class extends vn{constructor(){super(...arguments),this.enabled=!0}};h([f({type:Boolean})],H.prototype,"enabled",void 0),H=h([ge("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],H);let m=class extends vn{constructor(e){super(e),this.lineSnapper=new H,this.parallelLineSnapper=new H,this.rightAngleSnapper=new H,this.rightAngleTriangleSnapper=new H,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.verticalLineThresholdMeters=.3,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new Ue([255,127,0]),this.orangeTransparent=new Ue([255,127,0,.5]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5,this.satisfiesConstraintScreenThreshold=1}};h([f({type:H,constructOnly:!0,nonNullable:!0,json:{write:!0}})],m.prototype,"lineSnapper",void 0),h([f({type:H,constructOnly:!0,nonNullable:!0,json:{write:!0}})],m.prototype,"parallelLineSnapper",void 0),h([f({type:H,constructOnly:!0,nonNullable:!0,json:{write:!0}})],m.prototype,"rightAngleSnapper",void 0),h([f({type:H,constructOnly:!0,nonNullable:!0,json:{write:!0}})],m.prototype,"rightAngleTriangleSnapper",void 0),h([f({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],m.prototype,"shortLineThreshold",void 0),h([f({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],m.prototype,"distance",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],m.prototype,"pointThreshold",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],m.prototype,"intersectionParallelLineThreshold",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],m.prototype,"parallelLineThreshold",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],m.prototype,"verticalLineThresholdMeters",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],m.prototype,"touchSensitivityMultiplier",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],m.prototype,"pointOnLineThreshold",void 0),h([f({type:Ue,nonNullable:!0})],m.prototype,"orange",void 0),h([f({type:Ue,nonNullable:!0})],m.prototype,"orangeTransparent",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],m.prototype,"lineHintWidthReference",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],m.prototype,"lineHintWidthTarget",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],m.prototype,"lineHintFadedExtensions",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],m.prototype,"parallelLineHintWidth",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],m.prototype,"parallelLineHintLength",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],m.prototype,"parallelLineHintOffset",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],m.prototype,"rightAngleHintSize",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],m.prototype,"rightAngleHintOutlineSize",void 0),h([f({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],m.prototype,"satisfiesConstraintScreenThreshold",void 0),m=h([ge("esri.views.interactive.snapping.Settings.Defaults")],m);const K=new m;let R=class extends Te{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.forceDisabled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.attributeRulesEnabled=!1,this.featureSources=new Se,this.distance=K.distance,this.touchSensitivityMultiplier=K.touchSensitivityMultiplier}get effectiveEnabled(){return!this.forceDisabled&&(this.enabledToggled?!this.enabled:this.enabled)}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}get _effectiveFeatureSources(){var l;const e=this.featureSources;e.some(nn)&&Sn.getLogger(this).warnOnce("Do not configure SubtypeGroupLayer sources in SnappingOptions.featureSources directly. Create a FeatureSnappingLayerSource for each SubtypeSublayer.");const t=e.filter(cs),i=((l=this._get("_effectiveFeatureSources"))==null?void 0:l.filter(nn))??new Se;for(const c of t){const u=i.find(d=>d.layer===c.layer.parent);if(u)u.sublayerSources.includes(c)||u.sublayerSources.add(c);else if(c.layer.parent){const d=new It({layer:c.layer.parent});d.sublayerSources.add(c),i.add(d)}}for(const c of i){const u=c.sublayerSources.filter(d=>!t.includes(d));c.sublayerSources.removeMany(u)}i.removeMany(i.filter(c=>c.sublayerSources.length===0));const s=e.filter(ls),r=this._get("_effectiveFeatureSources")??new Se,{added:o,removed:a}=li(r.toArray(),[...s,...i]);return r.removeMany(a),r.addMany(o),r}};h([f()],R.prototype,"enabled",void 0),h([f()],R.prototype,"enabledToggled",void 0),h([f()],R.prototype,"forceDisabled",void 0),h([f()],R.prototype,"selfEnabled",void 0),h([f()],R.prototype,"featureEnabled",void 0),h([f()],R.prototype,"attributeRulesEnabled",void 0),h([f({type:Se.ofType(It)})],R.prototype,"featureSources",void 0),h([f()],R.prototype,"distance",void 0),h([f()],R.prototype,"touchSensitivityMultiplier",void 0),h([f({readOnly:!0})],R.prototype,"effectiveEnabled",null),h([f({readOnly:!0})],R.prototype,"effectiveSelfEnabled",null),h([f({readOnly:!0})],R.prototype,"effectiveFeatureEnabled",null),h([f({readOnly:!0})],R.prototype,"_effectiveFeatureSources",null),R=h([ge("esri.views.interactive.snapping.SnappingOptions")],R);const An=R;function nn(n){return n.layer.type==="subtype-group"}function ls(n){return n.layer.type!=="subtype-group"}function cs(n){return n.layer.type==="subtype-sublayer"}function us(n,e){const t=new An({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:e==null?void 0:e.distance,touchSensitivityMultiplier:(e==null?void 0:e.touchSensitivityMultiplier)??K.touchSensitivityMultiplier});return{...de(()=>{var i,s;return((s=(i=n.map)==null?void 0:i.allLayers)==null?void 0:s.toArray())??[]},i=>{t.featureSources=new Se(i.map(s=>new It({layer:s})))},ci),options:t}}var me;function Fn(n,e,t){return I(n,e,t)}function I(n=0,e=0,t=0){return We(n,e,t)}function Fr(n){return n}function U(n,e,t){return We(n,e,t)}function Le(n){const[e,t,i]=n;return n.length>3?[e,t,i,n[3]]:[e,t,i]}function he(n){return n[3]=((n.length>3?n[3]:void 0)??me.NONE)|me.TARGET,n}function Cr(n){return!!(((n.length>3?n[3]:void 0)??me.NONE)&me.TARGET)}function L(n,e,{coordinateHelper:t,elevationInfo:i},s){return n?Me(t.vectorToDehydratedPoint(n,ds),e,i,s):null}function Me(n,e,t,i=I()){return i[0]=n.x,i[1]=n.y,i[2]=n.z??0,e==null||(e.type==="2d"?i[2]=0:i[2]=ui(e,n,t,$)??0),i}function Vr(n,e,t){return t?(_n(t,n[0],n[1],n[2],e),t):it(n[0],n[1],n[2],e)}function sn(n,e,{z:t,m:i},s,r){const{spatialReference:o,elevationInfo:a}=s;let l;t==null&&i==null?l=void 0:e==null||e.type==="2d"?l=t??void 0:l=di(e,n,o,$,a)??0;const[c,u]=n;return r?_n(r,c,u,l,o):r=it(c,u,l,o),i!=null&&(r.m=i,r.hasM=!0),r}function Ir(n,e,t,i,s=I()){const[r,o]=n;return s[0]=r,s[1]=o,n.length>3&&(s[3]=n[3]??me.NONE),(t==null?void 0:t.type)!=="3d"?(s[2]=e.value,s):(s[2]=hi(t,r,o,e.value,i,e.elevationInfo,$)??0,s)}(function(n){n[n.NONE=0]="NONE",n[n.TARGET=1]="TARGET"})(me||(me={}));const ds=it(0,0,0,null);function Ot({start:n,end:e,type:t},i,s){const r=[],o=oe(Oe,e,n),a=oe(at,n,i),l=Fe(o),c=2*Ve(o,a),u=c*c-4*l*(Fe(a)-s*s);if(u===0){const d=-c/(2*l);(t===V.PLANE||d>=0)&&r.push(Ae(G(),n,o,d))}else if(u>0){const d=Math.sqrt(u),p=(-c+d)/(2*l);(t===V.PLANE||p>=0)&&r.push(Ae(G(),n,o,p));const g=(-c-d)/(2*l);(t===V.PLANE||g>=0)&&r.push(Ae(G(),n,o,g))}return r}function Cn(n,e){const t=n.start,i=n.end,s=oe(Oe,i,t),r=Z(lt,-s[1],s[0],0),o=e.start,a=e.end,l=C(zt,a,o),c=M(l,r),u=Z(kn,t[0],t[1],0),d=C(Hn,u,o),p=M(d,r),g=$e();if(Math.abs(c)<g)return[];const v=T(jn,o,l,p/c);if(e.type===P.RAY){const S=C(bt,v,o);if(M(S,l)<-g)return[]}if(n.type===V.HALF_PLANE){const S=gi(at,v,t);if(Ve(S,s)<-g)return[]}return[fe(v)]}function hs(n,e){return fs(Qe(kt,e[2],n),e)}function Vn(n,e){return qn(Qe(kt,0,n),Qe(Ss,0,e)).map(([i,s])=>He(i,s))}function In(n,e,t){return Dt(n,Qe(kt,n[2],e),t)}function On(n,e,t,i=y()){const s=oe(Oe,n,e),r=yi(s);return Ae(i,e,s,r===0?1:t/r),i[2]=n[2],i}function Dt(n,{start:e,end:t,type:i},s=y()){const r=C(ot,n,e),o=C(lt,t,e),a=M(r,o)/M(o,o);return T(s,e,o,i===P.RAY?Math.max(a,0):a)}const ps=(()=>{const n=y(),e=y(),t=y();return({start:i,end:s},{center:r,radius:o,normal:a,slicePlane:l})=>{const c=st(r,a,vs);if(E(mt(c,i),0)&&E(mt(c,s),0)){En(a,n,e);const d=(v,S)=>(Ie(t,S,r),$n(v,M(t,n),M(t,e)),v),p=ss({start:d(Oe,i),end:d(at,s),type:P.LINE},vi,o),g=[];for(const[v,S]of p){const _=rt(y(),r);T(_,_,n,v),T(_,_,e,S),l&&!pe(l,_)||g.push(_)}return g}const u=y();return mn(c,i,s,u)?!E(wn(u,r),o)||l&&!pe(l,u)?[]:[u]:[]}})();function Dn({start:n,end:e,type:t},i,s){const r=[],o=Ie(ot,e,n),a=oe(at,n,i),l=Fe(o),c=2*Ve(o,a),u=c*c-4*l*(Fe(a)-s*s);if(u===0){const d=-c/(2*l);(t===P.LINE||d>=0)&&r.push(T(y(),n,o,d))}else if(u>0){const d=Math.sqrt(u),p=(-c+d)/(2*l);(t===P.LINE||p>=0)&&r.push(T(y(),n,o,p));const g=(-c-d)/(2*l);(t===P.LINE||g>=0)&&r.push(T(y(),n,o,g))}return r}function qn(n,e){const t=n.start,i=n.end,s=e.start,r=e.end,o=C(ot,i,t),a=C(lt,r,s),l=C(zt,s,t),c=Be(kn,o,a);if(!E(M(l,c),0))return[];const u=wt(c);if(E(u,0))return[];const d=Be(Hn,l,a),p=M(d,c)/u,g=T(jn,t,o,p);if(n.type===P.RAY){const v=C(bt,g,t);if(M(o,v)<-$e())return[]}if(e.type===P.RAY){const v=C(bt,g,s);if(M(a,v)<-$e())return[]}return[fe(g)]}function fs({start:n,end:e,type:t},i){const s=C(ot,i,n),r=C(lt,e,n),o=Be(zt,r,s),a=wt(o)/wt(r),l=$e();if(a<l)switch(t){case P.LINE:return[fe(i)];case P.RAY:return M(r,s)<-l?[]:[fe(i)]}return[]}function qt(n,e,t,i){const[s,r]=n,[o,a]=t,l=o-s,c=a-r,u=l*l+c*c,d=Math.sqrt(u);if(d>e+i)return[];if(d<Math.abs(e-i))return[];if(E(d,0)&&E(e,i))return[];const p=(e*e-i*i+u)/(2*d),g=Math.sqrt(e*e-p*p),v=g*c/d,S=g*l/d,[_,x]=xn(Oe,n,t,p/d);return E(v,S)?[He(_,x)]:[He(_+v,x-S),He(_-v,x+S)]}function Qe(n,e,{start:t,end:i,type:s}){return Z(n.start,t[0],t[1],e),Z(n.end,i[0],i[1],e),n.type=ys[s],n}function zn(n,e){return E(n[2],e[2])}function E(n,e){return pi(Math.abs(n-e),0,$e())}function gs(n,e){return e.filter(t=>pe(n,t))}function pe(n,e){return fi(n,e)}var V;(function(n){n[n.PLANE=0]="PLANE",n[n.HALF_PLANE=1]="HALF_PLANE"})(V||(V={}));const ys={[V.PLANE]:P.LINE,[V.HALF_PLANE]:P.RAY},Oe=G(),at=G(),ot=y(),lt=y(),zt=y(),kn=y(),Hn=y(),jn=y(),bt=y(),vs=O(),kt={start:y(),end:y(),type:P.LINE},Ss={start:y(),end:y(),type:P.LINE};class q{intersect(e){return te(this,e)}closestPoints(e){return[this.closestTo(e)]}}class Pe extends q{constructor(e){super(),this.point=e}equals(e){return this===e||z(e)&&w(this.point,e.point)}closestTo(){return Le(this.point)}}class Ht extends q{constructor(e,t,i){super(),this.start=e,this.end=t,this.lineLike={start:e,end:t,type:i}}equals(e){return this===e||Y(e)&&this.lineLike.type===e.lineLike.type&&w(this.start,e.start)&&w(this.end,e.end)}closestTo(e){const t=I();return Dt(e,this.lineLike,t),t}}class jt extends Ht{constructor(e,t){super(e,t,P.LINE)}}class _s extends Ht{constructor(e,t){super(e,t,P.RAY)}}class Gn extends q{constructor(e){super(),this.constraints=e}equals(e){return this===e||Tt(e)&&_i(this.constraints,e.constraints,(t,i)=>t.equals(i))}closestTo(e){let t,i=1/0;for(const s of this.constraints){const r=s.closestTo(e),o=Ye(e,r);o<i&&(i=o,t=r)}return Le(t??e)}closestPoints(e){return this.constraints.flatMap(t=>t===this?[]:t.closestPoints(e))}}class Zn extends q{constructor(e,t){super(),this.center=e,this.radius=t}equals(e){return this===e||J(e)&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}closestTo(e){const t=I();return On(e,this.center,this.radius,t),t}}class Gt extends q{constructor(e,t){super(),this.center=e,this.radius=t}equals(e){return this===e||ie(e)&&w(this.center,e.center)&&this.radius===e.radius}closestTo(e){const t=I();return On(e,this.center,this.radius,t),t[2]=this.center[2],t}asCircle(){return new Zt(Le(this.center),this.radius,U(0,0,1))}}class Zt extends q{constructor(e,t,i,s=void 0){super(),this.center=e,this.radius=t,this.normal=i,this.slicePlane=s}equals(e){return this===e||ce(e)&&w(this.center,e.center)&&w(this.normal,e.normal)&&this.radius===e.radius}closestTo(e){const{center:t,radius:i}=this;Ln(this.getPlane(Es),e,ft);const s=C(ft,ft,t),r=Ei(s);if(E(r,0))return Le(e);const o=i/Math.sqrt(r),a=I();T(a,t,s,o);const{slicePlane:l}=this;if(l&&!pe(l,a)){const c=Wt(l,this);return(c==null?void 0:c.closestTo(e))??Le(e)}return a}getPlane(e=O()){return st(this.center,this.normal,e)}}const ft=y(),Es=O();class ms extends q{constructor(e){super(),this.z=e}equals(e){return this===e||ne(e)&&this.z===e.z}closestTo(e){return U(e[0],e[1],this.z)}getPlane(e=O()){return Z(rn,0,0,this.z),st(rn,Pi,e)}}const rn=y();class Ut extends q{constructor(e,t,i){super(),this.start=e,this.end=t,this.planeLike={start:e,end:t,type:i}}equals(e){return this===e||X(e)&&this.planeLike.type===e.planeLike.type&&w(this.start,e.start)&&w(this.end,e.end)}closestTo(e){const t=I();return In(e,this.planeLike,t),t}closestEndTo(e){const{start:t,end:i}=this.planeLike;return Math.sign(Ve(oe(ws,i,t),oe(xs,e,t)))>0?this.end:this.start}getPlane(e=O()){const t=rt(an,this.end);return t[2]+=1,Ri(this.start,this.end,t,e)}getSlicePlane(e=O()){const{start:t,end:i,type:s}=this.planeLike;if(s===V.PLANE)return;const r=Z(an,t[0],t[1],0),o=Z(on,i[0],i[1],0),a=Ie(on,o,r);return st(r,a,e),e}}const ws=G(),xs=G(),an=y(),on=y();class Un extends Ut{constructor(e,t){super(e,t,V.HALF_PLANE)}}class Wn extends Ut{constructor(e,t){super(e,t,V.PLANE)}}class $s extends q{constructor(e,t){super(),this.sphere=Ni(e,t)}equals(e){return this===e||se(e)&&Mi(this.sphere,e.sphere)}closestTo(e){const t=I();return Ai(this.sphere,e,t),t}get center(){return Fi(this.sphere)}get radius(){return this.sphere[3]}}class Bn extends q{constructor(e,t,i){super(),this.start=e,this.end=t,this.getZ=i,this.planeLike={start:e,end:t,type:V.PLANE}}equals(e){return this===e||et(e)&&w(this.start,e.start)&&w(this.end,e.end)&&this.getZ===e.getZ}closestTo(e){return Ns(this,e)}addIfOnTheGround(e,t){for(const i of t){const s=this.getZ(i[0],i[1])??0;E(i[2],s)&&(i[2]=s,e.push(i))}}}class Ls extends q{constructor(e,t,i){super(),this._x=e,this._y=t,this._z=i}equals(e){return this===e||Us(e)&&this._x===e._x&&this._y===e._y&&this._z===e._z}closestTo([e,t,i]){return Fn(this._x??e,this._y??t,this._z??i)}}class bs extends q{constructor(e,t,i,s,r){super(),this._origin=e,this._spatialReference=t,this._distanceMeters=i,this._elevationMeters=s,this._directionDegrees=r}equals(e){return this===e||Zs(e)&&Qt(this._origin,e._origin)&&this._spatialReference===e._spatialReference&&this._distanceMeters===e._distanceMeters&&this._elevationMeters===e._elevationMeters&&this._directionDegrees===e._directionDegrees}closestTo([e,t,i]){return $n(Ne,e,t),Qt(Ne,this._origin)||this._applyDirectionAndDistance(Ne),Fn(Ne[0],Ne[1],this._elevationMeters??i)}_applyDirectionAndDistance(e){if(this._directionDegrees!=null&&this._distanceMeters!=null)Ke(e,this._origin,this._directionDegrees,this._distanceMeters,this._spatialReference);else if(this._directionDegrees!=null)Ps(e,this._origin,this._directionDegrees,e,this._spatialReference);else if(this._distanceMeters!=null){const{azimuth:t}=Ct(Ts,this._origin,e,this._spatialReference);Ke(e,this._origin,t??0,this._distanceMeters,this._spatialReference)}}}const Ne=[0,0],Ts=new Vt;function Ps(n,e,t,i,s){let{azimuth:r,distance:o}=Ct(Rs,e,i,s);r??(r=0);let a=o*Math.cos((r-t)*Ci);a=Math.max(0,a),Ke(n,e,t,a,s)}const Rs=new Vt;function Ns(n,e){const t=I();return In(e,n.planeLike,t),t[2]=n.getZ(t[0],t[1])??Xn,t}function te(n,e){if(Tt(n)){const t=[];for(const i of n.constraints){const s=i.intersect(e);s&&t.push(s)}return Bt(t)}if(Tt(e))return te(e,n);if(et(n))return ln(n,e);if(et(e))return ln(e,n);if(z(n)){const{point:t}=n;if(z(e))return w(t,e.point)?n:void 0;const i=e.closestTo(t);return $i(i,t)?n:void 0}if(Y(n)){if(z(e))return te(e,n);if(Y(e))return j(qn(n.lineLike,e.lineLike));if(ne(e))return Ms(n,e);if(X(e))return j(Cn(e.planeLike,n.lineLike));if(J(e))return j(Dn(n.lineLike,e.center,e.radius));if(ce(e))return j(ps(n.lineLike,e));if(ie(e))return As(n,e);if(se(e))return Fs(n,e)}else if(ne(n)){if(z(e)||Y(e))return te(e,n);if(ne(e))return Cs(n,e);if(X(e))return Vs(n,e);if(J(e))return Is(n,e);if(ce(e))return Ds(n,e);if(ie(e))return Os(n,e);if(se(e))return qs(n,e)}else if(X(n)){if(z(e)||Y(e)||ne(e))return te(e,n);if(X(e))return gt(Vn(n.planeLike,e.planeLike));if(J(e))return gt(Ot(n.planeLike,e.center,e.radius));if(ce(e))return ks(n,e);if(ie(e))return zs(n,e);if(se(e))return Hs(n,e)}else if(J(n)){if(z(e)||Y(e)||ne(e)||X(e))return te(e,n);if(J(e))return gt(qt(n.center,n.radius,e.center,e.radius));if(ce(e))return void 0;if(ie(e))return js(n,e);if(se(e))return void 0}else if(ce(n)){if(z(e)||Y(e)||ne(e)||X(e)||J(e))return te(e,n);if(ce(e))return void 0;if(ie(e))return e.asCircle(),void 0;if(se(e))return void 0}else if(ie(n)){if(z(e)||Y(e)||ne(e)||X(e)||J(e)||ce(e))return te(e,n);if(ie(e))return Gs(e,n);if(se(e))return void 0}else if(se(n)){if(z(e)||Y(e)||ne(e)||X(e)||J(e)||ie(e))return te(e,n);if(se(e))return void 0}}const Ms=(()=>{const n=O();return(e,t)=>{const{start:i,end:s}=e;if(zn(i,s)&&E(i[2],t.z))return e;const r=I();return mn(t.getPlane(n),i,s,r)?new Pe(r):void 0}})();function As({lineLike:n},{center:e,radius:t}){const i=e[2];return j(Dn(n,e,t).filter(s=>E(s[2],i)))}function Fs({lineLike:n},{sphere:e}){return j(Li(e,n.start,n.end))}const Wt=(()=>{const n=bi(),e=y(),t=y();return(i,s,r)=>{const{normal:o,center:a,radius:l}=s;En(o,e,t);const c=bn(i),u=l*M(c,e),d=l*M(c,t);mi(n,a[0],a[1],a[2],1);const p=wi(i,n),g=Math.hypot(u,d),v=E(g,0);if(E(mt(i,a),0)){if(v)return s;if(E(l,0))return!r||pe(r,a)?new Pe(Le(a)):void 0;Be(e,c,o),xi(e,e);const dt=new Array,De=fe(a);T(De,De,e,l),r&&!pe(r,De)||dt.push(De);const qe=fe(a);return T(qe,qe,e,-l),r&&!pe(r,qe)||dt.push(qe),j(dt)}if(v)return;const S=-p/g;if(Math.abs(S)>1||E(S,1))return;const _=Math.atan(u/d),x=Ti(S)-_,ye=Math.PI-x,A=new Array,ee=y();T(ee,a,e,l*Math.cos(x)),T(ee,ee,t,l*Math.sin(x)),A.push(ee);const W=y();return T(W,a,e,l*Math.cos(ye)),T(W,W,t,l*Math.sin(ye)),A.push(W),j(r?gs(r,A):A)}})();function Cs(n,e){return E(n.z,e.z)?n:void 0}function Vs({z:n},{planeLike:e}){const[t,i]=e.start,[s,r]=e.end,o=U(t,i,n),a=U(s,r,n);return e.type===V.PLANE?new jt(o,a):new _s(o,a)}function Is(n,e){const[t,i]=e.center;return new Gt(U(t,i,n.z),e.radius)}function Os(n,e){return E(e.center[2],n.z)?e:void 0}const Ds=(()=>{const n=O();return(e,t)=>Wt(e.getPlane(n),t,t.slicePlane)})();function qs(n,{center:e,radius:t}){const i=Math.abs(e[2]-n.z);if(i>t&&!E(i,t))return;const s=U(e[0],e[1],n.z),r=Math.sqrt(t**2-i**2);return E(r,0)?void 0:new Gt(s,r)}const zs=(()=>{const n=O();return(e,{center:t,radius:i})=>{const s=Ot(e.planeLike,t,i),r=t[2];e.getSlicePlane(n);const o=new Array;for(const[a,l]of s){const c=[a,l,r];pe(n,c)&&o.push(c)}return j(o)}})(),ks=(()=>{const n=O(),e=O();return(t,i)=>Wt(t.getPlane(n),i,t.getSlicePlane(e))})(),Hs=(()=>{const n=O();return(e,{center:t,radius:i})=>{const s=e.getPlane(n),r=Si(s,t),o=Math.abs(r);if(o>i&&!E(o,i))return;const a=Math.sqrt(i**2-r**2);if(E(a,0)){const u=I();return Ln(s,t,u),new Pe(u)}const l=I(),c=fe(bn(s));return T(l,t,c,r),new Zt(l,a,c,e.getSlicePlane())}})();function js(n,e){const t=_e(n.center,e.center);return E(t,0)&&E(n.radius,e.radius)?e:Yn(qt(n.center,n.radius,e.center,e.radius),e.center[2])}function Gs(n,e){if(!zn(n.center,e.center))return;const t=_e(n.center,e.center);return E(t,0)&&E(n.radius,e.radius)?n:Yn(qt(n.center,n.radius,e.center,e.radius),n.center[2])}function ln(n,e){const{planeLike:t,getZ:i}=n,s=new Array;if(z(e))n.addIfOnTheGround(s,hs(t,e.point));else if(Y(e))n.addIfOnTheGround(s,Cn(t,e.lineLike));else if(J(e))for(const[r,o]of Ot(t,e.center,e.radius)){const a=i(r,o);a!=null&&s.push(We(r,o,a))}else if(X(e)||et(e))for(const[r,o]of Vn(t,e.planeLike)){const a=i(r,o)??Xn;s.push(We(r,o,a))}return j(s)}function gt(n){return Bt(n.map(([e,t])=>{const i=U(e,t,0),s=U(e,t,1);return new jt(i,s)}))}function j(n){return Bt(n.map(e=>e?new Pe(e):void 0))}function Yn(n,e){return j(n.map(([t,i])=>[t,i,e]))}function Bt(n){if(n.length!==0)return n.length===1?n[0]??void 0:new Gn(n.filter(Tn))}function Tt(n){return n instanceof Gn}function z(n){return n instanceof Pe}function Y(n){return n instanceof Ht}function ne(n){return n instanceof ms}function X(n){return n instanceof Ut}function J(n){return n instanceof Zn}function ie(n){return n instanceof Gt}function ce(n){return n instanceof Zt}function se(n){return n instanceof $s}function et(n){return n instanceof Bn}function Zs(n){return n instanceof bs}function Us(n){return n instanceof Ls}const Xn=0;function we(n,e){const t=n.x-e.x,i=n.y-e.y;return t*t+i*i}function Ws(n,e){return Math.sqrt(we(n,e))}function Yt(n,e){e.sort((t,i)=>Ye(t.targetPoint,n)-Ye(i.targetPoint,n))}var D;function Or({point:n,distance:e,returnEdge:t,vertexMode:i,coordinateHelper:{spatialReference:s},filter:r},o,a){return a=a!=null?a.clone():new Vi({where:"1=1"}),r&&(a.geometry=r.geometry,a.distance=r.distance,a.spatialRelationship=r.spatialRelationship,a.where=Nt(a.where,r.where),a.timeExtent=Ii(a.timeExtent,r.timeExtent),a.objectIds=Bs(a.objectIds,r.objectIds)),{point:it(n[0],n[1],n[2],s.toJSON()),mode:o,distance:e,returnEdge:t,vertexMode:i,query:a.toJSON()}}function Bs(n,e){return n||e?e?n?Array.from(Oi(new Set(n),new Set(e))):e:n:null}function tt(n,e,t){return{left:L(n.leftVertex.pos,e,t),right:L(n.rightVertex.pos,e,t)}}function Dr(n){return n.createQuery()}(function(n){n[n.TARGET=0]="TARGET",n[n.REFERENCE=1]="REFERENCE",n[n.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(D||(D={}));const cn=Symbol("snapping-toggle");function qr(n,e=()=>{}){const t=de(()=>({view:n.view,snappingOptions:n.snappingOptions}),({view:i,snappingOptions:s})=>{if(n.removeHandles(cn),!i||!s)return;const r=Di.TOOL,o=[i.on("key-down",a=>{a.key!==tn.toggle||a.repeat||(s.enabledToggled=!0,e())},r),i.on("key-up",a=>{a.key===tn.toggle&&(s.enabledToggled=!1,e())},r),i.on("pointer-move",a=>{const l=a.native.ctrlKey;s.enabledToggled!==l&&(s.enabledToggled=l,e())},r)];n.addHandles(o,cn)},Xe);n.addHandles(t)}function un(n){var e;return os(n)&&"utilityNetworks"in n&&!!((e=n.utilityNetworks)!=null&&e.length)}let F=class extends Te{set attributeRulesEnabled(e){this._set("attributeRulesEnabled",e),e&&this.loadRules()}get layerView(){var e,t;return(t=(e=this.view)==null?void 0:e.allLayerViews)==null?void 0:t.find(i=>i.layer===this.layer)}get valid(){const{_valid:e,snappingSource:t,layer:i}=this;return!(!t||!i)&&e}get subtypeFilter(){var r,o;const{layer:e,snappingSource:t}=this;if(!ze(e)||!((r=e.subtypes)!=null&&r.length)||!t)return{mode:"not-in-use",filter:null};const i=t.layerSource.sublayerSources.filter(a=>{var l;return a.enabled&&a.layer.visible&&qi((l=this.view)==null?void 0:l.scale,a.layer.effectiveScaleRange.minScale,a.layer.effectiveScaleRange.maxScale)}).map(a=>a.layer.subtypeCode);if(!i.length)return{mode:"none-visible",filter:null};if(i.length===e.subtypes.length)return{mode:"all-visible",filter:null};const s=((o=e.fieldsIndex.get(e.subtypeField))==null?void 0:o.name)??e.subtypeField;return i.length===1?{mode:"in-use",filter:`${s} = ${i.getItemAt(0)}`}:{mode:"in-use",filter:`${s} IN (${i.join(", ")})`}}get floorFilter(){const{view:e,layer:t}=this;return e&&t?as({view:e,layer:t}):null}constructor(e){super(e),this.layer=null,this.snappingSource=null,this.rulesTable=null,this._valid=null}initialize(){if(!this.snappingSource||!this.layer)return void(this._valid=!1);const{layer:e,snappingSource:t}=this;if("refresh"in e){const i=e;this.addHandles(i.on("refresh",()=>t.refresh()))}this.loadRules(),this.addHandles([de(()=>t.updating,i=>t.layerSource.updating=i,Xe),de(()=>t.availability,i=>t.layerSource.availability=i,Xe)])}getFetchCandidatesParameters(e,t,i){var p,g,v,S,_;if(!this.valid)return[];const{layer:s,layerView:r,floorFilter:o,rulesTable:a,subtypeFilter:l}=this,c={distance:i,mode:((p=this.view)==null?void 0:p.type)??"2d",point:e,coordinateHelper:t.coordinateHelper,...Ys(),filter:r&&"filter"in r?r.filter:null};if(o&&(c.filter=yt(c.filter,o)),l.mode!=="not-in-use"&&l.mode!=="all-visible"){if(l.mode==="none-visible")return[];c.filter?c.filter.where=Nt(c.filter.where,l.mode):c.filter=new je({where:l.filter})}if(!this.attributeRulesEnabled)return[c];const u=t.feature,d=((g=u==null?void 0:u.sourceLayer)==null?void 0:g.type)==="subtype-sublayer"?u.sourceLayer.parent:u==null?void 0:u.sourceLayer;if(a&&u&&un((v=this.view)==null?void 0:v.map)&&(ht(s)||ze(s))&&s.layerId&&(ht(d)||ze(d))&&((S=this.view.map.utilityNetworks)!=null&&S.find(x=>x.isUtilityLayer(d)))){if(a.loadStatus!=="loaded")return[];const x=[],ye=s.layerId,A=(_=a.getFeatureSQL(d,u))==null?void 0:_[ye];if(!A)return[];const ee=A.anyVertex;let W=A.endVertex;return W&&ee&&W===ee&&(W=""),W&&x.push({...c,returnEdge:!1,vertexMode:"ends",filter:yt(c.filter,W)}),ee&&x.push({...c,returnEdge:!1,vertexMode:"all",filter:yt(c.filter,ee)}),x}return[c]}async loadRules(){var s,r,o;this._valid=null;const{layer:e,view:t,attributeRulesEnabled:i}=this;if(i&&e&&t&&un(t==null?void 0:t.map)&&(ht(e)||ze(e)))try{await Promise.allSettled(((s=t.map.utilityNetworks)==null?void 0:s.map(l=>l.load()))??[]);const a=(r=t.map.utilityNetworks)==null?void 0:r.find(l=>l.isUtilityLayer(e));a&&(this.rulesTable=await a.getRulesTable(),await((o=this.rulesTable)==null?void 0:o.load()))}catch{return this._valid=!1,void Sn.getLogger("esri.views.interactive.snapping.FeatureSnappingSourceInfo").error("Failed to load rules table for snapping source",e.title)}this._valid=!0}remove(){this.destroy()}destroy(){var e;(e=this.snappingSource)==null||e.destroy()}};function Ys(){return{returnEdge:!0,vertexMode:"all"}}function yt(n,e){return n==null?new je({where:e}):n.where?new je({where:Nt(n.where,e)}):new je({where:e})}h([f({constructOnly:!0})],F.prototype,"layer",void 0),h([f({constructOnly:!0})],F.prototype,"snappingSource",void 0),h([f({constructOnly:!0})],F.prototype,"view",void 0),h([f({value:!1})],F.prototype,"attributeRulesEnabled",null),h([f()],F.prototype,"layerView",null),h([f()],F.prototype,"rulesTable",void 0),h([f()],F.prototype,"valid",null),h([f()],F.prototype,"subtypeFilter",null),h([f()],F.prototype,"floorFilter",null),h([f()],F.prototype,"_valid",void 0),F=h([ge("esri.views.interactive.snapping.FeatureSnappingSourceInfo")],F);var b;(function(n){n[n.FEATURE=1]="FEATURE",n[n.SELF=2]="SELF",n[n.ALL=3]="ALL"})(b||(b={}));class Re{constructor(e,t,i,s){this.targetPoint=e,this.constraint=t,this.isDraped=i,this.domain=s}}let Xt=class extends Re{constructor({targetPoint:e,objectId:t,constraint:i,isDraped:s}){super(e,i,s,b.FEATURE),this.objectId=t}},ct=class{constructor(e,t){this.isDraped=e,this.domain=t}},Q=class Jn extends ct{constructor(e,t,i,s,r=b.ALL,o=!0,a=!0){super(s,r),this.type=e,this.lineStart=t,this.lineEnd=i,this.fadeLeft=o,this.fadeRight=a}equals(e){return e instanceof Jn&&this.type===e.type&&w(this.lineStart,e.lineStart)&&w(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}get length(){return wn(this.lineStart,this.lineEnd)}},Kn=class extends Xt{constructor(e){super({...e,isDraped:!0,constraint:new Bn(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new Q(D.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},Qn=class extends Xt{constructor(e){super({...e,constraint:new jt(e.edgeStart,e.edgeEnd)})}get hints(){return[new Q(D.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},ei=class ti extends ct{constructor(e,t,i,s,r=b.ALL){super(s,r),this.previousVertex=e,this.centerVertex=t,this.nextVertex=i}equals(e){return e instanceof ti&&w(this.previousVertex,e.previousVertex)&&w(this.centerVertex,e.centerVertex)&&w(this.nextVertex,e.nextVertex)}};class Jt extends Re{constructor({targetPoint:e,constraint:t,previousVertex:i,otherVertex:s,otherVertexType:r,isDraped:o,selfSnappingType:a,objectId:l,domain:c}){super(e,t,o,c??b.SELF),this.previousVertex=i,this.otherVertex=s,this.otherVertexType=r,this.selfSnappingType=a??ue.None,this.objectId=l??null}get hints(){const e=this.previousVertex,t=this.otherVertexType===be.CENTER?this.otherVertex:this.targetPoint,i=this.otherVertexType===be.CENTER?this.targetPoint:this.otherVertex;return[new Q(D.TARGET,t,i,this.isDraped,this.domain),new Q(D.REFERENCE,e,t,this.isDraped,this.domain),new ei(this.previousVertex,t,i,this.isDraped,this.domain)]}}var be,ue;(function(n){n[n.NEXT=0]="NEXT",n[n.CENTER=1]="CENTER"})(be||(be={})),function(n){n[n.None=0]="None",n[n.LastVertex=1]="LastVertex",n[n.FirstVertex=2]="FirstVertex",n[n.ExistingEdge=3]="ExistingEdge"}(ue||(ue={}));let re=class extends Te{get updating(){return this._snappingSources.some(e=>{var t;return(e==null?void 0:e.valid)==null||e.valid===!0&&((t=e.snappingSource)==null?void 0:t.updating)===!0})||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=b.FEATURE,this._updatingHandles=new zi,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){const e=ki(()=>{var t;return(t=this.options)==null?void 0:t._effectiveFeatureSources},(t,i)=>this._createSourceInfo(t,i));this._snappingSources=e,this.addHandles([Hi(e),de(()=>{var t;return{rulesEnabled:!!((t=this.options)!=null&&t.attributeRulesEnabled),sources:this._snappingSources.filter(Tn)}},({rulesEnabled:t,sources:i})=>{for(const s of i)s.attributeRulesEnabled=t},xt)])}destroy(){this._set("options",null),this._updatingHandles.destroy()}async fetchCandidates(e,t,i,s){var l,c,u;if(!(t&this._domain&&this.options!=null&&this.options.effectiveFeatureEnabled))return[];const r=[],o=this._computeScreenSizeDistanceParameters(e,i);for(const d of this._snappingSources){if(!(d!=null&&d.valid)||!((c=(l=d.snappingSource)==null?void 0:l.layerSource)!=null&&c.enabled)||(u=d.layerView)!=null&&u.suspended)continue;const p=d.getFetchCandidatesParameters(e,i,o);for(const g of p)r.push(d.snappingSource.fetchCandidates(g,s).then(v=>v.filter(S=>!this._candidateIsExcluded(d.snappingSource,S,i.excludeFeature))))}const a=(await ji(r)).flat();return this._addRightAngleCandidates(a,e,o,i),pt(s),Yt(e,a),a}_addRightAngleCandidates(e,t,i,s){var d,p,g,v,S,_,x,ye;const r=s.vertexHandle!=null?(p=(d=s.vertexHandle.rightEdge)==null?void 0:d.rightVertex)==null?void 0:p.pos:s.editGeometryOperations!=null&&s.editGeometryOperations.data.type==="polygon"?(v=(g=s.editGeometryOperations.data.components[0])==null?void 0:g.getFirstVertex())==null?void 0:v.pos:null,o=s.vertexHandle!=null?(_=(S=s.vertexHandle.leftEdge)==null?void 0:S.leftVertex)==null?void 0:_.pos:s.editGeometryOperations!=null?(ye=(x=s.editGeometryOperations.data.components[0])==null?void 0:x.getLastVertex())==null?void 0:ye.pos:null,{view:a}=this,l=L(r,a,s),c=L(o,a,s),u=e.length;for(let A=0;A<u;A++)this._addRightAngleCandidate(e[A],c,t,i,e),this._addRightAngleCandidate(e[A],l,t,i,e)}_addRightAngleCandidate(e,t,i,s,r){if(t==null||!Xs(e))return;const o=e.constraint.closestTo(t),a=(o[0]-i[0])/s.x,l=(o[1]-i[1])/s.y,{start:c,end:u}=e.constraint;if(a*a+l*l<=1){const d=_e(o,c)>_e(o,u)?c:u,p=new Jt({targetPoint:he(o),otherVertex:t,otherVertexType:be.NEXT,previousVertex:d,constraint:new Un(t,o),objectId:e.objectId,isDraped:e.isDraped,domain:b.FEATURE});r.push(p)}}_computeScreenSizeDistanceParameters(e,t){let i=this.options!=null?this.options.distance*(t.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return this.view==null?{x:i,y:i,z:i,distance:i}:this.view.type==="2d"?(i*=this.view.resolution,{x:i,y:i,z:i,distance:i}):this._computeScreenSizeDistanceParameters3D(e,i,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,i,s){const{spatialReference:r}=s;i.renderCoordsHelper.toRenderCoords(e,r,dn);const o=i.state.camera.computeScreenPixelSizeAt(dn),a=o*i.renderCoordsHelper.unitInMeters,l=a/Pn(r),c=a/Gi(r),u=t*l,d=t*c,p=N(e,r,$,i),g=p?vt(p,e,l,0,0,i,s):0,v=p?vt(p,e,0,l,0,i,s):0,S=p?vt(p,e,0,0,c,i,s):0;return{x:g===0?0:u/g,y:v===0?0:u/v,z:S===0?0:d/S,distance:o*t}}_candidateIsExcluded(e,t,i){if(i==null)return!1;const s=this._getCandidateObjectId(t);if(s==null)return!1;const r=e.layerSource.layer;return r.type==="graphics"?i.uid===s:i.sourceLayer===r&&!(!i.attributes||!("objectIdField"in r))&&i.attributes[r.objectIdField]===s}_getCandidateObjectId(e){return e instanceof Xt?e.objectId:null}async _createSourceInfo(e,t){const i=e.layer;i.loaded||(await i.load(),pt(t));const{view:s}=this,r=await this._createFeatureSnappingSourceType(e);return pt(t),new F(r==null?{}:{snappingSource:r,view:s,layer:i})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;return t==null||t.type!=="3d"?null:new(await this._getSourceModule("scene")).SceneLayerSnappingSource({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){var t;switch((t=e.layer.source)==null?void 0:t.type){case"feature-layer":case"oriented-imagery":return new(await this._getSourceModule("featureService")).FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e});case"memory":case"csv":case"geojson":case"wfs":return e.layer.geometryType==="mesh"?null:new(await this._getSourceModule("featureCollection")).FeatureCollectionSnappingSource({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new(await this._getSourceModule("graphics")).GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new(await this._getSourceModule("notes")).GraphicsSnappingSource({getGraphicsLayers:()=>{var t;return((t=e.layer.sublayers)==null?void 0:t.toArray())??[]},spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){const t=this._sourceModules[e];if(t.loader==null){const i=this._loadSourceModule(e),s={module:null,loader:i};this._sourceModules[e]=s;const r=await i,o={module:r,loader:i};return this._sourceModules[e]=o,r}return t.module==null?t.loader:t.module}_loadSourceModule(e){const t=this._updatingHandles;switch(e){case"featureService":return t.addPromise(ke(()=>import("./FeatureServiceSnappingSource-CKAqxbnw.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15])));case"featureCollection":return t.addPromise(ke(()=>import("./FeatureCollectionSnappingSource-CA3A7Kv3.js"),__vite__mapDeps([16,1,2,3,4,5,6,17,9,10,11,12,13,14,15])));case"graphics":case"notes":return t.addPromise(ke(()=>import("./GraphicsSnappingSource-BcWgf5q6.js"),__vite__mapDeps([18,1,2,3,19,20,21,22,23,24,25,26,27,28,29,30,31,32,4,5,6,17,9,10,11,12,13,14,15])));case"scene":return t.addPromise(ke(()=>import("./SceneLayerSnappingSource-B_AFDVkr.js"),__vite__mapDeps([33,1,2,34,8,35,5,6,9,10,11,12,13,14,15])))}}get test(){}};function Xs(n){return(n instanceof Qn||n instanceof Kn)&&!Js(n)}function Js({constraint:{start:n,end:e}}){const t=Ye(n,e),i=_e(n,e);return t<$e()||i/t<Qs}function vt(n,e,t,i,s,r,{spatialReference:o}){const a=rt(Ks,e);a[0]+=t,a[1]+=i,a[2]+=s;const l=N(a,o,$,r);return l?Ws(l,n):1/0}h([f({constructOnly:!0})],re.prototype,"spatialReference",void 0),h([f({constructOnly:!0})],re.prototype,"view",void 0),h([f()],re.prototype,"options",void 0),h([f({readOnly:!0})],re.prototype,"updating",null),h([f()],re.prototype,"_snappingSources",void 0),re=h([ge("esri.views.interactive.snapping.FeatureSnappingEngine")],re);const dn=y(),Ks=y(),Qs=1e-4;class ut{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=K.shortLineThreshold*K.shortLineThreshold}snap(e,t){return t.vertexHandle!=null?t.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(L(e.leftVertex.pos,this.view,t),L(e.rightVertex.pos,this.view,t),t)}exceedsShortLineThreshold(e,t,{spatialReference:i}){return this.squaredShortLineThreshold===0||we(N(t,i,$,this.view),N(e,i,$,this.view))>this.squaredShortLineThreshold}isVertical(e,t,{spatialReference:i}){const s=Pn(i);return Mt(e,t)*s<K.verticalLineThresholdMeters}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}}let ni=class extends Re{constructor({lineStart:e,lineEnd:t,targetPoint:i,isDraped:s}){super(i,new Wn(e,t),s,b.SELF),this._referenceLineHint=new Q(D.REFERENCE_EXTENSION,e,t,s,this.domain)}get hints(){return[this._referenceLineHint,new Q(D.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}};var k;function er(n,e){if(n==null||e==null)return;const t=Pt(n,e);return t!=null?Ee(t,"radians","geographic"):void 0}(function(n){n.Absolute="absolute",n.Relative="relative",n.RelativeBilateral="relative-bilateral"})(k||(k={}));const Pt=(()=>{const n=y(),e=y();return(t,i)=>(Z(n,t.x,t.y,t.z??0),Z(e,i.x,i.y,i.z??0),Ce(n,e,t.spatialReference,i.spatialReference))})(),Ce=(()=>{const n=G(),e=y(),t=y();return(i,s,r,o)=>{if(w(i,s))return;const a=$t(r),l=$t(o);if(a&&l&&Zi(a,l)&&Je(i,r,e,a)&&Je(s,o,t,l)){const{azimuth:u}=Ct(nr,e,t,a);return u!=null?At(u,"degrees","radians"):void 0}n[0]=s[0]-i[0],n[1]=s[1]-i[1];let c=Ui(Wi,n);return n[0]<0&&(c=ir-c),c}})();function Wr(n,e,t,i=k.Absolute){if(e&&t)switch(i){case k.Absolute:return er(e,t);case k.Relative:return pn(hn(n,e,t),k.Relative);case k.RelativeBilateral:return pn(hn(n,e,t),k.RelativeBilateral)}}function hn(n,e,t){if(!n||!e||!t)return;const i=Pt(n,e),s=Pt(e,t);return i!=null&&s!=null?Ee(s-i,"radians","geographic"):void 0}function pn(n,e){if(n!=null)switch(e){case k.Absolute:return tr(n);case k.Relative:{const t=nt(n);let i=fn.normalize(t,0,!0);return i===-180&&(i=180),Ee(i,"degrees","geographic")}case k.RelativeBilateral:{const t=nt(n),i=Math.abs(fn.normalize(t,0,!0));return Ee(i,"degrees","geographic")}}}function tr(n){const e=nt(n),t=sr.normalize(e,0,!0);return Ee(t,"degrees","geographic")}const ii=(()=>{const n=y();return(e,t,i,s,r,o="geodesic")=>{rt(n,t);const a=nt(r);if(o==="geodesic"){const g=$t(i);if(g&&Je(n,i,n,g))return Ke(e,n,a,s,g),e[2]=t[2],!!Je(e,g,e,i)}const l=Ft(a,"geographic","arithmetic"),c=At(l,"degrees","radians"),u=t[0]+s*Math.cos(c),d=t[1]+s*Math.sin(c),p=t[2];return Z(e,u,d,p),!0}})();function nt(n){if(n!=null)return Ft(si(n),n.rotationType,"geographic")}function Br(n){if(n!=null)return Ft(si(n),n.rotationType,"arithmetic")}function si(n){return At(n.value,n.unit,"degrees")}const nr=new Vt,ir=2*Math.PI,sr=Bi,fn=new Yi(-180,180);class rr extends ut{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.edges.length,r=[];if(s<1)return r;const{spatialReference:o}=t,a=N(e,o,$,this.view),{view:l}=this,c=i.edges[s-1];let u=c;do{if(this.edgeExceedsShortLineThreshold(u,t)){const d=tt(u,l,t);this._processCandidateProposal(d.left,d.right,e,a,t,r)}u=u.leftVertex.leftEdge}while(u&&u!==c);return r}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<2)return i;const{view:o}=this,{spatialReference:a}=t,l=N(e,a,$,o),c=s.leftEdge,u=s.rightEdge;c&&u&&this.edgeExceedsShortLineThreshold(c,t)&&this.edgeExceedsShortLineThreshold(u,t)&&this._processCandidateProposal(L(c.leftVertex.pos,o,t),L(u.rightVertex.pos,o,t),e,l,t,i);const d=r.edges[0];let p=d;do{if(p!==s.leftEdge&&p!==s.rightEdge&&this.edgeExceedsShortLineThreshold(p,t)){const g=tt(p,o,t);this._processCandidateProposal(g.left,g.right,e,l,t,i)}p=p.rightVertex.rightEdge}while(p&&p!==d);return i}_processCandidateProposal(e,t,i,s,r,o){var d;const{spatialReference:a,pointer:l}=r,c=y();ar(c,e,t,i,r);const u=he(c);we(s,N(u,a,$,this.view))<this.squaredProximityThreshold(l)&&o.push(new ni({lineStart:e,lineEnd:t,targetPoint:u,isDraped:((d=r.elevationInfo)==null?void 0:d.mode)==="on-the-ground"}))}}function ar(n,e,t,i,s){or(n,e,t,i,s)||lr(n,i,e,t)}function or(n,e,t,i,{spatialReference:s}){const r=Ce(e,t,s,s);if(r==null)return!1;const o=Ce(t,i,s,s);if(o==null)return!1;const a=Mn(t,i,s);if(a==null)return!1;const l=Math.abs(Xi.shortestSignedDiff(r,o))>Math.PI/2?Rn.normalize(r+Math.PI):r;return ii(n,t,s,Nn(a,"meters"),Ee(l,"radians","geographic"),"geodesic"),n[2]=i[2],!0}function lr(n,e,t,i){Dt(e,{start:t,end:i,type:P.LINE},n),n[2]=e[2]}let cr=class ri extends ct{constructor(e,t,i,s=b.ALL){super(i,s),this.lineStart=e,this.lineEnd=t}equals(e){return e instanceof ri&&w(this.lineStart,e.lineStart)&&w(this.lineEnd,e.lineEnd)}},ai=class extends Re{constructor({referenceLine:e,lineStart:t,targetPoint:i,isDraped:s}){const r=fe(t),{left:o,right:a}=e;Ie(r,Ji(r,r,a),o),super(i,new Wn(t,r),s,b.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new Q(D.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new cr(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new Q(D.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(i=>{w(e.right,i.edge.left)&&(i.fadeLeft=!1,t.fadeRight=!1),w(e.right,i.edge.right)&&(i.fadeRight=!1,t.fadeRight=!1),w(e.left,i.edge.right)&&(i.fadeRight=!1,t.fadeLeft=!1),w(e.left,i.edge.left)&&(i.fadeLeft=!1,t.fadeLeft=!1)}),this._referenceLines.push(t)}},ur=class extends ut{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.edges.length,r=i.vertices.length,o=[];if(s<2)return o;const{view:a}=this,l=N(e,t.spatialReference,$,a),c=L(i.vertices[r-1].pos,a,t),u=L(i.vertices[0].pos,a,t),d=i.edges[s-1];let p=d;do{if(this.edgeExceedsShortLineThreshold(p,t)){const g=tt(p,a,t);this._checkEdgeForParallelLines(g,c,e,l,t,o),this._checkEdgeForParallelLines(g,u,e,l,t,o)}p=p.leftVertex.leftEdge}while(p&&p!==d);return o}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<3)return i;const{view:o}=this,a=N(e,t.spatialReference,$,o),l=s.leftEdge,c=s.rightEdge,u=r.vertices[0],d=L(u.pos,o,t),p=r.vertices.length,g=r.vertices[p-1],v=L(g.pos,o,t),S=r.edges[0];let _=S;do{if(_!==l&&_!==c&&this.edgeExceedsShortLineThreshold(_,t)){const x=tt(_,o,t);l&&this._checkEdgeForParallelLines(x,L(l.leftVertex.pos,o,t),e,a,t,i),c&&this._checkEdgeForParallelLines(x,L(c.rightVertex.pos,o,t),e,a,t,i),s===u?this._checkEdgeForParallelLines(x,v,e,a,t,i):s===g&&this._checkEdgeForParallelLines(x,d,e,a,t,i)}_=_.rightVertex.rightEdge}while(_&&_!==S);return i}_checkEdgeForParallelLines(e,t,i,s,r,o){var p;const a=e.left,l=e.right;if(Lt(ve,t,a,l),_e(ve,t)<K.parallelLineThreshold)return;Lt(ve,i,a,l,t);const{spatialReference:c,pointer:u}=r,d=he(U(ve[0],ve[1],i[2]));if(we(s,N(d,c,$,this.view))<this.squaredProximityThreshold(u)){if(this.isVertical(d,t,r)||this.isVertical(a,l,r)||dr(e,o))return;o.push(new ai({referenceLine:e,lineStart:t,targetPoint:d,isDraped:((p=r.elevationInfo)==null?void 0:p.mode)==="on-the-ground"}))}}};function dr(n,e){const t=n.left,i=n.right;for(const s of e)if(Lt(ve,i,s.constraint.start,s.constraint.end,t),_e(ve,i)<K.parallelLineThreshold)return s.addReferenceLine(n),!0;return!1}const ve=G();class hr extends ut{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=[];if(i.vertices.length<2)return s;const{view:r}=this,o=N(e,t.spatialReference,$,r),a=i.vertices.at(-1);this._checkForSnappingCandidate(ue.LastVertex,s,a.leftEdge,a,a.leftEdge.leftVertex,e,o,t);const l=i.vertices[0];return this._checkForSnappingCandidate(ue.FirstVertex,s,l.rightEdge,l,l.rightEdge.rightVertex,e,o,t),s}snapExistingVertex(e,t){const i=[],s=t.vertexHandle;if(s.component.vertices.length<3)return i;const{view:r}=this,o=N(e,t.spatialReference,$,r),a=s.leftEdge,l=s.rightEdge;if(a!=null&&a.leftVertex.leftEdge){const c=a.leftVertex.leftEdge;this._checkForSnappingCandidate(ue.ExistingEdge,i,c,c.rightVertex,c.leftVertex,e,o,t)}if(l!=null&&l.rightVertex.rightEdge){const c=l.rightVertex.rightEdge;this._checkForSnappingCandidate(ue.ExistingEdge,i,c,c.leftVertex,c.rightVertex,e,o,t)}return i}_checkForSnappingCandidate(e,t,i,s,r,o,a,l){if(!this.edgeExceedsShortLineThreshold(i,l))return;const c=this.view,u=L(s.pos,c,l),d=L(r.pos,c,l);pr(gn,d,u,o,l),this._checkForSnappingCandidateAlongProjectedRay(e,t,d,u,gn,o,a,l)}_checkForSnappingCandidateAlongProjectedRay(e,t,i,s,r,o,a,l){var _;const{spatialReference:c,pointer:u}=l,d=oe(Rt,o,s),p=Ve(r,d)/Fe(r),g=Ae(Rt,s,r,p),v=he(U(g[0],g[1],o[2]));if(we(a,N(v,c,$,this.view))>this.squaredProximityThreshold(u)||this.isVertical(v,s,l)||this.isVertical(s,i,l))return;const S=T(y(),s,r,Math.sign(p));t.push(new Jt({targetPoint:v,constraint:new Un(s,S),previousVertex:i,otherVertex:s,otherVertexType:be.CENTER,selfSnappingType:e,isDraped:((_=l.elevationInfo)==null?void 0:_.mode)==="on-the-ground"}))}}function pr(n,e,t,i,s){fr(n,e,t,i,s)||gr(n,e,t)}function fr(n,e,t,i,{spatialReference:s}){const r=Ce(e,t,s,s);if(r==null)return!1;const o=Ce(t,i,s,s);if(o==null)return!1;const a=Math.sign(Rn.shortestSignedDiff(r,o))*Math.PI*.5,l=Ee(r+a,"radians","geographic"),c=y(),u=Mn(t,i,s);return u!=null&&(ii(c,t,s,Nn(u,"meters"),l,"geodesic"),Ie(n,c,t),!0)}function gr(n,e,t){const i=oe(Rt,t,e);Z(n,i[1],-i[0],0)}const Rt=G(),gn=y();class oi extends Re{constructor({targetPoint:e,point1:t,point2:i,isDraped:s}){super(e,new Zn(Ki(y(),t,i,.5),.5*Mt(t,i)),s,b.SELF),this._p1=t,this._p2=i}get hints(){return[new Q(D.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new Q(D.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new ei(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}}let yr=class extends ut{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=[],r=i.vertices.length;if(t.editGeometryOperations.data.type!=="polygon"||r<2)return s;const{view:o}=this,a=i.vertices[0],l=i.vertices[r-1],c=L(a.pos,o,t),u=L(l.pos,o,t);return this._processCandidateProposal(c,u,e,t,s),s}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<2||t.editGeometryOperations.data.type==="polyline"&&(s.index===0||s.index===r.vertices.length-1))return i;const{view:o}=this,a=L(s.leftEdge.leftVertex.pos,o,t),l=L(s.rightEdge.rightVertex.pos,o,t);return this._processCandidateProposal(a,l,e,t,i),i}_processCandidateProposal(e,t,i,s,r){var g;if(!this.exceedsShortLineThreshold(e,t,s))return;const o=xn(yn,e,t,.5),a=.5*Mt(e,t),l=rs(yn,i,o,a),c=he(U(l[0],l[1],i[2])),{spatialReference:u,pointer:d}=s,p=N(i,u,$,this.view);if(we(p,N(c,u,$,this.view))<this.squaredProximityThreshold(d)){if(this.isVertical(e,c,s)||this.isVertical(c,t,s))return;r.push(new oi({targetPoint:c,point1:e,point2:t,isDraped:((g=s.elevationInfo)==null?void 0:g.mode)==="on-the-ground"}))}}};const yn=G();let xe=class extends Te{constructor(n){super(n),this.updating=!1,this._snappers=new Se,this._domain=b.SELF}initialize(){this._snappers.push(new ur(this.view,this.options),new rr(this.view,this.options),new hr(this.view,this.options),new yr(this.view,this.options))}set options(n){this._set("options",n);for(const e of this._snappers)e.options=n}async fetchCandidates(n,e,t){if(!(e&this._domain&&this.options.effectiveSelfEnabled))return[];const i=[];for(const s of this._snappers.items)for(const r of s.snap(n,t))i.push(r);return Yt(n,i),i}};h([f({readOnly:!0})],xe.prototype,"updating",void 0),h([f({constructOnly:!0})],xe.prototype,"view",void 0),h([f()],xe.prototype,"options",null),xe=h([ge("esri.views.interactive.snapping.SelfSnappingEngine")],xe);function vr(n,e){return[new xe({view:n,options:e}),new re({view:n,options:e,spatialReference:n.spatialReference})]}class Kt extends ct{constructor(e,t,i=b.ALL){super(t,i),this.intersectionPoint=e}equals(e){return e instanceof Kt&&w(this.intersectionPoint,e.intersectionPoint)}}class Ge extends Re{constructor(e,t,i,s){super(e,new Pe(e),s,b.ALL),this.first=t,this.second=i}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new Kt(this.targetPoint,this.isDraped,this.domain)]}}let B=class extends Qi.EventedMixin(Te){constructor(n){super(n),this.options=new An,this.snappingEnginesFactory=vr,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=ae.MAIN}initialize(){this.addHandles([de(()=>{const{effectiveFeatureEnabled:n,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:i}=this.options;return{effectiveFeatureEnabled:n,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:i}},()=>{this.doneSnapping(),this.emit("changed")},xt),de(()=>this.options,n=>{for(const e of this._engines)e.options=n},xt),de(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:n,snappingEnginesFactory:e})=>this._recreateEngines(n,e),Xe)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(n=>n.updating)}_recreateEngines(n,e){if(this._destroyEngines(),!n)return;const{view:t,options:i}=this;this._engines=e(t,i)}_destroyEngines(){for(const n of this._engines)n.destroy();this._engines=[]}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:n,touchSensitivityMultiplier:e}=this.options,t=n*e;return t*t}snap(n){return Er(n)?this._snapMultiPoint(n):this._snapSinglePoint(n)}update(n){const{point:e,context:t}=n;this._removeVisualization();const i=this._currentMainCandidate;if(i==null)return e;const s=this._selectUpdateInput(n);if(s==null)return e;const{spatialReference:r}=t,o=en(s,r);if(o==null)return e;const{view:a}=this,{elevationInfo:l,visualizer:c}=t,u=[],d=Me(o,a,l),p=i.constraint.closestTo(d);if(!this._arePointsWithinScreenThreshold(d,p,t)||!_t(i,t.drawConstraints))return this._resetSnappingState(),e;i.targetPoint=he(p),u.push(...i.hints);for(const g of this._currentOtherActiveCandidates)_t(g,t.drawConstraints)&&(g.targetPoint=he(p),u.push(...g.hints));return c!=null&&this.addHandles(c.draw(u,{spatialReference:r,elevationInfo:mr(t),view:a,selfSnappingZ:t.selfSnappingZ}),St),sn(p,a,e,t)}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:n,scenePoint:e}){switch(this._currentSnappedType){case ae.MAIN:return n;case ae.SCENE:return e}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=ae.MAIN}_removeVisualization(){this.removeHandles(St)}async _snapSinglePoint({point:n,context:e,signal:t}){const{view:i}=this,{elevationInfo:s}=e,r=Me(n,i,s),o=await this._fetchCandidates(r,b.ALL,e,t);return this._createSnapResult(r,ae.MAIN,o,i,n,e,t)}async _snapMultiPoint({point:n,scenePoint:e,context:t,signal:i}){const{view:s}=this,{coordinateHelper:r,elevationInfo:o,spatialReference:a}=t;await es(e.spatialReference,a);const l=en(e,a),c=Me(l,s,o),u=await this._fetchCandidates(c,b.FEATURE,t,i);if(u.length>0){const g=await this._fetchCandidates(c,b.SELF,t,i);return this._createSnapResult(c,ae.SCENE,[...u,...g],s,l,t,i)}const d=Me(n,s,o),p=await this._fetchCandidates(d,b.SELF,t,i);return this._createSnapResult(d,ae.MAIN,p,s,{z:r.hasZ()&&n.hasZ?n.z??0:void 0,m:r.hasM()&&n.hasM?n.m??0:void 0},t,i)}async _fetchCandidates(n,e,t,i){return(await Promise.all(this._engines.map(s=>s.fetchCandidates(n,e,t,i)))).flat()}_createSnapResult(n,e,t,i,s,r,o){return{get valid(){return!ts(o)},apply:()=>{const{spatialReference:a}=r,{snappedPoint:l,hints:c}=this._processCandidates(n,e,t,r);return this._removeVisualization(),r.visualizer!=null&&this.addHandles(r.visualizer.draw(c,{spatialReference:a,elevationInfo:$,view:i,selfSnappingZ:r.selfSnappingZ}),St),sn(l,i,s,r)}}}_processCandidates(n,e,t,i){if(t.length<1)return this.doneSnapping(),{snappedPoint:n,hints:[]};this._currentSnappedType!==e&&this._resetSnappingState(),Yt(n,t);const s=this._currentMainCandidate;if(s!=null){const r=_r(s,t);if(r>=0){if(!(t[r]instanceof Ge))return this._intersectWithOtherCandidates(r,t,n,e,i);if(this._arePointsWithinScreenThreshold(n,s.targetPoint,i))return this._updateSnappingCandidate(s,e,t,i)}}return this._intersectWithOtherCandidates(0,t,n,e,i)}_intersectWithOtherCandidates(n,e,t,i,s){const{coordinateHelper:r}=s,o=e[n],a=[];for(let l=0;l<e.length;++l){if(l===n)continue;const c=e[l],u=o.constraint.intersect(c.constraint);if(u)for(const d of u.closestPoints(o.targetPoint))a.push([new Ge(he(d),o,c,c.isDraped),this._squaredScreenDistance(t,d,r)])}return a.length>0&&(a.sort((l,c)=>l[1]-c[1]),a[0][1]<this._squaredPointProximityThreshold(s.pointer))?this._updateSnappingCandidate(a[0][0],i,e,s):_t(o,s.drawConstraints)?this._updateSnappingCandidate(o,i,e,s):{snappedPoint:t,hints:[]}}_updateSnappingCandidate(n,e,t,i){this.doneSnapping(),this._currentMainCandidate=n,this._currentSnappedType=e;const s=this._currentMainCandidate.targetPoint,r=[];r.push(...n.hints);for(const o of t){if(n instanceof Ge){if(o.constraint.equals(n.first.constraint)||o.constraint.equals(n.second.constraint))continue}else if(o.constraint.equals(n.constraint))continue;const a=o.constraint.closestTo(s);this._squaredScreenDistance(a,s,i.coordinateHelper)<Sr()&&(o.targetPoint=s,this._currentOtherActiveCandidates.push(o),r.push(...o.hints))}return{snappedPoint:s,hints:r}}_squaredPointProximityThreshold(n){return n==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}_arePointsWithinScreenThreshold(n,e,t){return this._squaredScreenDistance(n,e,t.coordinateHelper)<this._squaredPointProximityThreshold(t.pointer)}_squaredScreenDistance(n,e,t){return we(this._toScreen(n,t),this._toScreen(e,t))}_toScreen(n,e){return N(n,e.spatialReference,$,this.view)}get test(){}};var ae;h([f({constructOnly:!0})],B.prototype,"view",void 0),h([f()],B.prototype,"options",void 0),h([f({readOnly:!0})],B.prototype,"updating",null),h([f()],B.prototype,"snappingEnginesFactory",void 0),h([f()],B.prototype,"_engines",void 0),h([f()],B.prototype,"_squaredMouseProximityThreshold",null),h([f()],B.prototype,"_squaredTouchProximityThreshold",null),B=h([ge("esri.views.interactive.snapping.SnappingManager")],B),function(n){n[n.MAIN=0]="MAIN",n[n.SCENE=1]="SCENE"}(ae||(ae={}));const St="visualization-handle";function Sr(){return K.satisfiesConstraintScreenThreshold*K.satisfiesConstraintScreenThreshold}function _t(n,e){return!e||e.direction==null&&e.distance==null||!(n instanceof Kn||n instanceof Qn||n instanceof ni||n instanceof ai||n instanceof oi)&&(!(n instanceof Jt)||e.direction==null&&n.selfSnappingType===ue.LastVertex)}function _r(n,e){return n instanceof Ge?Et(e,n.first)>=0&&Et(e,n.second)>=0?0:-1:Et(e,n)}function Et(n,e){let t=-1;for(let i=0;i<n.length;++i)if(e.constraint.equals(n[i].constraint)){t=i;break}return t}function Er(n){return n.scenePoint!=null}function mr({coordinateHelper:n,elevationInfo:e}){return n.hasZ()?$:e}const Ze=new Map;function Kr(n){if(!Ze.has(n)){const i=us(n,{distance:10}),s=xr(n,i.options);Ze.set(n,{referenceCount:0,snappingManager:s,remove:()=>{i.remove(),s.destroy()}})}const e=Ze.get(n);e.referenceCount++;const t=ns(()=>wr(n,e));return{snappingManager:e.snappingManager,...t}}function wr(n,e){e.referenceCount--,e.referenceCount>0||is(()=>{e.referenceCount===0&&(e.remove(),Ze.delete(n))})}function xr(n,e){return new B({view:n,options:e,snappingEnginesFactory:(t,i)=>[new re({view:n,spatialReference:n.spatialReference,options:i})]})}export{k as A,Bt as B,ms as C,Un as D,b as E,tr as F,pn as G,Wr as H,bs as I,z as L,ii as M,qr as N,er as R,Vr as T,Br as U,Ls as Z,Qn as a,Fr as b,Kr as c,U as d,Q as e,Yt as f,Pe as g,cr as h,ei as i,Dr as j,K as k,Ir as l,Cr as m,Xt as n,Kt as o,he as p,D as q,Kn as r,ct as s,Me as t,I as u,un as v,sn as w,Zn as x,Or as y,nt as z};
