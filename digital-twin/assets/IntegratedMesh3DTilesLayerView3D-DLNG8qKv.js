import{cw as Re,kY as ge,nr as N,j_ as U,jc as T,bd as Fe,bb as je,pg as He,ng as Ve,R as ke,ph as Le,dn as Be,cT as be,F as J,pi as De,e as fe,P as Ne,pj as ye,u as _e,fc as Ge,l4 as we,pk as $e,dp as ze,bN as We,cP as qe,eG as Je,jg as Xe,bY as ve,pl as Ye,kt as Ke,jQ as xe,pm as Qe,pn as X,po as Ze,pp as et,ay as Y,gi as tt,pq as st,pr as it,ps as Te,pt as rt,jq as at,aW as nt,jO as ot,bF as V,pu as lt,bP as ct,bo as dt,pv as ht,pw as ut,px as mt,cS as K,jb as pt,nq as gt,nw as bt,nx as ft,km as Q,nz as yt,nA as _t,c0 as k,py as wt,pz as vt,pA as xt,pB as Ce,pC as Pe,k as Me,r as I,m as L,a as Tt}from"./index-Bmji7YKu.js";import{x as Ct,n as Pt,t as Mt,i as Et}from"./Transform-C4NOEJjn.js";import{o as E,i as Z,l as B,r as O,t as g,m as Ot,d as Ut,S as Ee,e as C,g as ee,a as S}from"./ILyr3DWasmPerSceneView-QwgNPJGT.js";import{l as At}from"./LayerView3D-CQaKjHif.js";import{s as It}from"./RenderTexture-Db3cNbW9.js";import{y as St}from"./LayerView-BcbGCHYn.js";class Rt extends Re{constructor(e,d,r,u,n,a,h){super(e,0,0,0,d),this.nodesCached=r,this.vboMB=u,this.textureMB=n,this.vboMBCached=a,this.textureMBCached=h}}const Ft={[E.Points]:null,[E.Lines]:null,[E.LineStrip]:null,[E.Triangles]:ge.TRIANGLES,[E.TriangleStrip]:ge.TRIANGLE_STRIP,[E.NotSet]:null},Oe={[Z.Opaque]:N.Opaque,[Z.Mask]:N.Mask,[Z.Blend]:N.Blend},jt={[B.Back]:U.Back,[B.Front]:U.Front,[B.None]:U.None,[B.NotSet]:U.Back},Ht={[O.WrapYBit]:{s:T.CLAMP_TO_EDGE,t:T.REPEAT},[O.WrapXBit]:{s:T.REPEAT,t:T.CLAMP_TO_EDGE},[O.WrapXy]:{s:T.REPEAT,t:T.REPEAT},[O.None]:{s:T.CLAMP_TO_EDGE,t:T.CLAMP_TO_EDGE},[O.NotSet]:{s:T.CLAMP_TO_EDGE,t:T.CLAMP_TO_EDGE}},Vt={[g.U8]:1,[g.I8]:1,[g.U16]:2,[g.I16]:2,[g.U32]:4,[g.I32]:4,[g.F32]:4,[g.F64]:8,[g.Utf8String]:1,[g.NotSet]:1};class kt{constructor(e){this.layerUid=[],this.type=Fe.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,d,r,u,n,a){const h=e.results,v=e.options.store===je.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const y=this.layerView.view._stage.renderView.componentObjectCollection,p=new He(a??!1,e.options.normalRequired);this.layerView.objects.forEach(o=>{o.visible&&o.intersectionGeometry&&y.intersect(o,r,u,e.tolerance,null,p,(l,s,c,b)=>{if(s>=0){if(d!=null&&!d(r,u,s))return;const m=w=>{const _=new Le(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));w.set(this.type,_,s,c)};if(this.isGround&&(h.ground.dist==null||s<h.ground.dist)&&m(h.ground),e.options.isFiltered)return;if((h.min.dist==null||s<h.min.dist)&&m(h.min),(h.max.dist==null||s>h.max.dist)&&m(h.max),v){const w=Ve(e.ray);m(w),e.results.all.push(w)}}})})}_createTiles3DGraphic(e,d){return new ke({layer:e,sourceLayer:e,attributes:d})}}var f;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(f||(f={}));class Lt{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}get usedMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}get cachedMemory(){return this.usedMemory}}function D(t){return Math.round(t/1048.576)/1e3}let M=class extends At(St){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=Be.WithoutRasterImage,this._applySSAO=!be("disable-feature:im-ssao"),this._shadeNormals=!!be("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(f.Error),this._dbg(f.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new J("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const t=De(this).then(e=>{this._intersectionHandler=new kt(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,r=>this._slicePlaneEnabledChange(r)),this._elevationProvider=new Ct({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const d=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,r=>this._onRemoveFromCache(r));this._memCache=d,this.addHandles([fe(()=>this.layer.elevationInfo,r=>this._elevationInfoChanged(r))]),this._suspendedHandle=fe(()=>this.suspended,r=>{var u;return(u=this._wasm)==null?void 0:u.setEnabled(this,!r)},Ne)}).catch(e=>{if(ye(this),this._wasmLayerId=-1,e===Ot)throw new J("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===Ut)throw new J("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(f.VerboseAPI,"Tiles3DLayerView3D destroy() called"),ye(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=_e(this._memCache),this._updatingHandles=_e(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??(this._visibleGeometryChangedSchedulerHandle=Ge(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{const d=this._collection.getMaterial(e);d.commonMaterialParameters.hasSlicePlane=t,d.commonMaterialParameters.cullFace=t?U.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){var e;(e=this._wasm)==null||e.setLayerOffset(this,we(t))}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get _wasm(){return $e(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.usedMemory)}),t}get unloadedMemory(){return 0}get cachedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.usedMemory)}),t}get visibleAtCurrentScale(){return ze(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let t=0,e=0,d=0,r=0,u=0,n=0;return this._lyrHandleToObjects.forEach(a=>{a.isVisible?(t+=a.texMemoryUsage,e+=a.vboMemoryUsage,u++):(d+=a.texMemoryUsage,r+=a.vboMemoryUsage,n++)}),new Rt(this.usedMemory,u,n,D(e),D(t),D(r),D(d))}_canProjectWithoutEngine(){var t,e;if(this.view.state.viewingMode===We.Local){const d=(t=this.view.renderSpatialReference)!=null&&t.isWebMercator?3857:((e=this.view.renderSpatialReference)==null?void 0:e.wkid)??-1;if(d!==3857&&d!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return we(this.layer.elevationInfo)}get elevationRange(){const t=this.fullExtent;return t!=null&&t.zmin&&(t!=null&&t.zmax)?new qe(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){const t=this._wasm;return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){var s;const e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");const d=Je(e.desc.origin),r=new Array,u=new Map,n=new Lt;n.handle=t.handle,this._lyrHandleToObjects.set(t.handle,n);const a=this.view.basemapTerrain.spatialReference;let h,v;if(this.view.viewingMode==="global"){const c=ve();Xe(Ye,d,c,a),h=Ke(xe(),c),v=Qe(xe(),h)}else h=X,v=X;const y=ve();Ze(y,y,d);const p=et(Y(),y);let o=null;const l=Y();if(e.desc.obb){const c=e.desc.obb.quaternion;o=new tt(e.desc.obb.center,e.desc.obb.halfSize,st(c[0],c[1],c[2],c[3]))}for(let c=0;c<e.desc.prims.length;c++){const b=e.desc.prims[c];if(this._dbg(f.VerboseAPI,JSON.stringify(b)),Ft[b.ptype]==null||e.data==null){this._dbg(f.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+b.ptype+"). Skipping primitive.");continue}const m=(s=e.desc)!=null&&s.materials&&b.materialId!=null?e.desc.materials[b.materialId]:null,w=m!=null?m.lightingModel:Ee.Unlit,{positionView:_,positionAttr:P,normalsView:Ue,normalsAttr:G,colorAttr:R,texCoord0Attr:F,indicesView:A}=this.getBufferViews(b,e.data.buffer,h);if(P==null||_==null||A==null)continue;const te=new it(R!=null,F!=null?Te.Default:Te.None,Ue!=null,this._shadeNormals,this._applySSAO),Ae=P.data.length/P.size,$=(i,x)=>!i||i.data.length/i.size===Ae||(this._dbg(f.Error,`${x} !== numPos. Skipping primitive.`),!1);if(!$(F,"numTexcoord")||!$(R,"numColors")||!$(G,"normals"))continue;const se=rt(te);if(o!=null?o=o.clone():(o=at(P),nt(l,o.center,d),o.center=l),h!==X)for(let i=0;i<_.count;i++)_.getVec(i,l),ot(l,l,h),_.setVec(i,l);const z=se.createBuffer(P.data.length),j=new Map([[V.POSITION,P]]);F!=null&&j.set(V.UV0,F),R!=null&&j.set(V.COLOR,R),G!=null&&j.set(V.NORMALCOMPRESSED,G),j.forEach((i,x)=>{i!=null&&lt(x,i,null,null,z,0)});const Ie=new Uint32Array([0,A.typedBuffer.length]),Se={vertices:{data:z.buffer,count:z.byteLength/se.stride,layoutParameters:te},positionData:{positions:_.typedBuffer,indices:A.typedBuffer},indices:A.typedBuffer,componentOffsets:Ie};n.cpuMemoryUsage+=_.count,n.cpuMemoryUsage+=A.count;const ie=this.view.renderSpatialReference,W=Y(),q=[1,1,1];Pt(p,ie,q,a)||this._dbg(f.Error,"Unsupported coordinate system for IM overlay"),ct(p,ie,W,a);const H=this._collection.createObject(new Mt(dt(W[0],W[1],q[0],q[1]),new Et(p,v),o,Se));m&&this._collection.updateMaterial(H,i=>{i.baseColor=m.baseColorFactor,i.usePBR=w===Ee.Pbr,i.hasParametersFromSource=!1,i.baseColorTexture=this._getTexture(m.baseColorTex,e,u),i.usePBR&&(i.mrrFactors=[m.metallicFactor,m.roughnessFactor,0],i.emissiveFactor=m.emissiveFactor??[0,0,0],i.metallicRoughnessTexture=this._getTexture(m.metalTex,e,u),i.emissionTexture=this._getTexture(m.emissiveTex,e,u),i.occlusionTexture=this._getTexture(m.occlusionTex,e,u),i.normalTexture=this._getTexture(m.normalTex,e,u)),i.objectOpacity=0,i.alphaDiscardMode=N.Mask;const x=[];i.baseColorTexture&&x.push(i.baseColorTexture.loadPromise),i.usePBR&&i.metallicRoughnessTexture&&x.push(i.metallicRoughnessTexture.loadPromise),i.usePBR&&i.emissionTexture&&x.push(i.emissionTexture.loadPromise),i.usePBR&&i.occlusionTexture&&x.push(i.occlusionTexture.loadPromise),i.usePBR&&i.normalTexture&&x.push(i.normalTexture.loadPromise);const re=Promise.all(x);r.push(re),re.then(()=>{var ae,ne,oe,le,ce,de,he,ue,me,pe;i.alphaDiscardMode=Oe[m.alphaMode],i.objectOpacity=1,n.texMemoryUsage+=((ne=(ae=i.baseColorTexture)==null?void 0:ae.glTexture)==null?void 0:ne.usedMemory)||0,i.usePBR&&(n.texMemoryUsage+=((le=(oe=i.metallicRoughnessTexture)==null?void 0:oe.glTexture)==null?void 0:le.usedMemory)||0,n.texMemoryUsage+=((de=(ce=i.emissionTexture)==null?void 0:ce.glTexture)==null?void 0:de.usedMemory)||0,n.texMemoryUsage+=((ue=(he=i.occlusionTexture)==null?void 0:he.glTexture)==null?void 0:ue.usedMemory)||0,n.texMemoryUsage+=((pe=(me=i.normalTexture)==null?void 0:me.glTexture)==null?void 0:pe.usedMemory)||0)}),i.commonMaterialParameters.doubleSided=m.isDoubleSided,i.commonMaterialParameters.cullFace=m.faceCulling?jt[m.faceCulling]:U.Back,this._initialCullFace.set(H,i.commonMaterialParameters.cullFace),i.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,i.componentParameters.castShadows=ht.All,i.textureAlphaCutoff=m.alphaCutoff??ut,i.alphaDiscardMode=Oe[m.alphaMode],i.isIntegratedMesh=!0,i.polygonOffsetEnabled=!1,i.hasOccludees=!1,i.ellipsoidMode=mt(this.view.spatialReference)}),n.components.push(H),n.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(H)}if(await Promise.all(r),u.forEach(c=>{n.textures.push(c)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${n.handle}`,n),{memUsageBytes:n.usedMemory}}freeRenderable(t){const e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(d=>{this._stage.remove(d)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,d){if(this._memCache){for(let r=0;r<d;++r){const u=t[r],n=e[r];if(!n)continue;const a=this._lyrHandleToObjects.get(u);a&&(this._visibleGeometryChanged(),a.isVisible=n,a.components.forEach(h=>{this._collection.setObjectVisibility(h,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(h))}),this._memCache.pop(`${u}`))}for(let r=0;r<d;++r){const u=t[r],n=e[r];if(n)continue;const a=this._lyrHandleToObjects.get(u);a&&(this._visibleGeometryChanged(),a.isVisible=n,a.components.forEach(h=>{this._collection.setObjectVisibility(h,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(h))}),this._memCache.put(`${u}`,a))}}}_getTexture(t,e,d){var u,n;let r=null;if(t&&((u=e.desc)!=null&&u.images)&&((n=e.data)!=null&&n.buffer)){const a=e.desc.images[t==null?void 0:t.imageId];if(r=d.get(a),!r&&a){const h=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,v=!!a.mipCount||h>1,y=Ht[t.wrapMode??O.None];let p=a.alpha?4:3;const o=new Uint8Array(e.data.buffer,a.data.byteOffset,a.data.byteCount);let l=null,s=null,c=null;switch(a.format){case C.Raw:a.pixelFormat===ee.R8?(l=o,p=1,s=""):a.pixelFormat===ee.Rgb8?(l=o,p=3,s=""):a.pixelFormat===ee.Rgba8&&(l=o,p=4,s="");break;case C.Dxt1:l=o,p=3,s=K.DDS_ENCODING;break;case C.Dxt5:l=o,p=4,s=K.DDS_ENCODING;break;case C.Basis:l=o,p=3,s=K.KTX2_ENCODING;break;case C.Png:s="image/png",c=document.createElement("img");break;case C.Jpeg:s="image/jpeg",c=document.createElement("img");break;case C.Etc2:s="image/ktx",c=document.createElement("img");break;case C.Astc:this._dbg(f.Error,"Astc texture not supported");break;case C.Pvrtc:this._dbg(f.Error,"Pvrtc texture not supported")}if(c&&s){const b=new Blob([o],{type:s});c.src=URL.createObjectURL(b),l=c}l&&s!=null&&(r=new pt(l,{mipmap:v,maxAnisotropy:h,encoding:s,wrap:y,components:p,noUnpackFlip:!0,width:a.mip0Width,height:a.mip0Height}),this._stage.add(r),d.set(a,r))}}return r?new It(this.view._stage.renderView.textures,r.id):null}getBufferViews(t,e,d){let r,u,n,a,h,v,y,p=null;for(let o=0;o<t.atrbs.length;o++){const l=t.atrbs[o],s=l.view,c=void 0,b=s.byteOffset+s.byteCount,m=s.byteCount/Vt[s.type],w=[...Array(m).keys()].map(_=>_);try{switch(l.sem){case S.Position:s.ncomp!==3||s.type!==g.F32?this._dbg(f.Error,"[Unsupported Feature] Unsupported view for Position ("+s+")"):(r=new Q(e,s.byteOffset,c,b),u=new k(r.typedBuffer,w,3));break;case S.Normal:if(s.ncomp!==3||s.type!==g.F32)this._dbg(f.Error,"[Unsupported Feature] Unsupported view for Normal ("+s+")");else{const _=new Q(e,s.byteOffset,c,b),P=vt(_.typedBuffer,d);h=new xt(P),v=new k(h.typedBuffer,w,2)}break;case S.TexCoord:s.ncomp!==2||s.type!==g.F32?this._dbg(f.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+s+")"):a===void 0&&(a=new k(new wt(e,s.byteOffset,c,b).typedBuffer,w,2));break;case S.Color:s.ncomp===4?(s.type===g.F32&&(p=new gt(e,s.byteOffset,c,b)),s.type===g.U8&&(p=new bt(e,s.byteOffset,c,b)),s.type===g.U16&&(p=new ft(e,s.byteOffset,c,b))):s.ncomp===3&&(s.type===g.F32&&(p=new Q(e,s.byteOffset,c,b)),s.type===g.U8&&(p=new yt(e,s.byteOffset,c,b)),s.type===g.U16&&(p=new _t(e,s.byteOffset,c,b))),p==null?this._dbg(f.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+s+")"):n=new k(p.typedBuffer,w,s.ncomp);break;case S.FeatureIndex:break;default:this._dbg(f.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+l.sem+"). Skipping vertex attribute.")}}catch(_){this._dbg(f.VerboseAPI,"Error Creating buffer ("+_+"). Skipping vertex attribute.")}}if(t.index){const o=t.index.view,l=void 0,s=o.byteOffset+o.byteCount;switch(t.index.view.type){case g.U16:y=new Pe(e,o.byteOffset,l,s);break;case g.U32:y=new Ce(e,o.byteOffset,l,s);break;case g.U8:default:this._dbg(f.Error,"[Unsupported Feature] index type not supported ("+o.type+").")}}if(y==null&&r!=null){const o=r.count;if(o<65535){const l=new Uint16Array(o);y=new Pe(l)}else{const l=new Uint32Array(o);y=new Ce(l)}for(let l=0;l<o;l++)y.set(l,l)}return{positionView:r,positionAttr:u,colorAttr:n,texCoord0Attr:a,indicesView:y,normalsView:h,normalsAttr:v}}_onRemoveFromCache(t){var e;(e=this._wasm)==null||e.onRenderableEvicted(this,t.handle,t.usedMemory),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===f.Error?Me.getLogger(this).error(e):Me.getLogger(this).warn(e))}};I([L()],M.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),I([L()],M.prototype,"layer",void 0),I([L({readOnly:!0})],M.prototype,"visibleAtCurrentScale",null),I([L()],M.prototype,"elevationOffset",null),M=I([Tt("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],M);const Wt=M;export{Wt as default};
