import{r as s,m as l,a as c,F as v,o as D,a9 as E,as as u,aM as _,dj as I}from"./index-BGUxYM9l.js";import{N as b}from"./DynamicLayerView3D-DWMGl_CT.js";import{i as H}from"./timeSupport-7Oh1XvYN.js";import{O,j as F}from"./rasterProjectionHelper-sWDWnxk3.js";import{p as P}from"./popupUtils-CjabIxVP.js";import"./LayerView3D-Ctou4QXc.js";import"./projectExtentUtils-CzAs-fv0.js";import"./geometryServiceUtils-6cYxqj0J.js";import"./ImageMaterial.glsl-PPMg3_TA.js";import"./DefaultLayouts-JfgogcHt.js";import"./TriangleMaterial-DQ7DFKzb.js";import"./LayerView-BX05mm1U.js";import"./RefreshableLayerView-QzUKwRno.js";const $=e=>{let t=class extends e{constructor(){super(...arguments),this.view=null}get timeExtent(){var a;return H(this.layer,(a=this.view)==null?void 0:a.timeExtent,this._get("timeExtent"))}async fetchPopupFeaturesAtLocation(a,i){const{layer:n}=this;if(!a)throw new v("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:n});const{popupEnabled:r}=n,o=P(n,i);if(!r||o==null)return[];const g=await o.getRequiredFields();D(i);const p=new E;p.timeExtent=this.timeExtent,p.geometry=a,p.outFields=g,p.outSpatialReference=a.spatialReference;const{resolution:d,spatialReference:h}=this.view,y=this.view.type==="2d"?new u(d,d,h):new u(.5*d,.5*d,h),{returnTopmostRaster:w,showNoDataRecords:x}=o.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},f={returnDomainValues:!0,returnTopmostRaster:w,pixelSize:y,showNoDataRecords:x,signal:i==null?void 0:i.signal};return n.queryVisibleRasters(p,f).then(R=>R)}async getSourceScale(){return await F(),await this.layer.load(),O(this.layer.serviceRasterInfo,this.view.spatialReference)}canResume(){var a;return!!super.canResume()&&!((a=this.timeExtent)!=null&&a.isEmpty)}};return s([l()],t.prototype,"layer",void 0),s([l()],t.prototype,"suspended",void 0),s([l({readOnly:!0})],t.prototype,"timeExtent",null),s([l()],t.prototype,"view",void 0),t=s([c("esri.views.layers.ImageryLayerView")],t),t};let m=class extends $(b){constructor(){super(...arguments),this.type="imagery-3d",this.redrawDebounced=_(async e=>{this.redraw((t,a)=>this._redrawImage(t,a),e)},2e3)}get highlightOptions(){return null}get pixelData(){return null}initialize(){this.addHandles([I(()=>this.view.basemapTerrain.ready,()=>this._initializeMaximumDataResolution(),{once:!0,initial:!0}),this.layer.on("redraw",()=>this._updatingHandles.addPromise(this.redrawDebounced()))]),this._updatingHandles.add(()=>{var e,t;return(t=(e=this.layer)==null?void 0:e.exportImageServiceParameters)==null?void 0:t.version},()=>{this._updatingHandles.addPromise(this.refreshDebounced())}),this._updatingHandles.add(()=>{var e;return(e=this.layer)==null?void 0:e.renderer},()=>{this._updatingHandles.addPromise(this.refreshDebounced())}),this._updatingHandles.add(()=>this.timeExtent,()=>this._updatingHandles.addPromise(this.refreshDebounced()))}_initializeMaximumDataResolution(){this.maximumDataResolution=this.layer.loaded?this.layer.serviceRasterInfo.pixelSize:null}getFetchOptions(){return{timeExtent:this.timeExtent}}async processResult(e,t,a){t.imageOrCanvasElement?e.image=t.imageOrCanvasElement:(e.image=document.createElement("canvas"),e.pixelData=t.pixelData,await this._redrawImage(e,a))}async _redrawImage(e,t){if(!(e.image instanceof HTMLCanvasElement)||e.pixelData==null)throw new Error;const a=e.image,i=a.getContext("2d"),n=await this.layer.applyRenderer(e.pixelData,{signal:t}),r=this.layer.applyFilter(n).pixelBlock;if(r==null)throw new Error;a.width=r.width,a.height=r.height;const o=i.createImageData(r.width,r.height);o.data.set(r.getAsRGBA()),i.putImageData(o,0,0)}highlight(e){throw new Error("Not implemented")}};s([l()],m.prototype,"highlightOptions",null),s([l()],m.prototype,"pixelData",null),m=s([c("esri.views.3d.layers.ImageryLayerView3D")],m);const G=m;export{G as default};
