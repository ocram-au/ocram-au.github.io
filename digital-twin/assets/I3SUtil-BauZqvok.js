import{eS as B,bY as P,jj as J,eb as Y,ay as b,N as H,jk as V,jl as Z,F as S,ar as K,jm as Q,c$ as X,cy as ee,dJ as D,jn as te,eY as ne,jo as re,jp as _,jq as ae,df as U,jr as oe,a9 as se,dh as L,aV as ie,bP as O,hd as I,js as N,j9 as le,gi as ce,a_ as ue,aU as fe,jt as de}from"./index--YEV5yv0.js";import{I as he}from"./I3SBinaryReader-DjvcouKS.js";function pe(e,t,n,r,a){const o=n==="east-north-up"?B(e):ye(e,t,r),s=P();return J(r,o,s,a),s}const A=1,W=5-A;function ye(e,t,n){const r=b(),a=e[3],o=2**(Math.ceil(Math.log(a)*Math.LOG2E/W)*W+A);if(n.isGeographic){const c=o/Y(n).radius*180/Math.PI,l=Math.round(e[1]/c),p=Math.max(-90,Math.min(90,l*c)),f=c/Math.cos((Math.abs(p)-c/2)/180*Math.PI),y=Math.round(e[0]/f)*f;r[0]=y,r[1]=p}else{const c=Math.round(e[0]/o),l=Math.round(e[1]/o);r[0]=c*o,r[1]=l*o}const s=e[2]+t,i=Math.round(s/o);return r[2]=i*o,r}function G(e){return e?parseInt(e.slice(e.lastIndexOf("/")+1),10):void 0}function Oe(e){var t;if(X("disable-feature:i3s-draco")||!e)return!1;for(const n of e)for(const r of n.geometryBuffers)if(((t=r.compressedAttributes)==null?void 0:t.encoding)==="draco")return!0;return!1}function We(e,t,n,r){n.traverse(t,a=>{const o=a.serviceMbsInIndexSR;return(o!=null&&me(e,o))!==w.OUTSIDE&&(r(a),!0)})}function Fe(e,t,n){let r=0,a=0;for(let o=0;o<t.length&&r<e.length;o++)e[r]===t[o]&&(n(o)&&(e[a]=e[r],a++),r++);e.length=a}function qe(e,t,n){let r=0,a=0;for(;r<n.length;)Q(e,n[r])>=0===t&&(n[a]=n[r],a++),r++;n.length=a}function Pe(e,t){if(t.rotationScale[1]===0&&t.rotationScale[2]===0&&t.rotationScale[3]===0&&t.rotationScale[5]===0&&t.rotationScale[6]===0&&t.rotationScale[7]===0)return T[0]=(e[0]-t.position[0])/t.rotationScale[0],T[1]=(e[1]-t.position[1])/t.rotationScale[4],T[2]=(e[2]-t.position[0])/t.rotationScale[0],T[3]=(e[3]-t.position[1])/t.rotationScale[4],T}const T=U();var w;function me(e,t){const n=t[0],r=t[1],a=t[3],o=e[0]-n,s=n-e[2],i=e[1]-r,c=r-e[3],l=Math.max(o,s,0),p=Math.max(i,c,0),f=l*l+p*p;return f>a*a?w.OUTSIDE:f>0?w.INTERSECTS_CENTER_OUTSIDE:-Math.max(o,s,i,c)>a?w.INSIDE:w.INTERSECTS_CENTER_INSIDE}function ge(e,t,n){const r=[],a=n==null?void 0:n.missingFields,o=n==null?void 0:n.originalFields;for(const s of e){const i=s.toLowerCase();let c=!1;for(const l of t)if(i===l.name.toLowerCase()){r.push(l.name),c=!0,o&&o.push(s);break}!c&&a&&a.push(s)}return r}async function Ke(e,t,n,r,a,o){if(t.length===0)return[];const s=e.attributeStorageInfo;if(e.associatedLayer!=null)try{return await Se(e.associatedLayer,t,n,r,o)}catch(i){if(e.associatedLayer.loaded)throw i}if(s){const i=be(t,n,a);if(i==null)throw new S("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const c=e.parsedUrl.path;return(await Promise.all(i.map(l=>we(c,s,l.node,l.indices,r,e.apiKey,e.customParameters,o).then(p=>{for(let f=0;f<l.graphics.length;f++){const y=l.graphics[f],m=p[f];if(y.attributes)for(const u in y.attributes)u in m||(m[u]=y.attributes[u]);y.attributes=m}return l.graphics})))).flat()}throw new S("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function be(e,t,n){const r=new Map,a=[],o=n();for(const s of e){const i=s.attributes[t];for(let c=0;c<o.length;c++){const l=o[c],p=l.featureIds.indexOf(i);if(p>=0){let f=r.get(l.node);f||(f={node:l.node,indices:[],graphics:[]},a.push(f),r.set(l.node,f)),f.indices.push(p),f.graphics.push(s);for(let y=c;y>0;y--)o[y]=o[y-1];o[0]=l;break}}}return a}async function Se(e,t,n,r,a){t.sort((l,p)=>l.attributes[n]-p.attributes[n]);const o=t.map(l=>l.attributes[n]),s=[],i=ge(r,e.fields,{originalFields:s}),c=await z(e,o,i,a);for(let l=0;l<t.length;l++){const p=t[l],f=c[l],y={};if(p.attributes)for(const m in p.attributes)y[m]=p.attributes[m];for(let m=0;m<s.length;m++)y[s[m]]=f[i[m]];p.attributes=y}return t}function z(e,t,n,r){const a=e.capabilities.query.maxRecordCount;if(a!=null&&t.length>a){const s=oe(t,a);return Promise.all(s.map(i=>z(e,i,n,r))).then(i=>i.flat())}const o=new se({objectIds:t,outFields:n,orderByFields:[e.objectIdField]});return e.queryFeatures(o,r).then(s=>{if(s&&s.features&&s.features.length===t.length)return s.features.map(i=>i.attributes);throw new S("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")})}function we(e,t,n,r,a,o,s,i){return Ie(e,t,n.resources.attributes,r,a,o,s,i)}async function Ie(e,t,n,r,a,o,s,i){const c=[];for(const f of t)if(f&&a.includes(f.name)){const y=`${e}/nodes/${n}/attributes/${f.key}/0`;c.push({url:y,storageInfo:f})}const l=await Promise.allSettled(c.map(f=>H(f.url,{responseType:"array-buffer",query:{...s,token:o},signal:i==null?void 0:i.signal}).then(y=>he(f.storageInfo,y.data)))),p=[];for(const f of r){const y={};for(let m=0;m<l.length;m++){const u=l[m];if(u.status==="fulfilled"){const d=u.value;y[c[m].storageInfo.name]=Ee(d,f)}}p.push(y)}return p}(function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",e[e.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",e[e.INSIDE=3]="INSIDE"})(w||(w={}));const Te=-32768,Me=-2147483648;function Ee(e,t){if(!e)return null;const n=e[t];return V(e)?n===Te?null:n:Z(e)?n===Me?null:n:n!=n?null:n}function Re(e){const t=e.store,n=t.indexCRS||t.geographicCRS,r=n===void 0?t.indexWKT:void 0;if(r){if(!e.spatialReference)throw new S("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indexWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new S("layerview:store-spatial-reference-wkt-index-incompatible","The indexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=n?new K(G(n)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function ve(e){const t=e.store,n=t.vertexCRS||t.projectedCRS,r=n===void 0?t.vertexWKT:void 0;if(r){if(!e.spatialReference)throw new S("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new S("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=n?new K(G(n)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function j(e,t,n){if(!ee(e,t))throw D("scene layer",e==null?void 0:e.wkid,t==null?void 0:t.wkid);if(n==="local"&&!xe(e,t))throw D("scene layer",e==null?void 0:e.wkid,t==null?void 0:t.wkid)}function Ae(e,t,n){var r,a,o,s;if(((r=e.serviceUpdateTimeStamp)==null?void 0:r.lastUpdate)!==((a=t.serviceUpdateTimeStamp)==null?void 0:a.lastUpdate)||!n.isEmpty||((o=e.associatedLayer)==null?void 0:o.url)!==((s=t.associatedLayer)==null?void 0:s.url))throw new S("layerview:recycle-failed")}function xe(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}function $e(e,t,n){const r=Re(e),a=ve(e);j(r,t,n),j(a,t,n)}function Ce(e){var t;return(e.geometryType==null||e.geometryType==="triangles")&&(e.topology==null||e.topology==="PerAttributeArray")&&((t=e.vertexAttributes)==null?void 0:t.position)!=null}function Ge(e){var t;if(((t=e.store)==null?void 0:t.defaultGeometrySchema)==null||!Ce(e.store.defaultGeometrySchema))throw new S("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path})}function ze(e,t){$e(e,t.spatialReference,t.viewingMode)}function Ne(e){var t;return e.geometryType!=null&&e.geometryType==="points"&&(e.topology==null||e.topology==="PerAttributeArray")&&(e.encoding==null||e.encoding===""||e.encoding==="lepcc-xyz")&&((t=e.vertexAttributes)==null?void 0:t.position)!=null}function Be(e){var t;if(((t=e.store)==null?void 0:t.defaultGeometrySchema)==null||!Ne(e.store.defaultGeometrySchema))throw new S("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function Je(e,t){j(e.spatialReference,t.spatialReference,t.viewingMode)}function ke(e){return e.type==="simple"||e.type==="class-breaks"||e.type==="unique-value"}function je(e){return e.type==="mesh-3d"}function Ye(e){var n;if(e==null||!ke(e)||(e.type==="unique-value"||e.type==="class-breaks")&&e.defaultSymbol==null)return!0;const t=e.symbols;if(t.length===0)return!0;for(const r of t){if(!je(r)||r.symbolLayers.length===0)return!0;for(const a of r.symbolLayers.items)if(a.type!=="fill"||((n=a.material)==null?void 0:n.color)==null||a.material.colorMixMode!=="replace")return!0}return!1}const He=te({color:[0,0,0,0],opacity:0});class Ue{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function Ve(e){const t=new Ue;let n=!1,r=!1;for(const a of e.symbolLayers.items)if(a.type==="fill"&&a.enabled){const o=a.material,s=a.edges;if(o!=null&&!n){const i=o.color,c=re(o.colorMixMode);t.material=i!=null?{color:[i.r/255,i.g/255,i.b/255],alpha:i.a,colorMixMode:c}:{color:[1,1,1],alpha:1,colorMixMode:_.Multiply},t.castShadows=a.castShadows,n=!0}s==null||r||(t.edgeMaterial=ae(s,{}),r=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:_.Multiply}),t}function Ze(e,t){return(0|e)+(0|t)|0}function Qe(e,t,n,r,a,o,s){if(!o||o.length===0||t==null||!e.serviceMbsInIndexSR)return null;const i=pe(e.serviceMbsInIndexSR,a,"none",n,t);ne(v,i);let c=null;const l=()=>{if(!c)if(c=De,L(R),e.serviceObbInIndexSR!=null){e.serviceObbInIndexSR.transform(F,n,t,a,s),F.getCorners(c);for(const u of c)I(u,u,v),N(R,u)}else{const u=e.serviceMbsInIndexSR;if(!u)return;const d=u[3];O(ue(u),n,h,t),I(h,h,v),h[2]+=a;for(let g=0;g<8;++g){const M=1&g?d:-d,x=2&g?d:-d,$=4&g?d:-d,E=c[g];fe(E,[h[0]+M,h[1]+x,h[2]+$]),N(R,E)}}};let p=1/0,f=-1/0;const y=u=>{if(u.type!=="replace")return;const d=u.geometry;if(!(d!=null&&d.hasZ))return;L(k);const g=d.spatialReference||r,M=d.rings.reduce((x,$)=>$.reduce((E,C)=>(ie(h,C[0],C[1],C[2]),O(h,g,h,t),I(h,h,v),N(k,h),Math.min(h[2],E)),x),1/0);l(),le(R,k)&&(p=Math.min(p,M),f=Math.max(f,M))};if(o.forEach(u=>y(u)),p===1/0)return null;const m=(u,d,g)=>{I(h,g,i),u[d]=h[0],u[d+1]=h[1],u[d+2]=h[2],d+=24,g[2]=p,I(h,g,i),u[d]=h[0],u[d+1]=h[1],u[d+2]=h[2],d+=24,g[2]=f,I(h,g,i),u[d]=h[0],u[d+1]=h[1],u[d+2]=h[2]};for(let u=0;u<8;++u)m(q.data,3*u,c[u]);return de(q)}function Xe(e){return e[3]>=0}function et(e){e!=null&&(e[3]=-1)}const De=[b(),b(),b(),b(),b(),b(),b(),b()],k=U(),R=U(),F=new ce,h=b(),q={data:new Array(72),size:3,exclusive:!0,stride:3},v=P();export{Ke as A,Fe as D,me as F,ve as H,j as J,ge as L,We as N,Ee as Q,Ie as V,qe as W,Ae as X,Re as Z,Pe as _,Je as a,Ye as c,Qe as d,$e as e,et as h,Oe as k,Ze as m,pe as n,ze as o,Ve as p,w as q,Ge as r,Be as s,He as u,Xe as y};
