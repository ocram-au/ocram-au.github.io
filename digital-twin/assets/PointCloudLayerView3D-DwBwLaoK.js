import{cw as et,gB as tt,aZ as z,kC as it,d9 as q,By as Qe,Bz as st,R as Te,r as _,m as y,a as pe,a8 as rt,qd as nt,Bo as ot,BA as ue,BB as at,Aw as lt,AX as Ue,BC as dt,bF as G,BD as ht,kB as ut,bX as ct,bY as pt,BE as gt,BF as be,e7 as Z,aw as _t,BG as ft,BH as ye,aV as Se,ay as k,zU as M,AG as E,BI as mt,BJ as bt,AI as yt,AJ as St,_ as Pt,AL as xt,AR as vt,AO as wt,AP as Nt,AQ as At,BK as $t,n6 as zt,mV as T,AY as Rt,A_ as W,mT as It,bd as Ct,mW as ee,B0 as te,ag as Ot,bf as Ge,bg as Pe,bj as Mt,a$ as Et,bA as kt,wm as Ft,BL as xe,BM as Lt,dV as Bt,bb as Q,bq as Vt,ng as Dt,kY as ve,va as qt,od as Ht,pK as we,sJ as Wt,sK as Qt,sx as Ne,sy as Ae,vN as $e,sm as ze,BN as Tt,hp as Ut,ut as Gt,dA as Re,BO as jt,wg as Jt,wN as Ie,P,e as Kt,C as Yt,aJ as Xt,u as Ce,f as Zt,d1 as ei,BP as ti,jd as ii,y4 as si,y3 as ri,d5 as Oe,a9 as ni,c as oi,dp as ai,gi as ie,BQ as li,p as di,k as se,ik as hi,o as Me,aU as ui,gk as ci,mi as Ee,gh as pi,j7 as gi,cs as _i}from"./index-Bmji7YKu.js";import{l as fi}from"./LayerView3D-CQaKjHif.js";import{s as mi,a as bi}from"./I3SUtil-DxTD_B3A.js";import{c as yi,u as Si,a as Pi}from"./PointCloudWorkerUtil-CtO4KX0g.js";import{s as re,e as xi}from"./highlightUtils-Ciqs39dV.js";import{i as vi}from"./PopupSceneLayerView-Bf9c26oF.js";import{y as wi}from"./LayerView-BcbGCHYn.js";import"./I3SBinaryReader-C4gq8XZe.js";import"./PointCloudUniqueValueRenderer-DfzOAPZr.js";import"./popupUtils-CrgURn2V.js";let Ni=class extends et{constructor(e,i,s,r,n){super(e,i,-1,s,r),this.queue=n}},Ai=class{constructor(e,i,s,r){this.loading=e,this.indexLoading=i,this.processing=s,this.idleProcessing=r}},$i=class extends tt{constructor(e){super("PointCloudWorker","transform",{transform:i=>zi(i)},e)}};function zi(t){const e=[t.geometryBuffer];if(t.primaryAttributeData!=null&&t.primaryAttributeData.buffer&&e.push(t.primaryAttributeData.buffer),t.modulationAttributeData!=null&&t.modulationAttributeData.buffer&&e.push(t.modulationAttributeData.buffer),t.filterAttributesData!=null)for(const i of t.filterAttributesData)i!=null&&i.buffer&&e.push(i.buffer);for(const i of t.userAttributesData)i.buffer&&e.push(i.buffer);return e}function Ri(t,e,i){for(let r=0;r<e.length;r++)oe[r]=!1,$[r]=null;for(let r=0;r<t.length;r++)ne[r]=!1,A[r]=null;for(let r=0;r<e.length;r++){const n=ke(e[r],t,i);n>=0&&(oe[r]=!0,A[n]!=null?A[n].push(e[r]):A[n]=[e[r]])}for(let r=0;r<t.length;r++){const n=ke(t[r],e,i);n>=0&&(ne[r]=!0,$[n]!=null?$[n].push(t[r]):$[n]=[t[r]])}const s=[];for(let r=0;r<t.length;r++)A[r]!=null||ne[r]||s.push({load:[],remove:[t[r]]});for(let r=0;r<e.length;r++)$[r]!=null||oe[r]||s.push({load:[e[r]],remove:[]});for(let r=0;r<e.length;r++)$[r]!=null&&($[r].length>1||$[r][0]!==e[r])&&s.push({load:[e[r]],remove:$[r]});for(let r=0;r<t.length;r++)A[r]!=null&&(A[r].length>1||A[r][0]!==t[r])&&s.push({load:A[r],remove:[t[r]]});return s}const ne=[!1],A=[null],oe=[!1],$=[null];function ke(t,e,i){let s=t;for(;s>0;){const r=e.indexOf(s);if(r>=0)return r;s=i.getParentId(s)}return e.indexOf(s)}function Ii(t,e,i){return t.sort((s,r)=>{if(s.load.length===0&&r.load.length===0)return 0;if(s.load.length===0)return-1;if(r.load.length===0)return 1;if(s.remove.length===0&&r.remove.length===0){const n=i.getRenderObb(s.load[0]).center,a=i.getRenderObb(r.load[0]).center;return z(n,e)-z(a,e)}if(s.remove.length===0)return-1;if(r.remove.length===0)return 1;if(s.load.length===1&&r.load.length===1){const n=i.getRenderObb(s.load[0]).center,a=i.getRenderObb(r.load[0]).center;return z(n,e)-z(a,e)}if(s.load.length===1)return-1;if(r.load.length===1)return 1;{const n=i.getRenderObb(s.remove[0]).center,a=i.getRenderObb(r.remove[0]).center;return z(n,e)-z(a,e)}})}function Ci(t,e,i){for(let s=0;s<t.length;++s){const r=t[s];r.load.length>e&&r.remove.length===1&&Oi(t,r,i)}}function Oi(t,e,i){const s=[e.remove[0]],r=[];for(;s.length===1;){const n=s.pop();r.length=0;for(let a=0;a<e.load.length;a++){let o=e.load[a],d=i.getParentId(o);for(;d!==n;)o=d,d=i.getParentId(o);let l=s.indexOf(o);l<0&&(l=s.length,s.push(o),r.push([])),r[l].push(e.load[a])}}e.load=s;for(let n=0;n<s.length;n++)r[n].length>1?t.push({remove:[s[n]],load:r[n]}):s[n]=r[n][0]}let Mi=class{constructor(e,i,s){this._pages=[],this.pageSize=0,this._nodeSR=e,this._renderSR=i,this._renderSRSphericalPCPF=it(i),this.pageSize=s}addPage(e,i,s=0){for(;this._pages.length<e;)this._pages.push(null);ki(i,this._nodeSR,this._renderSR,s,this._renderSRSphericalPCPF),this._pages[e]={nodes:i,parents:new Uint32Array(this.pageSize)},Fi(this._pages,this.pageSize)}hasPage(e){return!!this._pages[e]}getNode(e){const i=this.pageSize;return this._pages[w(e,i)].nodes[F(e,i)]}getRenderObb(e){const i=this.pageSize;return this._pages[w(e,i)].nodes[F(e,i)].obbInRenderSR}setRenderObb(e,i){const s=this.pageSize;this._pages[w(e,s)].nodes[F(e,s)].obbInRenderSR.copy(i)}getParentId(e){const i=this.pageSize;return this._pages[w(e,i)].parents[F(e,i)]}hasNodes(e,i){const s=w(e,this.pageSize),r=w(e+i-1,this.pageSize);for(let n=s;n<=r;n++)if(this._pages[n]==null)return!1;return!0}forEachNodeId(e){for(let i=0;i<this._pages.length;i++){const s=this._pages[i];if(s)for(let r=0;r<s.nodes.length;r++)e(i*this.pageSize+r)}}createVisibilityTraverse(){const e={index:this,queue:[],masks:[],tempAabb:q()};return(i,s)=>Ei(e,i,s)}};function Ei(t,e,i){const s=t.index;if(!s.hasNodes(0,1))return;const r=t.queue;r.length=0,r.push(0);const n=t.masks;for(n.length=0,n.push(0);r.length>0;){const a=r.pop();let o=n.pop();const d=s.getNode(a),l=s.getRenderObb(a);let u=!0;if(e.clippingBox!=null){const h=1<<e.frustum.length;o&h||(l.toAaBoundingBox(t.tempAabb),Qe(e.clippingBox,t.tempAabb)?o|=h:st(e.clippingBox,t.tempAabb)||(u=!1))}for(let h=0;h<e.frustum.length&&u;h++){const c=1<<h;if(!(o&c)){const f=l.intersectPlane(e.frustum[h]);f>0?u=!1:f<0&&(o|=c)}}if(i.predicate(a,d,u)){const h=d.firstChild,c=d.childCount;let f=!1;const v=w(h,s.pageSize),b=w(h+c-1,s.pageSize);for(let g=v;g<=b;g++)if(!s.hasPage(g)){i.pageMiss(a,g),f=!0;break}if(!f)for(let g=0;g<c;g++)r.push(h+g),n.push(o)}}}function ki(t,e,i,s,r){for(let n=0;n<t.length;n++){const a=t[n];a.obb.transform(a.obbInRenderSR,e,i,s,r)}}function Fi(t,e){const i=[0];for(;i.length;){const s=i.pop(),r=t[w(s,e)].nodes[F(s,e)];for(let n=0;n<r.childCount;n++){const a=r.firstChild+n;t[w(a,e)]!=null&&(t[w(a,e)].parents[F(a,e)]=s,i.push(a))}}}function w(t,e){return t/e|0}function F(t,e){return t%e}let D=class extends Te{constructor(e){super(e),this.pointCloudMetadata=null}};_([y({constructOnly:!0,clonable:"reference"})],D.prototype,"pointCloudMetadata",void 0),D=_([pe("esri.views.3d.layers.i3s.PointCloudGraphic")],D);let Li=class{constructor(e){this._context=e,this._highlights=new Map}get empty(){return this._highlights.size===0}destroy(){this._highlights=null}add(e,i){const s=new Bi(e,i),r=this._highlights.get(i);return r?r.add(s):this._highlights.set(i,new Set([s])),this._enableSet(s),rt(()=>this._removeSet(s))}_removeSet(e){this._disableSet(e);const{highlightName:i}=e.id,s=this._highlights.get(i);s&&(s.delete(e),s.size===0&&this._highlights.delete(i))}_enableSet(e){e.enabled||(e.enabled=!0,this._context.forEachNode(i=>this._enableSetForNode(e,i)))}_enableSetForNode(e,i){if(!e.enabled)return;const s=e.ids.get(i.id);s&&s.forEach(r=>this._context.addHighlight(i,r,e.id))}_disableSet(e){e.enabled&&(e.enabled=!1,this._context.forEachNode(i=>this._disableSetForNode(e,i)))}_disableSetForNode(e,i){e.enabled||this._context.removeHighlight(i,e.id)}nodeAdded(e){this._forEachSet(i=>this._enableSetForNode(i,e))}nodeRemoved(e){this._forEachSet(i=>this._disableSetForNode(i,e))}removeAll(){this._forEachSet(e=>this._disableSet(e))}_forEachSet(e){this._highlights.forEach(i=>i.forEach(e))}hasHighlightOptions(e){return this._highlights.has(e)}},Bi=class{constructor(e,i){this.ids=new Map,this.enabled=!1;for(const s of e)s!=null&&this._add(s.nodeId,s.pointId);this.id=new nt(i)}_add(e,i){const s=this.ids.get(e);s?s.add(i):this.ids.set(e,new Set([i]))}};class ge extends ot{constructor(){super(...arguments),this.clipBox=q(ue),this.useFixedSizes=!1,this.useRealWorldSymbolSizes=!1,this.scaleFactor=1,this.minSizePx=0,this.size=0,this.sizePx=0}get fixedSize(){return this.drawScreenSpace?this.sizePx:this.size}get screenMinSize(){return this.useFixedSizes?0:this.minSizePx}get drawScreenSpace(){return this.useFixedSizes&&!this.useRealWorldSymbolSizes}}class _e extends at{constructor(e,i,s){super(e),this.origin=e,this.isLeaf=i,this.splatSize=s}}function je(t){const e=new lt,i=Ue(t.output),{vertex:s,fragment:r}=e;return e.vertex.include(dt,t),e.attributes.add(G.POSITION,"vec3"),e.attributes.add(G.COLOR,"vec3"),s.uniforms.add(new ht("modelView",(n,a)=>ut(Fe,a.camera.viewMatrix,ct(Fe,n.origin))),new gt("proj",n=>n.camera.projectionMatrix),new be("screenMinMaxSize",(n,a,o)=>Z(ae,o.useFixedSizes?0:o.minSizePx*a.camera.pixelRatio,j(n.isLeaf)*a.camera.pixelRatio)),t.useFixedSizes?new ft("pointScale",(n,a)=>Z(ae,n.fixedSize*a.camera.pixelRatio,a.camera.fullHeight)):new be("pointScale",(n,a,o)=>Z(ae,n.splatSize*o.scaleFactor*a.camera.pixelRatio,a.camera.fullHeight/a.camera.pixelRatio))),t.clippingEnabled?s.uniforms.add(new ye("clipMin",(n,a,o)=>Se(Le,o.clipBox[0]-n.origin[0],o.clipBox[1]-n.origin[1],o.clipBox[2]-n.origin[2])),new ye("clipMax",(n,a,o)=>Se(Le,o.clipBox[3]-n.origin[0],o.clipBox[4]-n.origin[1],o.clipBox[5]-n.origin[2]))):(s.constants.add("clipMin","vec3",[-M,-M,-M]),s.constants.add("clipMax","vec3",[M,M,M])),i&&e.varyings.add("vColor","vec3"),s.main.add(E`
    // Move clipped points outside of clipspace
    if (position.x < clipMin.x || position.y < clipMin.y || position.z < clipMin.z ||
      position.x > clipMax.x || position.y > clipMax.y || position.z > clipMax.z) {
      gl_Position = vec4(0.0,0.0,0.0,2.0);
      gl_PointSize = 0.0;
      return;
    }

    if (rejectBySlice(position)) {
      gl_Position = vec4(0.0, 0.0, 0.0, 2.0);
      gl_PointSize = 0.0;
      return;
    }

    // Position in camera space
    vec4 camera = modelView * vec4(position, 1.0);

    float pointSize = pointScale.x;
    vec4 position = proj * camera;
    ${t.drawScreenSize?E`float clampedScreenSize = pointSize;`:E`float pointRadius = 0.5 * pointSize;
           vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);
           vec4 positionOffset = proj * cameraOffset;
           float radius = abs(positionOffset.y - position.y);
           float viewHeight = pointScale.y;
           // screen diameter = (2 * r / w) * (h / 2)
           float screenPointSize = (radius / position.w) * viewHeight;
           float clampedScreenSize = clamp(screenPointSize, screenMinMaxSize.x, screenMinMaxSize.y);
           // Shift towards camera, to move rendered point out of terrain i.e. to
           // the camera-facing end of the virtual point when considering it as a
           // 3D sphere.
           camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;
           position = proj * camera;`}

    gl_PointSize = clampedScreenSize;
    gl_Position = position;
    ${i?E`vColor = color;`:""}`),r.include(mt,t),e.include(bt,t),r.main.add(E`
    vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);
    float r2 = dot(vOffset, vOffset);

    if (r2 > 0.25) {
      discard;
    }
    calculateOcclusionAndOutputHighlight();
    ${i?E`fragColor = vec4(vColor, 1.0);`:""}`),e}function j(t){return t?256:64}const Fe=pt(),Le=k(),ae=_t(),Vi=Object.freeze(Object.defineProperty({__proto__:null,PointRendererDrawParameters:_e,PointRendererPassParameters:ge,build:je,getMaxPointSizeScreenspace:j},Symbol.toStringTag,{value:"Module"}));class Di extends yt{constructor(e,i){super(e,i,new St(Vi,()=>Pt(()=>Promise.resolve().then(()=>Yi),void 0)))}initializePipeline(e){return xt({depthTest:{func:zt.LESS},depthWrite:$t,colorWrite:At,stencilWrite:e.hasOccludees?Nt:null,stencilTest:e.hasOccludees?wt:null,drawBuffers:e.output===T.Depth?{buffers:[vt.NONE]}:null})}}let V=class extends Rt{constructor(){super(...arguments),this.drawScreenSize=!1,this.useFixedSizes=!1,this.hasOccludees=!1,this.clippingEnabled=!1}};_([W()],V.prototype,"drawScreenSize",void 0),_([W()],V.prototype,"useFixedSizes",void 0),_([W()],V.prototype,"hasOccludees",void 0),_([W()],V.prototype,"clippingEnabled",void 0);const qi=new Map([["positions",[new $e(G.POSITION,3,ze.FLOAT,0,12)]],["colors",[new $e(G.COLOR,3,ze.UNSIGNED_BYTE,0,3,!0)]]]);let U=class extends It{constructor(t){super(t),this.type=Ct.PCL,this.isGround=!1,this._passParameters=new ge,this._highlights=new Li({forEachNode:e=>this.forEachNode(e),addHighlight:(e,i,s)=>this._addHighlight(e,i,s),removeHighlight:(e,i)=>this._removeHighlight(e,i)}),this.produces=new Map([[ee.OPAQUE_MATERIAL,e=>!(te(e)||e===T.Highlight&&this._highlights.empty)],[ee.OPAQUE_MATERIAL_WITHOUT_NORMALS,e=>te(e)]]),this.layerUid="",this._slicePlaneEnabled=!1,this._configuration=new V,this._nodes=new Ot}hasHighlightOptions(t){return this._highlights.hasHighlightOptions(t)}initializeRenderContext(t){this._context=t,t.requestRender()}uninitializeRenderContext(){}intersect(t,e,i,s){const r=k(),n=k(),a=k(),o=k(),d=Ge(),l=t.camera.perScreenPixelRatio/2,u=t.camera.near;Pe(n,s,i);const h=1/Mt(n);Et(n,n,h),kt(a,n),Ft(d,n[0],n[1],n[2],-z(n,i));const c=new de,f=new de,v=new Array,b=q(),g=q(this._passParameters.clipBox);xe(g,-i[0],-i[1],-i[2],g),this._nodes.forAll(p=>{const S=p.splatSize*this._passParameters.scaleFactor;let x=p.obb.minimumDistancePlane(d),R=p.obb.maximumDistancePlane(d);x-=le(S,x+u,this._passParameters,l,p.isLeaf),R-=le(S,R+u,this._passParameters,l,p.isLeaf);const Je=R<0,Ke=c.dist!=null&&f.dist!=null&&c.dist<x*h&&f.dist>R*h;if(Je||Ke)return;const J=ce(S,R+u,this._passParameters,l,p.isLeaf);if(!p.obb.intersectRay(i,n,J))return;const Ye=J*J;p.obb.toAaBoundingBox(b),xe(b,-i[0],-i[1],-i[2],b);const Xe=!Qe(g,b);Pe(o,p.origin,i);const Ze=p.coordinates.length/3;for(let I=0;I<Ze;I++){if(r[0]=o[0]+p.coordinates[3*I],r[1]=o[1]+p.coordinates[3*I+1],r[2]=o[2]+p.coordinates[3*I+2],Xe&&!Lt(g,r))continue;const B=z(r,n),fe=Bt(r)-B*B;if(fe>Ye)continue;let K=B+u;const Y=le(S,K,this._passParameters,l,p.isLeaf);if(B-Y<0)continue;K-=Y;const me=ce(S,K,this._passParameters,l,p.isLeaf);if(fe>me*me)continue;const O=(B-Y)*h,X=N=>(N.point=Hi(p,I,N.point),N.dist=O,N.normal=a,N.node=p,N.pointId=I,N.layerUid=this.layerUid,N);if((c.dist==null||O<c.dist)&&(e==null||e(i,s,O))&&X(c),t.options.store!==Q.MIN&&(f.dist==null||O>f.dist)&&(e==null||e(i,s,O))&&X(f),t.options.store===Q.ALL&&(e==null||e(i,s,O))){const N=new de;v.push(X(N))}}});const C=p=>{const{layerUid:S,node:x,pointId:R}=p;return new Tt(p.point,S,R,()=>this.createGraphic(x,R,p.point))},L=(p,S)=>{const x=C(S);p.set(this.type,x,S.dist,S.normal)};if(Be(c)){const p=t.results.min;(p.dist==null||c.dist<p.dist)&&L(p,c)}if(Be(f)&&t.options.store!==Q.MIN){const p=t.results.max;(p.dist==null||f.dist>p.dist)&&L(p,f)}if(t.options.store===Q.ALL){const p=Vt(i,s);for(const S of v){const x=Dt(p);L(x,S),t.results.all.push(x)}}}acquireTechniques(t){return this._nodes.length!==0&&(Ue(t.output)||te(t.output)&&t.bind.slot===ee.OPAQUE_MATERIAL_WITHOUT_NORMALS||t.output===T.Highlight)?(this._nodes.forAll(e=>this._initNode(t,e)),this._configuration.drawScreenSize=this._passParameters.drawScreenSpace,this._configuration.useFixedSizes=this._passParameters.useFixedSizes,this._configuration.hasSlicePlane=this._slicePlaneEnabled,this._configuration.hasOccludees=t.bind.hasOccludees,this._configuration.clippingEnabled=this._clippingEnabled,this._configuration.output=t.output,this._context.techniques.get(Di,this._configuration)):null}render(t,e){var d;const{rctx:i,bind:s,output:r}=t,n=i.bindTechnique(e,s,this._passParameters),a=r===T.Highlight,o=((d=s.highlight)==null?void 0:d.name)??null;a&&!o||this._nodes.forAll(l=>{l.coordinates.length===0||a&&!l.highlightMap.has(o)||(n.bindDraw(s,this._passParameters,l),i.bindVAO(l.vao),a?this._renderHighlightFragments(t,l):i.drawArrays(ve.POINTS,0,l.coordinates.length/3))})}_renderHighlightFragments(t,e){const{highlightMap:i}=e,{rctx:s,bind:r}=t,{highlight:n}=r;if(!n)return;const a=n.name,o=i.get(a);if(!o||o.length===0)return;const{highlightOrderMap:d,highlightLevel:l}=r;if(l==null)return;for(const b of i.keys())if(b!==a){const g=d.get(b);if(g!==void 0&&g>l)return}let u=0,h=o[0].componentIndex,c=h+1;const f=()=>{for(;u<o.length&&o[u].id.highlightName!==a;)h=o[u].componentIndex,++u;c=h+1};f();const v=(b,g)=>{const C=g-b;C>0&&s.drawArrays(ve.POINTS,b,C)};for(;u<o.length;){const b=o[u];if(b.id.highlightName!==a){v(h,c),++u,f();continue}const g=b.componentIndex;g!==c&&(v(h,c),h=g),c=g+1,++u}v(h,c)}set useFixedSizes(t){this._passParameters.useFixedSizes!==t&&(this._passParameters.useFixedSizes=t,this._requestRender())}get useFixedSizes(){return this._passParameters.useFixedSizes}set scaleFactor(t){this._passParameters.scaleFactor!==t&&(this._passParameters.scaleFactor=t,this._requestRender())}get scaleFactor(){return this._passParameters.scaleFactor}set minSizePx(t){this._passParameters.minSizePx!==t&&(this._passParameters.minSizePx=t,this._requestRender())}get minSizePx(){return this._passParameters.minSizePx}set useRealWorldSymbolSizes(t){this._passParameters.useRealWorldSymbolSizes!==t&&(this._passParameters.useRealWorldSymbolSizes=t,this._requestRender())}get useRealWorldSymbolSizes(){return this._passParameters.useRealWorldSymbolSizes}set size(t){this._passParameters.size!==t&&(this._passParameters.size=t,this._requestRender())}get size(){return this._passParameters.size}set sizePx(t){this._passParameters.sizePx!==t&&(this._passParameters.sizePx=t,this._requestRender())}get sizePx(){return this._passParameters.sizePx}set clippingBox(t){qt(this._passParameters.clipBox,t||ue)}get _clippingEnabled(){return!Ht(this._passParameters.clipBox,ue,(t,e)=>t===e)}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(t){this._slicePlaneEnabled!==t&&(this._slicePlaneEnabled=t,this._requestRender())}addNode(t){this._nodes.push(t),this._highlights.nodeAdded(t),this._requestRender()}removeNode(t){let e=null;return this._nodes.filterInPlace(i=>i.id!==t||(e=i,i.vao=we(i.vao),this._highlights.nodeRemoved(i),!1)),this._requestRender(),e}forEachNode(t){this._nodes.forAll(t)}removeAll(){this._nodes.forAll(t=>t.vao=we(t.vao)),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()}highlight(t,e){return this._highlights.add(t,e)}_addHighlight(t,e,i){t.addHighlight(e,i),this._requestRender()}_removeHighlight(t,e){t.removeHighlight(e),this._requestRender()}_initNode(t,e){e.vao??(e.vao=new Wt(t.rctx,Qt,qi,new Map([["positions",Ne.createVertex(t.rctx,Ae.STATIC_DRAW,e.coordinates)],["colors",Ne.createVertex(t.rctx,Ae.STATIC_DRAW,e.rgb)]])))}_requestRender(){this._context&&this._context.requestRender()}};function ce(t,e,i,s,r){if(i.drawScreenSpace)return i.fixedSize*e*s;const n=j(r)*e*s;return i.useFixedSizes?Math.min(i.fixedSize/2,n):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*e*s,t/2),n):Math.min(t/2,n)}function le(t,e,i,s,r){return i.drawScreenSpace?0:ce(t,e,i,s,r)}function Hi(t,e,i){return i==null&&(i=k()),i[0]=t.origin[0]+t.coordinates[3*e],i[1]=t.origin[1]+t.coordinates[3*e+1],i[2]=t.origin[2]+t.coordinates[3*e+2],i}_([y({constructOnly:!0})],U.prototype,"createGraphic",void 0),U=_([pe("esri.views.3d.layers.i3s.PointCloudRenderer")],U);class de{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}}function Be(t){return t.dist!=null&&t.point!=null&&t.pointId!=null&&t.node!=null}class Wi extends _e{constructor(e,i,s,r,n,a,o,d,l=null){super(s,n,i),this.id=e,this.obb=r,this.coordinates=a,this.rgb=o,this.attributes=d,this.pointIdFilterMap=l,this.highlightMap=new Map}addHighlight(e,i){const{highlightMap:s}=this,r=Ut(s,i.highlightName,()=>new Array),n=new Ti(e,i);r.push(n);const a=Ve(n);for(let o=r.length-1;o>0&&a<Ve(r[o-1]);--o)[r[o-1],r[o]]=[r[o],r[o-1]]}removeHighlight(e){const{highlightMap:i}=this,{highlightName:s}=e,r=i.get(s);if(!r)return;const n=r.filter(a=>a.id!==e);n.length===0?i.delete(s):i.set(s,n)}get cachedMemory(){return 5*this.coordinates.length+128}}function Qi(t){return t.hasOwnProperty("splatSize")}function Ve(t){return t.componentIndex!=null?t.componentIndex:-1}class Ti{constructor(e,i){this.componentIndex=e,this.id=i}}function De(t){const e=t.renderer,i=e==null?void 0:e.type,s=(e==null?void 0:e.toJSON())??null;let r=null,n=!1;const a=t.attributeStorageInfo;i==="point-cloud-unique-value"||i==="point-cloud-stretch"||i==="point-cloud-class-breaks"?r=H(a,e.field):i==="point-cloud-rgb"?(r=We(a,e.field),n=r!=null):(r=We(a,"RGB"),n=r!=null);let o=null;return e!=null&&e.colorModulation&&(o=H(a,e.colorModulation.field)),{rendererJSON:s,isRGBRenderer:n,primaryAttribute:r,modulationAttribute:o}}function qe(t){const e=t.filters;return e?e.map(i=>({filterJSON:i.toJSON(),attributeInfo:H(t.attributeStorageInfo,i.field)})):[]}function Ui(t){const e=t==null?void 0:t.pointSizeAlgorithm;return e&&e.type==="splat"?e:null}function He(t){const e=t==null?void 0:t.pointSizeAlgorithm;return e&&e.type==="fixed-size"?e:null}function Gi(t){const e=t==null?void 0:t.pointSizeAlgorithm;return!!(e!=null&&e.type)&&e.type==="fixed-size"}function We(t,e){for(const i of t??[])if(i.name===e&&i.attributeValues!=null&&i.attributeValues.valueType==="UInt8"&&i.attributeValues.valuesPerElement===3)return{name:e,storageInfo:i,useElevation:!1};return null}function H(t,e){for(const i of t??[])if(i.name===e){const s=i.encoding==="embedded-elevation";return s?{name:e,storageInfo:null,useElevation:s}:{name:e,storageInfo:i,useElevation:s}}return(e==null?void 0:e.toLowerCase())==="elevation"?{name:e,storageInfo:null,useElevation:!0}:null}const ji=8,Ji=Ge();let m=class extends vi(fi(wi)){constructor(){super(...arguments),this.type="point-cloud-3d",this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new Gt,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[],this.ignoresMemoryFactor=!1}get baseUrl(){var t;return((t=this.layer.parsedUrl)==null?void 0:t.path)??""}get pointScale(){var i;const t=Ui((i=this.layer)==null?void 0:i.renderer);return(t==null?void 0:t.scaleFactor)!=null?t.scaleFactor:1}get useRealWorldSymbolSizes(){var i;const t=He((i=this.layer)==null?void 0:i.renderer);return(t==null?void 0:t.useRealWorldSymbolSizes)!=null?t.useRealWorldSymbolSizes:!1}get pointSize(){var i;const t=He((i=this.layer)==null?void 0:i.renderer);return(t==null?void 0:t.size)!=null?t.size:0}get inverseDensity(){var e;return(e=this.layer)!=null&&e.renderer?1*96/this.layer.renderer.pointsPerInch:5}get availableFields(){const t=De(this.layer),e=new Set;t.primaryAttribute&&e.add(t.primaryAttribute.name),t.modulationAttribute&&e.add(t.modulationAttribute.name);const i=qe(this.layer);if(i)for(const s of i)s.attributeInfo&&e.add(s.attributeInfo.name);if(this.layer.outFields)for(const s of Re(this.layer.fieldsIndex,this.layer.outFields))e.add(s);return Array.from(e)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const t=q(),e=this.view.renderSpatialReference;return jt(this.view.clippingArea,t,e)?t:null}get _elevationOffset(){const t=this.layer&&this.layer.elevationInfo;return t&&t.mode==="absolute-height"?Jt(t,this.layer.spatialReference):0}initialize(){const t=this.view.resourceController,e=Ki(t);this._worker=new $i(e),this.addResolvingPromise(this._worker.promise),mi(this.layer),bi(this.layer,this.view),this._indexRequester=t.createStreamDataRequester(Ie.I3S_INDEX),this._dataRequester=t.createStreamDataRequester(Ie.I3S_DATA),this._initRenderer();const i=this._initNodePages(),s=this.view.resourceController.memoryController;this._memCache=s.newCache(`pcl-${this.layer.uid}`),this._updatingHandles.add(()=>this._clippingBox,()=>this._setUpdateViewNeeded(),P),this._updatingHandles.add(()=>this._elevationOffset,()=>this._elevationOffsetChanged(),P),this._updatingHandles.add(()=>this.layer.renderer,()=>this._rendererChanged(),P),this._updatingHandles.add(()=>this.layer.filters,()=>this._reload(),P),this._updatingHandles.add(()=>this.layer.outFields,()=>this._reload(),P),this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this._setUpdateViewNeeded()),this._updatingHandles.add(()=>this.view.state.contentCamera,()=>this._setUpdateViewNeeded()),this.addHandles([Kt(()=>this.view.quality,()=>this._setUpdateViewNeeded(),Yt)]),this.addResolvingPromise(i),this.when(()=>{this.addHandles([t.scheduler.registerTask(Xt.POINT_CLOUD_LAYER,this),t.scheduler.registerIdleStateCallbacks(()=>this._idleBegin(),()=>this._idleEnd()),this._updatingHandles.add(()=>this.suspended,r=>{r?this._clearNodeState():this._setUpdateViewNeeded()},P)])},()=>{this._updatingHandles.removeAll(),this.removeAllHandles()})}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker=Ce(this._worker),this._destroyRenderer(),this._memCache=Ce(this._memCache),this._codedDomainPopulationAbortController=Zt(this._codedDomainPopulationAbortController),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new U({createGraphic:(t,e,i)=>this._createGraphic(t,e,i)}),this._renderer.layerUid=this.layer.uid,this._updatingHandles.add(()=>this._clippingBox,t=>this._renderer.clippingBox=t,P),this._updatingHandles.add(()=>this.suspended,t=>this._setPointsVisible(!t),P),this._updatingHandles.add(()=>this.pointScale,t=>this._renderer.scaleFactor=t,P),this._renderer.minSizePx=Math.sqrt(2),this._updatingHandles.add(()=>this.useRealWorldSymbolSizes,t=>this._renderer.useRealWorldSymbolSizes=t,P),this._updatingHandles.add(()=>this.pointSize,t=>{const e=ei(t);this._renderer.size=t,this._renderer.sizePx=e},P),this._updatingHandles.add(()=>this.slicePlaneEnabled,t=>this._renderer.slicePlaneEnabled=t,P),this._updatingHandles.add(()=>this.inverseDensity,()=>this._setUpdateViewNeeded(),P),this._updatingHandles.add(()=>this.maximumPointCount,()=>this._setUpdateViewNeeded(),P),this._updatingHandles.add(()=>this.view.qualitySettings.sceneService.pointCloud.lodFactor,t=>{this._lodFactor=t,this._setUpdateViewNeeded()},P)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(t,e,i){const s=t.pointIdFilterMap!=null?t.pointIdFilterMap[e]:e,r=ti(this.view,i),n=this._createGraphicAttributes(t,s);return new D({pointCloudMetadata:{nodeId:t.id,pointIndexInNode:e,attributePointIndexInNode:s,epoch:this._nodeLoadEpoch},geometry:r,attributes:n,layer:this.layer,sourceLayer:this.layer})}_createGraphicAttributes(t,e){const i={};for(const s of t.attributes)this._encodeGraphicAttribute(s.attributeInfo,s.values,e,i);return i}_encodeGraphicAttribute(t,e,i,s){var a;const r=(a=t.storageInfo)==null?void 0:a.attributeValues,n=(r==null?void 0:r.valuesPerElement)??1;if(n===1)s[t.name]=e[i];else if((r==null?void 0:r.valueType)==="UInt8"&&n<=4){let o=0;const d=i*n;for(let l=d;l<d+n;l++)o=(o<<8)+e[l];s[t.name]=o}else s[t.name]=void 0}_setPointsVisible(t){t&&!this._rendererAdded?(this.view._stage.addRenderPlugin(this._renderer),this._rendererAdded=!0):!t&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=Gi(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_displayNodes(t){this._workQueue=Ri([...this._renderedNodes],t,this._index),Ii(this._workQueue,this.view.state.contentCamera.viewForward,this._index),Ci(this._workQueue,ji,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=t.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){const t=new Array;this._loadingNodes.forEach(({abortController:e})=>t.push(e)),this._loadingNodes.clear();for(const e of t)e.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){const t=new Set;this._workQueue.forEach(s=>s.load.forEach(r=>t.add(r)));const e=new Array,i=new Map;this._loadingNodes.forEach((s,r)=>{t.has(r)?i.set(r,s):e.push(s)}),this._loadingNodes=i;for(const{abortController:s}of e)s.abort();this._workQueue=this._workQueue.filter(s=>{for(const r of s.load)if(this._loadingNodes.has(r))return this._recalcWork=!0,!1;return!0}),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach(({abortController:t})=>t.abort()),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach(t=>this._removeFromRenderer(t)),this._cancelNodeLoading()}_idleBegin(){this._setUpdateViewNeeded()}_idleEnd(){this._setUpdateViewNeeded()}get running(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.running}runTask(t){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const e=this._isRootNodeVisible();e!==this._layerIsVisible&&(this._layerIsVisible=e,this.notifyChange("suspended")),this._updateLoading()}}else{for(t.run(()=>this._updateWorkQueues());this._indexQueue.length>0&&t.run(()=>this._processIndexQueue()););this._processWorkQueue(t),this._idleQueue.runTask(t)}}_processIndexQueue(){const t=this._indexQueue.shift(),e=this._loadNodePage(t);return this._indexPagesLoading.set(t,e),e.promise.then(i=>{this._index.addPage(t,i,this._elevationOffset),this._setUpdateViewNeeded()}).then(()=>{this._indexPagesLoading.delete(t)},()=>{this._indexPagesLoading.delete(t)}),!0}_processWorkQueue(t){for(;!t.done;){const e=this._scheduleWorkEntry();if(e==null)return void t.madeProgress();this._processWorkEntry(e),t.madeProgress()}}_scheduleWorkEntry(){let t=this._workQueue.length;for(;t--;){const e=this._workQueue.shift();if(!e.remove.find(i=>!this._renderedNodes.has(i)))return e;this._workQueue.push(e)}return null}_processWorkEntry(t){if(t.load.length!==0)Promise.all(t.load.map(e=>{const i=new AbortController,s=this._memCache.pop(e.toString());return s!=null?this._loadingNodes.set(e,{abortController:i,promise:Promise.resolve(s)}):this._loadingNodes.has(e)||this._loadingNodes.set(e,{abortController:i,promise:this._loadNode(e,i.signal)}),this._loadingNodes.get(e).promise})).then(e=>{for(let i=0;i<t.load.length;i++)if(e[i]){const s=this._setupRendererData(t.load[i],e[i]);this._addToRenderer(s)}for(const i of t.remove)this._removeFromRenderer(i)}).catch(()=>{}).then(()=>{for(const e of t.load)this._loadingNodes.delete(e);this._updateLoading(),this._recalcWork&&!this._idleQueue.running&&this._indexQueue.length===0&&this._loadingNodes.size===0&&(this._recalcWork=!1,this._setUpdateViewNeeded())}),this._updateLoading();else for(const e of t.remove)this._removeFromRenderer(e)}async _populateClassCodeCodedDomain(t,e){var a,o,d;const i="CLASS_CODE",s=this.layer.fieldsIndex.get(i);if(!s||s.domain||!t.includes(s.name))return;const r=await ii(this.layer.queryCachedStatistics(i,{signal:e}));if(r.ok===!1)return;const n=(d=(o=(a=r.value)==null?void 0:a.stats)==null?void 0:o.labels)==null?void 0:d.labels;n&&Array.isArray(n)&&(s.domain=new si({name:"CLASS_CODE",codedValues:n.map(l=>new ri({code:l.value,name:l.label}))}))}async prepareFetchPopupFeatures(t){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=new AbortController,this._codedDomainPopulationPromise=this._populateClassCodeCodedDomain(t,this._codedDomainPopulationAbortController.signal).then(()=>{this._codedDomainPopulationAbortController=null})),this._codedDomainPopulationPromise}async whenGraphicAttributes(t,e){const i=this._splitGraphicsPerNode(t),s=this.layer.attributeStorageInfo,r=e.map(o=>H(s,o)).filter(Oe),n=async(o,d)=>{const l=this._index.getNode(d);await gi(r,async u=>{const h=u.useElevation?await this._loadElevationAttributeFromGeometry(l.resourceId):await this._loadAndParseAttribute(l,u);if(h){for(const c of o)if(this._isValidPointGraphic(c)){const f=c.pointCloudMetadata.attributePointIndexInNode;this._encodeGraphicAttribute(u,h,f,c.attributes)}}})},a=[];return i.forEach((o,d)=>{a.push(n(o,d))}),await Promise.allSettled(a),t}_isValidPointGraphic(t){var e;return t instanceof D&&((e=t.pointCloudMetadata)==null?void 0:e.epoch)===this._nodeLoadEpoch}_splitGraphicsPerNode(t){const e=new Map;for(const i of t){if(!this._isValidPointGraphic(i))continue;const s=i.pointCloudMetadata,r=e.get(s.nodeId);r?r.push(i):e.set(s.nodeId,[i])}return e}async _loadAndParseAttribute(t,e){const i=await this._loadAttribute(t.resourceId,e,null);return i!=null?yi({attributeInfo:e,buffer:i},null,t.vertexCount):null}async _loadElevationAttributeFromGeometry(t){const e=this.layer.store.defaultGeometrySchema,i=Si(e,await this._loadGeometry(t,null));return Pi(i,i.length/3)}highlight(t,e){if(!t||t instanceof ni)return re;const i=xi(t);if(i.length===0)return re;if(!(i[0]instanceof Te))return re;const s=i;return this._renderer.highlight(s.map(r=>this._graphicToPointDefinition(r)),(e==null?void 0:e.name)??oi)}_graphicToPointDefinition(t){if(!this._isValidPointGraphic(t))return null;const{nodeId:e,pointIndexInNode:i}=t.pointCloudMetadata;return e!=null&&i!=null?{nodeId:e,pointId:i}:null}_computeWork(){let t=0;for(const e of this._workQueue)t+=e.load.length+e.remove.length;return t+=this._loadingNodes.size,t+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,t+=this._loadingInitNodePage?100:0,t+=this._updateViewNeeded?100:0,t}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const t=this._computeWork();return 1-Math.min(this._totalWork,t)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}get visibleAtCurrentScale(){return ai(this.layer.effectiveScaleRange,this.view.scale)}_initNodePages(){const t=this.layer.store.index,e=t.nodesPerPage||t.nodePerIndexBlock;return this._index=new Mi(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,e),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=t.nodesPerPage!=null?1:t.nodePerIndexBlock,this._loadNodePage(0).promise.then(i=>{this._index.addPage(0,i,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()})}_loadNodePage(t){const e=new AbortController,i=`${this.baseUrl}/nodepages/${t*this._pageMultiplier}`;return{promise:this._requestNodePage(i,e.signal).then(s=>s.nodes.map((r,n)=>({resourceId:r.resourceId!=null?r.resourceId:t*this._index.pageSize+n,obb:ie.fromJSON(r.obb),obbInRenderSR:new ie,firstChild:r.firstChild,childCount:r.childCount,vertexCount:r.vertexCount??r.pointCount,lodThreshold:r.lodThreshold??r.effectiveArea}))),abortController:e}}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;const t=this.view.quality;let e=this.inverseDensity/this._lodFactor*t;const i=this.maximumPointCount*this._lodFactor*t;let s=this._computeNodesForMinimumDensity(e),r=this._computePointCount(s),n=Math.sqrt(r/(.75*i));for(;r>i;)e*=n,s=this._computeNodesForMinimumDensity(e),r=this._computePointCount(s),n=Math.sqrt(2);return this._displayNodes(s),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(t){let e=0;for(let i=0;i<t.length;i++){const s=this._index.getNode(t[i]);s&&(e+=s.vertexCount)}return e}_isRootNodeVisible(){let t=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(e,i,s)=>(t=s,!1),pageMiss:()=>{}}),t}_computeNodesForMinimumDensity(t){const e=this.view.state.contentCamera,i=e.frustum,s=this._clippingBox,r=e.viewForward,n=z(r,e.eye),a=li(r,-n,Ji),o=e.perScreenPixelRatio/2,d=t*t,l=this._nodeIdArray;l.length=0;const u=h=>l.push(h);return this._traverseVisible({frustum:i,clippingBox:s},{predicate:(h,c,f)=>{if(!f)return!1;if(c.childCount===0)return u(h),!1;const v=this._index.getRenderObb(h);return!(this._computeAveragePixelArea(v,c.lodThreshold,c.vertexCount,a,o)<=d)||(u(h),!1)},pageMiss:(h,c)=>{u(h),this._indexQueue.includes(c)||this._indexQueue.push(c)}}),l}_computeAveragePixelArea(t,e,i,s,r){const a=Math.max(1e-7,t.minimumDistancePlane(s));return e/(a*a)/(4*r*r)/i}_loadNode(t,e){try{return this._loadNodeAsync(t,e)}catch(i){throw di(i)||se.getLogger(this).error(i),i}}async _loadAdditionalUserAttributes(t,e,i){const s=this.layer.outFields;if(!s)return[];const r=Re(this.layer.fieldsIndex,s),n=new Set(t.map(l=>l!=null?l.name:null)),a=this.layer.attributeStorageInfo,o=[];for(const l of r){if(n.has(l))continue;const u=H(a,l);u&&o.push(e(u))}const d=await hi(o);return Me(i),d.filter(Oe)}async _loadNodeAsync(t,e){const i=this._index.getNode(t),s=De(this.layer),r=qe(this.layer),n=i.resourceId,a=async o=>{if(!o)return null;if(o.useElevation)return{attributeInfo:o,buffer:null};const d=await this._loadAttribute(n,o,e);return d!=null?{attributeInfo:o,buffer:d}:null};return this._idleQueue.push(async()=>{const o=this._loadGeometry(n,e),{primaryAttribute:d,modulationAttribute:l}=s,u=a(d),h=a(l),c=r.map(x=>x.attributeInfo),f=c.map(x=>a(x)),v=this._loadAdditionalUserAttributes([d,l,...c],a,e),[b,g,C,L,p]=await Promise.all([o,u,h,Promise.all(f),v]);Me(e);const S={geometryBuffer:b,primaryAttributeData:g,modulationAttributeData:C,filterAttributesData:L,userAttributesData:p,schema:this.layer.store.defaultGeometrySchema,rendererInfo:s,filterInfo:r,obbData:this._index.getRenderObb(t).data,elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()};return this._worker.invoke(S,e)},e)}async _loadGeometry(t,e){return this._requestData(`${this.baseUrl}/nodes/${t}/geometries/0`,e)}async _loadAttribute(t,e,i){if(!(e!=null&&e.storageInfo))return null;const s=e.storageInfo.key;return this._requestData(`${this.baseUrl}/nodes/${t}/attributes/${s}`,i)}_requestNodePage(t,e){const i={f:"json",...this.layer.customParameters,token:this.layer.apiKey};return this._indexRequester.request(t,"json",{query:i,signal:e})}_requestData(t,e){return this._dataRequester.request(t,"binary",{query:{...this.layer.customParameters,token:this.layer.apiKey},signal:e})}_removeFromRenderer(t){if(this._renderedNodes.has(t)){const e=this._renderer.removeNode(t);this._renderedNodes.delete(t),this._memCache.put(e.id.toString(),e)}}_addToRenderer(t){this._renderedNodes.has(t.id)||(this._renderedNodes.add(t.id),this._renderer.addNode(t))}_setupRendererData(t,e){const i=this._index.getNode(t),s=Math.sqrt(i.lodThreshold/i.vertexCount),r=this._index.getRenderObb(t);if(Qi(e))return e.splatSize=s,e.obb=r,ui(e.origin,e.obb.center),e;const n=ie.fromData(e.obbData),a=n.halfSize,o=r.halfSize,d=.01*Math.max(o[0],o[1],o[2]);if(a[0]>o[0]+d||a[1]>o[1]+d||a[2]>o[2]+d){if(this._maxLoggedBoxWarnings>0){const l=u=>`[${u.halfSize[0]}, ${u.halfSize[1]}, ${u.halfSize[2]}]`;se.getLogger(this).warn(`Node ${t} reported bounding box too small. got ${l(r)} but points cover ${l(n)}`),--this._maxLoggedBoxWarnings==0&&se.getLogger(this).warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(t,n)}return new Wi(t,s,ci(r.center),r,i.childCount===0,e.points,e.rgb,e.attributes,e.pointIdFilterMap)}get usedMemory(){let t=0;return this._renderer.forEachNode(e=>{t+=he,t+=Ee(e.coordinates);for(const i of e.attributes){const s=i.values;pi(s.buffer)&&(t+=Ee(s))}}),t}get unloadedMemory(){const t=this._renderedNodes.size;if(t<4)return 0;const e=[...this._renderedNodes].reduce((s,r)=>s+this._index.getNode(r).vertexCount);let i=this._loadingNodes.size;for(let s=0;s<this._workQueue.length;s++)i+=this._workQueue[s].load.length,i-=this._workQueue[s].remove.length;return i<0?0:i*e/t*((this.usedMemory-t*he)/e)+i*he}get performanceInfo(){return new Ni(this.usedMemory,this._renderedNodes.size,[...this._renderedNodes].reduce((t,e)=>t+this._index.getNode(e).vertexCount,0),this.maximumPointCount,new Ai(this._loadingNodes.size,this._indexQueue.length,this._workQueue.length,this._idleQueue.length))}get test(){}};_([y()],m.prototype,"layer",void 0),_([y()],m.prototype,"baseUrl",null),_([y()],m.prototype,"pointScale",null),_([y()],m.prototype,"useRealWorldSymbolSizes",null),_([y()],m.prototype,"pointSize",null),_([y()],m.prototype,"inverseDensity",null),_([y()],m.prototype,"maximumPointCount",void 0),_([y({readOnly:!0})],m.prototype,"availableFields",null),_([y({readOnly:!0})],m.prototype,"_clippingBox",null),_([y({readOnly:!0})],m.prototype,"_elevationOffset",null),_([y({type:Boolean})],m.prototype,"slicePlaneEnabled",void 0),_([y()],m.prototype,"updating",void 0),_([y(_i)],m.prototype,"updatingProgress",void 0),_([y({readOnly:!0})],m.prototype,"updatingProgressValue",null),_([y({readOnly:!0})],m.prototype,"visibleAtCurrentScale",null),m=_([pe("esri.views.3d.layers.PointCloudLayerView3D")],m);const fs=m,he=160;function Ki(t){return e=>t.immediate.schedule(e)}const Yi=Object.freeze(Object.defineProperty({__proto__:null,PointRendererDrawParameters:_e,PointRendererPassParameters:ge,build:je,getMaxPointSizeScreenspace:j},Symbol.toStringTag,{value:"Module"}));export{fs as default};
