import{da as pe,r as T,m as C,s0 as Q,cq as Te,cW as Ne,at as $e,a as ye,cR as we,gG as Re,gI as Me,gH as Ue,N as Oe,s1 as Ve,k as ze,aq as Ge,hZ as U,i2 as Je,i0 as A,K as ve,kl as He,cj as We,s2 as Ee,hH as Ze,dV as M,s3 as oe,s4 as qe,R as Be}from"./index-QRcEofMq.js";import{u as D,a1 as _e,a0 as se,B as L,C as O,y as x,aq as Ke,K as De,Z as xe,ab as Se,J as P,am as B,H as X,V as Qe,g as q,G as Ye,b as _,D as Xe,ar as et,as as ee,z as le}from"./arcade-BDgrpWRb.js";import{a as p,r as y}from"./unitConversion-wEUGv_jz.js";import{R as tt,q as ke,p as nt,c as ue,e as it,a as at,b as rt,N as ne,j as ot,F as st,E as lt,L as W,B as ut,d as te,f as R,k as de}from"./featureSetUtils-CsKsWBtt.js";import{l as dt}from"./portalUtils-a3Yg_e2a.js";import{u as ct,O as Ae}from"./SpatialFilter-CuwhpB7q.js";import{D as N}from"./WhereClause-Cu3aXYZu.js";import"./number-BF-GsnDh.js";import"./hash-CcEbRgUF.js";import"./operatorsWorkerConnection-CBYTNnuW.js";var Ce;(function(n){n[n.RTJunctionJunctionConnectivity=1]="RTJunctionJunctionConnectivity",n[n.RTContainment=2]="RTContainment",n[n.RTAttachment=3]="RTAttachment",n[n.RTJunctionEdgeConnectivity=4]="RTJunctionEdgeConnectivity",n[n.RTEdgeJunctionEdgeConnectivity=5]="RTEdgeJunctionEdgeConnectivity"})(Ce||(Ce={}));new pe({connected:"connected",upstream:"upstream",downstream:"downstream",shortestPath:"shortest-path",subnetwork:"subnetwork",subnetworkController:"subnetwork-controller",loops:"loops",isolation:"isolation"});const z=new pe({junctionJunctionConnectivity:"junction-junction-connectivity",connectivity:"connectivity",attachment:"attachment",containment:"containment",junctionEdgeFromConnectivity:"junction-edge-from-connectivity",junctionEdgeMidspanConnectivity:"junction-edge-midspan-connectivity",junctionEdgeToConnectivity:"junction-edge-to-connectivity"});new pe({normal:"normal",rebuild:"rebuild",forceRebuild:"force-rebuild"});let k=class extends we{constructor(t){super(t),this.globalId=null,this.associationType=null,this.fromNetworkElement=null,this.toNetworkElement=null,this.geometry=null,this.errorMessage=null,this.percentAlong=null,this.errorCode=null,this.isContentVisible=null,this.status=null}readFromNetworkElement(t,a){return new Q({globalId:a.fromGlobalId,networkSourceId:a.fromNetworkSourceId,terminalId:a.fromTerminalId})}writeFromNetworkElement(t,a){t&&(a.fromGlobalId=t.globalId,a.fromNetworkSourceId=t.networkSourceId,a.fromTerminalId=t.terminalId)}readToNetworkElement(t,a){return new Q({globalId:a.toGlobalId,networkSourceId:a.toNetworkSourceId,terminalId:a.toTerminalId})}writeToNetworkElement(t,a){t&&(a.toGlobalId=t.globalId,a.toNetworkSourceId=t.networkSourceId,a.toTerminalId=t.terminalId)}};T([C({type:String,json:{write:!0}})],k.prototype,"globalId",void 0),T([C({type:z.apiValues,json:{type:z.jsonValues,read:z.read,write:z.write}})],k.prototype,"associationType",void 0),T([C({type:Q,json:{write:{target:{fromGlobalId:{type:String},fromNetworkSourceId:{type:Number},fromTerminalId:{type:Number}}},read:{source:["fromGlobalId","fromNetworkSourceId","fromTerminalId"]}}})],k.prototype,"fromNetworkElement",void 0),T([Te("fromNetworkElement")],k.prototype,"readFromNetworkElement",null),T([Ne("fromNetworkElement")],k.prototype,"writeFromNetworkElement",null),T([C({type:Q,json:{write:{target:{toGlobalId:{type:String},toNetworkSourceId:{type:Number},toTerminalId:{type:Number}}},read:{source:["toGlobalId","toNetworkSourceId","toTerminalId"]}}})],k.prototype,"toNetworkElement",void 0),T([Te("toNetworkElement")],k.prototype,"readToNetworkElement",null),T([Ne("toNetworkElement")],k.prototype,"writeToNetworkElement",null),T([C({type:$e,json:{write:!0}})],k.prototype,"geometry",void 0),T([C({type:String,json:{write:!0}})],k.prototype,"errorMessage",void 0),T([C({type:Number,json:{write:!0}})],k.prototype,"percentAlong",void 0),T([C({type:Number,json:{write:!0}})],k.prototype,"errorCode",void 0),T([C({type:Boolean,json:{write:!0}})],k.prototype,"isContentVisible",void 0),T([C({type:Number,json:{write:!0}})],k.prototype,"status",void 0),k=T([ye("esri.rest.networks.support.Association")],k);const ft=k;let ie=class extends we{constructor(t){super(t),this.associations=[]}};T([C({type:[ft],json:{write:!0}})],ie.prototype,"associations",void 0),ie=T([ye("esri.rest.networks.support.QueryAssociationsResult")],ie);const mt=ie;function pt(n){const{returnDeletes:t,elements:a,gdbVersion:w,moment:g}=n.toJSON();return{returnDeletes:t,elements:JSON.stringify(a.map(e=>({globalId:e.globalId,networkSourceId:e.networkSourceId,terminalId:e.terminalId}))),types:JSON.stringify(n.types.map(e=>z.toJSON(e))).replaceAll('"connectivity"','"junctionJunctionConnectivity"'),gdbVersion:w,moment:g}}async function yt(n,t,a){const w=Re(n),g={...pt(t),f:"json"},e=Me({...w.query,...g}),i=Ue(e,{...a,method:"post"}),o=`${w.path}/associations/query`,{data:l}=await Oe(o,i),f=mt.fromJSON(l);return t.types.includes("connectivity")&&Ve(ze.getLogger("esri/rest/networks/support/QueryAssociationsParameters"),"types",{replacement:"Please use 'junction-junction-connectivity' instead of 'connectivity'.",see:"https://developers.arcgis.com/javascript/latest/api-reference/esri-rest-networks-support-QueryAssociationsParameters.html#types",version:"4.29",warnOnce:!0}),f}var fe;let H=fe=class extends we{static from(n){return Ge(fe,n)}constructor(n){super(n),this.returnDeletes=!1,this.elements=[],this.types=[],this.gdbVersion=null,this.moment=null}};T([C({type:Boolean,json:{write:!0}})],H.prototype,"returnDeletes",void 0),T([C({type:[Q],json:{write:!0}})],H.prototype,"elements",void 0),T([C({type:[z.apiValues],json:{type:z.jsonValues,read:z.read,write:z.write}})],H.prototype,"types",void 0),T([C({type:String,json:{write:!0}})],H.prototype,"gdbVersion",void 0),T([C({type:Date,json:{type:Number,write:{writer:(n,t)=>{t.moment=n==null?void 0:n.getTime()}}}})],H.prototype,"moment",void 0),H=fe=T([ye("esri.rest.networks.support.QueryAssociationsParameters")],H);const wt=H;function gt(n){if(n.length===1){if(A(n[0]))return le("distinct",n[0],-1);if(q(n[0]))return le("distinct",n[0].toArray(),-1)}return le("distinct",n,-1)}function ce(n,t,a){const w=n.getVariables();if(w.length>0){const g={};for(const e of w)g[e]=t.evaluateIdentifier(a,{name:e});n.parameters=g}return n}function c(n,t,a=null){for(const w in n)if(w.toLowerCase()===t.toLowerCase())return n[w];return a}function je(n){if(n===null)return null;const t={type:c(n,"type",""),name:c(n,"name","")};if(t.type==="range")t.range=c(n,"range",[]);else{t.codedValues=[];for(const a of c(n,"codedValues",[]))t.codedValues.push({name:c(a,"name",""),code:c(a,"code",null)})}return t}function me(n){if(n===null)return null;const t={},a=c(n,"wkt");a!==null&&(t.wkt=a);const w=c(n,"wkid");return w!==null&&(t.wkid=w),t}function Le(n){if(n===null)return null;const t={hasZ:c(n,"hasz",!1),hasM:c(n,"hasm",!1)},a=c(n,"spatialreference");a!=null&&(t.spatialReference=me(a));const w=c(n,"x",null);if(w!==null)return t.x=w,t.y=c(n,"y",null),t.hasZ&&(t.z=c(n,"z",null)),t.hasM&&(t.m=c(n,"m",null)),t;const g=c(n,"rings",null);if(g!==null)return t.rings=g,t;const e=c(n,"paths",null);if(e!==null)return t.paths=e,t;const i=c(n,"points",null);if(i!==null)return t.points=i,t;for(const o of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const l=c(n,o,null);l!==null&&(t[o]=l)}return t}function It(n,t){for(const a of t)if(a===n)return!0;return!1}function ht(n){return!!n.layerDefinition&&!!n.featureSet&&It(n.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&A(n.layerDefinition.fields)!==!1&&A(n.featureSet.features)!==!1}function K(n){return(n==null?void 0:n.toLowerCase())==="utc"?"UTC":(n==null?void 0:n.toLowerCase())==="unknown"?"Unknown":n}async function bt(n,t,a,w,g,e,i){var m,v,h;const o=await n.getFeatureSetInfo();if(((o==null?void 0:o.layerId)??null)===null||!g.layerIdLookup.get(o.layerId))return null;const l=n.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),f=[];switch(a){case"connected":f.push("connectivity"),f.push("junction-edge-from-connectivity"),f.push("junction-edge-to-connectivity"),f.push("junction-edge-midspan-connectivity"),f.push("junction-junction-connectivity");break;case"container":case"content":f.push("containment");break;case"structure":case"attached":f.push("attachment");break;case"junctionedge":f.push("junction-edge-from-connectivity"),f.push("junction-edge-to-connectivity");break;case"midspan":f.push("junction-edge-midspan-connectivity");break;default:throw new p(e,y.InvalidParameter,i)}let u=null,s=!1;if(w!==null&&w!==""&&w!==void 0){for(const I of g.terminals)I.terminalName===w&&(u=I.terminalId);u===null&&(s=!0)}const r=[];if(!s){const I=new Q({globalId:t.field(n.globalIdField),networkSourceId:g.layerIdLookup.get(o.layerId).sourceId,...u?{terminalId:u}:""}),E=await yt(l,new wt({types:f,elements:[I]}));let Y=0;for(const S of E.associations){let $=null,V="",j="";if(((m=S.fromNetworkElement)==null?void 0:m.globalId)===I.globalId?($=S.toNetworkElement,j="to"):((v=S.toNetworkElement)==null?void 0:v.globalId)===I.globalId&&($=S.fromNetworkElement,j="from"),!$)continue;switch(a){case"attached":if(S.associationType!=="attachment"||j!=="to")continue;break;case"structure":if(S.associationType!=="attachment"||j!=="from")continue;break;case"container":if(S.associationType!=="containment"||j!=="from")continue;break;case"content":if(S.associationType!=="containment"||j!=="to")continue;break;case"connected":break;case"junctionedge":S.associationType==="junction-edge-to-connectivity"?V="to":S.associationType==="junction-edge-from-connectivity"&&(V="from");break;case"midspan":if(S.associationType!=="junction-edge-midspan-connectivity")continue}const ae=((h=g.sourceIdLookup.get($.networkSourceId))==null?void 0:h.className)??"";r.push(new Be({geometry:null,attributes:{objectId:Y++,globalId:$.globalId,percentAlong:S.percentAlong??0,isContentVisible:S.isContentVisible?0:1,className:ae,side:V}}))}}const d=new Ze({source:r,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new M({name:"objectId",alias:"objectId",type:"oid"}),new M({name:"globalId",alias:"globalId",type:"global-id"}),new M({name:"percentAlong",alias:"percentAlong",type:"double"}),new M({name:"side",alias:"side",type:"string"}),new M({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new M({name:"className",alias:"className",type:"string"})]});return ne(d)}function Lt(n){n.mode==="async"&&(n.functions.timezone=function(t,a){return n.standardFunctionAsync(t,a,async(w,g,e)=>{var l,f;if(D(e,1,2,t,a),_e(e[0])||se(e[0]))return"Unknown";if(L(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?K("unknown"):K(e[0].dateFieldsTimeZone);if(!(e[1]instanceof O)||e[1].hasField("type")===!1)throw new p(t,y.InvalidParameter,a);const u=e[1].field("type");if(U(u)===!1)throw new p(t,y.InvalidParameter,a);switch(x(u).toLowerCase()){case"preferredtimezone":return K(e[0].preferredTimeZone);case"editfieldsinfo":return K(((l=e[0].editFieldsInfo)==null?void 0:l.timeZone)??null);case"timeinfo":return K(((f=e[0].timeInfo)==null?void 0:f.timeZone)??null);case"field":if(e[1].hasField("fieldname")&&U(e[1].field("fieldname")))return K(e[0].fieldTimeZone(x(e[1].field("fieldname"))))}throw new p(t,y.InvalidParameter,a)}const i=Ke(e[0],De(t));if(i===null)return null;const o=i.timeZone;return o==="system"?Je.systemTimeZoneCanonicalName:o.toLowerCase()==="utc"?"UTC":o.toLowerCase()==="unknown"?"Unknown":o})},n.functions.sqltimestamp=function(t,a){return n.standardFunctionAsync(t,a,async(w,g,e)=>{D(e,1,3,t,a);const i=e[0];if(xe(i)){if(e.length===1)return i.toSQLWithKeyword();if(e.length===2)return i.changeTimeZone(x(e[1])).toSQLWithKeyword();throw new p(t,y.InvalidParameter,a)}if(se(i))return i.toSQLWithKeyword();if(L(i)){if(e.length!==3)throw new p(t,y.InvalidParameter,a);await i.load();const o=x(e[1]);if(se(e[2]))return e[2].toSQLWithKeyword();if(xe(e[2])===!1)throw new p(t,y.InvalidParameter,a);const l=i.fieldTimeZone(o);return l==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(l).toSQLWithKeyword()}throw new p(t,y.InvalidParameter,a)})},n.signatures.push({name:"sqltimestamp",min:2,max:4}),n.functions.featuresetbyid=function(t,a){return n.standardFunctionAsync(t,a,(w,g,e)=>{if(D(e,2,4,t,a),Se(e[0])){const i=x(e[1]);let o=P(e[2],null);const l=B(P(e[3],!0));if(o===null&&(o=["*"]),A(o)===!1)throw new p(t,y.InvalidParameter,a);return e[0].featureSetById(i,l,o)}throw new p(t,y.InvalidParameter,a)})},n.signatures.push({name:"featuresetbyid",min:2,max:4}),n.functions.getfeatureset=function(t,a){return n.standardFunctionAsync(t,a,async(w,g,e)=>{if(D(e,1,2,t,a),X(e[0])){let i=P(e[1],"datasource");return i===null&&(i="datasource"),i=x(i).toLowerCase(),tt(e[0].fullSchema(),i,t.lrucache,t.interceptor,t.spatialReference??null)}throw new p(t,y.InvalidParameter,a)})},n.signatures.push({name:"getfeatureset",min:1,max:2}),n.functions.featuresetbyportalitem=function(t,a){return n.standardFunctionAsync(t,a,(w,g,e)=>{var u,s;if(D(e,2,5,t,a),e[0]===null)throw new p(t,y.PortalRequired,a);if(e[0]instanceof Qe){const r=x(e[1]),d=x(e[2]);let m=P(e[3],null);const v=B(P(e[4],!0));if(m===null&&(m=["*"]),A(m)===!1)throw new p(t,y.InvalidParameter,a);let h;return h=(u=t.services)!=null&&u.portal?t.services.portal:ve.getDefault(),h=dt(e[0],h),ke(r,d,t.spatialReference??null,m,v,h,t.lrucache,t.interceptor)}if(U(e[0])===!1)throw new p(t,y.PortalRequired,a);const i=x(e[0]),o=x(e[1]);let l=P(e[2],null);const f=B(P(e[3],!0));if(l===null&&(l=["*"]),A(l)===!1)throw new p(t,y.InvalidParameter,a);return ke(i,o,t.spatialReference??null,l,f,((s=t.services)==null?void 0:s.portal)??ve.getDefault(),t.lrucache,t.interceptor)})},n.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),n.functions.featuresetbyname=function(t,a){return n.standardFunctionAsync(t,a,(w,g,e)=>{if(D(e,2,4,t,a),Se(e[0])){const i=x(e[1]);let o=P(e[2],null);const l=B(P(e[3],!0));if(o===null&&(o=["*"]),A(o)===!1)throw new p(t,y.InvalidParameter,a);return e[0].featureSetByName(i,l,o)}throw new p(t,y.InvalidParameter,a)})},n.signatures.push({name:"featuresetbyname",min:2,max:4}),n.functions.featureset=function(t,a){return n.standardFunction(t,a,(w,g,e)=>{D(e,1,1,t,a);const i={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(U(e[0])){const o=JSON.parse(e[0]);o.layerDefinition!==void 0?(i.layerDefinition=o.layerDefinition,i.featureSet=o.featureSet,o.layerDefinition.spatialReference&&(i.layerDefinition.spatialReference=o.layerDefinition.spatialReference)):(i.featureSet.features=o.features,i.featureSet.geometryType=o.geometryType,i.layerDefinition.geometryType=i.featureSet.geometryType,i.layerDefinition.objectIdField=o.objectIdFieldName??"",i.layerDefinition.typeIdField=o.typeIdFieldName,i.layerDefinition.globalIdField=o.globalIdFieldName,i.layerDefinition.fields=o.fields,o.spatialReference&&(i.layerDefinition.spatialReference=o.spatialReference))}else{if(!(e[0]instanceof O))throw new p(t,y.InvalidParameter,a);{const o=JSON.parse(e[0].castToText(!0)),l=c(o,"layerdefinition");if(l!==null){i.layerDefinition.geometryType=c(l,"geometrytype",""),i.featureSet.geometryType=i.layerDefinition.geometryType,i.layerDefinition.globalIdField=c(l,"globalidfield",""),i.layerDefinition.objectIdField=c(l,"objectidfield",""),i.layerDefinition.typeIdField=c(l,"typeidfield",""),i.layerDefinition.hasZ=c(l,"hasz",!1)===!0,i.layerDefinition.hasM=c(l,"hasm",!1)===!0;const f=c(l,"spatialreference");f&&(i.layerDefinition.spatialReference=me(f));const u=[];for(const r of c(l,"fields",[])){const d={name:c(r,"name",""),alias:c(r,"alias",""),type:c(r,"type",""),nullable:c(r,"nullable",!0),editable:c(r,"editable",!0),length:c(r,"length",null),domain:je(c(r,"domain"))};u.push(d)}i.layerDefinition.fields=u;const s=c(o,"featureset");if(s){const r={};for(const d of u)r[d.name.toLowerCase()]=d.name;for(const d of c(s,"features",[])){const m={},v=c(d,"attributes",{});for(const h in v)m[r[h.toLowerCase()]]=v[h];i.featureSet.features.push({attributes:m,geometry:Le(c(d,"geometry"))})}}}else{i.layerDefinition.hasZ=c(o,"hasz",!1)===!0,i.layerDefinition.hasM=c(o,"hasm",!1)===!0,i.layerDefinition.geometryType=c(o,"geometrytype",""),i.featureSet.geometryType=i.layerDefinition.geometryType,i.layerDefinition.objectIdField=c(o,"objectidfieldname",""),i.layerDefinition.typeIdField=c(o,"typeidfieldname","");const f=c(o,"spatialreference");f&&(i.layerDefinition.spatialReference=me(f));const u=[],s=c(o,"fields",null);if(!A(s))throw new p(t,y.InvalidParameter,a);for(const m of s){const v={name:c(m,"name",""),alias:c(m,"alias",""),type:c(m,"type",""),nullable:c(m,"nullable",!0),editable:c(m,"editable",!0),length:c(m,"length",null),domain:je(c(m,"domain"))};u.push(v)}i.layerDefinition.fields=u;const r={};for(const m of u)r[m.name.toLowerCase()]=m.name;let d=c(o,"features",null);if(A(d))for(const m of d){const v={},h=c(m,"attributes",{});for(const I in h)v[r[I.toLowerCase()]]=h[I];i.featureSet.features.push({attributes:v,geometry:Le(c(m,"geometry",null))})}else d=null,i.featureSet.features=d}}}if(ht(i)===!1)throw new p(t,y.InvalidParameter,a);return i.layerDefinition.geometryType||(i.layerDefinition.geometryType="esriGeometryNull"),nt.create(i,t.spatialReference)})},n.signatures.push({name:"featureset",min:1,max:1}),n.functions.filter=function(t,a){return n.standardFunctionAsync(t,a,async(w,g,e)=>{if(D(e,2,2,t,a),A(e[0])||q(e[0])){const i=[];let o,l=e[0];if(l instanceof He&&(l=l.toArray()),!Ye(e[1]))throw new p(t,y.InvalidParameter,a);o=e[1].createFunction(t);for(const f of l){const u=o(f);We(u)?await u===!0&&i.push(f):u===!0&&i.push(f)}return i}if(L(e[0])){const i=await e[0].load(),o=N.create(e[1],{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),l=o.getVariables();if(l.length>0){const f={};for(const u of l)f[u]=n.evaluateIdentifier(t,{name:u});o.parameters=f}return new ue({parentfeatureset:e[0],whereclause:o})}throw new p(t,y.InvalidParameter,a)})},n.signatures.push({name:"filter",min:2,max:2}),n.functions.orderby=function(t,a){return n.standardFunctionAsync(t,a,async(w,g,e)=>{if(D(e,2,2,t,a),L(e[0])){const i=new it(e[1]);return new at({parentfeatureset:e[0],orderbyclause:i})}throw new p(t,y.InvalidParameter,a)})},n.signatures.push({name:"orderby",min:2,max:2}),n.functions.top=function(t,a){return n.standardFunctionAsync(t,a,async(w,g,e)=>{if(D(e,2,2,t,a),L(e[0]))return new rt({parentfeatureset:e[0],topnum:e[1]});if(A(e[0]))return _(e[1])>=e[0].length?e[0].slice():e[0].slice(0,_(e[1]));if(q(e[0]))return _(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,_(e[1]));throw new p(t,y.InvalidParameter,a)})},n.signatures.push({name:"top",min:2,max:2}),n.functions.first=function(t,a){return n.standardFunctionAsync(t,a,async(w,g,e)=>{if(D(e,1,1,t,a),L(e[0])){const i=await e[0].first(w.abortSignal);if(i!==null){const o=Xe.createFromGraphicLikeObject(i.geometry,i.attributes,e[0],t.timeZone);return o._underlyingGraphic=i,o}return i}return A(e[0])?e[0].length===0?null:e[0][0]:q(e[0])?e[0].length()===0?null:e[0].get(0):null})},n.signatures.push({name:"first",min:1,max:1}),n.functions.attachments=function(t,a){return n.standardFunctionAsync(t,a,async(w,g,e)=>{D(e,1,2,t,a);const i={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof O){if(e[1].hasField("minsize")&&(i.minsize=_(e[1].field("minsize"))),e[1].hasField("metadata")&&(i.returnMetadata=B(e[1].field("metadata"))),e[1].hasField("maxsize")&&(i.maxsize=_(e[1].field("maxsize"))),e[1].hasField("types")){const o=et(e[1].field("types"),!1);o.length>0&&(i.types=o)}}else if(e[1]!==null)throw new p(t,y.InvalidParameter,a)}if(X(e[0])){const o=e[0]._layer;let l;if(L(o))l=o;else{if(o==null||!Ee(o))return[];l=ne(o,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}return await l.load(),l.queryAttachments(e[0].field(l.objectIdField),i.minsize,i.maxsize,i.types,i.returnMetadata)}if(e[0]===null)return[];throw new p(t,y.InvalidParameter,a)})},n.signatures.push({name:"attachments",min:1,max:2}),n.functions.featuresetbyrelationshipname=function(t,a){return n.standardFunctionAsync(t,a,async(w,g,e)=>{D(e,2,4,t,a);const i=e[0],o=x(e[1]);let l=P(e[2],null);const f=B(P(e[3],!0));if(l===null&&(l=["*"]),A(l)===!1)throw new p(t,y.InvalidParameter,a);if(e[0]===null)return null;if(!X(e[0]))throw new p(t,y.InvalidParameter,a);const u=i._layer;let s;if(L(u))s=u;else{if(u==null||!Ee(u))return null;s=ne(u,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}s=await s.load();const r=s.relationshipMetaData().filter(I=>I.name===o);if(r.length===0)return null;if(r[0].relationshipTableId!==void 0&&r[0].relationshipTableId!==null&&r[0].relationshipTableId>-1)return ot(s,r[0],i.field(s.objectIdField),s.spatialReference,l,f,t.lrucache,t.interceptor);let d=s.serviceUrl();if(!d)return null;d=d.charAt(d.length-1)==="/"?d+r[0].relatedTableId.toString():d+"/"+r[0].relatedTableId.toString();const m=await st(d,s.spatialReference,l,f,t.lrucache,t.interceptor);await m.load();let v=m.relationshipMetaData();if(v=v.filter(I=>I.id===r[0].id),i.hasField(r[0].keyField)===!1||i.field(r[0].keyField)===null){const I=await s.getFeatureByObjectId(i.field(s.objectIdField),[r[0].keyField]);if(I){const E=N.create(v[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return E.parameters={id:I.attributes[r[0].keyField]},m.filter(E)}return new ct({parentfeatureset:m})}const h=N.create(v[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return h.parameters={id:i.field(r[0].keyField)},m.filter(h)})},n.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),n.functions.featuresetbyassociation=function(t,a){return n.standardFunctionAsync(t,a,async(w,g,e)=>{D(e,2,3,t,a);const i=e[0],o=x(P(e[1],"")).toLowerCase(),l=U(e[2])?x(e[2]):null;if(e[0]===null)return null;if(!X(e[0]))throw new p(t,y.InvalidParameter,a);let f=i._layer;if(f instanceof Ze&&(f=ne(f,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),f===null||L(f)===!1)return null;await f.load();const u=f.serviceUrl(),s=await lt(u,t.spatialReference,!0);if(s.unVersion>=8)return await bt(f,i,o,l,s,t,a);const r=s.associations;let d=null,m=null,v=!1;if(l!==null&&l!==""&&l!==void 0){for(const F of s.terminals)F.terminalName===l&&(m=F.terminalId);m===null&&(v=!0)}const h=r.getFieldsIndex(),I=h.get("TOGLOBALID").name,E=h.get("FROMGLOBALID").name,Y=h.get("TOTERMINALID").name,S=h.get("FROMTERMINALID").name,$=h.get("FROMNETWORKSOURCEID").name,V=h.get("TONETWORKSOURCEID").name,j=h.get("ASSOCIATIONTYPE").name,ae=h.get("ISCONTENTVISIBLE").name,Pe=h.get("OBJECTID").name;for(const F of f.fields)if(F.type==="global-id"){d=i.field(F.name);break}let G=null,ge=new W(new M({name:"percentalong",alias:"percentalong",type:"double"}),N.create("0",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),Ie=new W(new M({name:"side",alias:"side",type:"string"}),N.create("''",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));const Z="globalid",he="globalId",be={};for(const F in s.lkp)be[F]=s.lkp[F].sourceId;const J=new ut(new M({name:"classname",alias:"classname",type:"string"}),null,be);let b="";switch(o){case"midspan":{b=`((${I}='${d}') OR ( ${E}='${d}')) AND (${j} IN (5))`,J.codefield=N.create(`CASE WHEN (${I}='${d}') THEN ${$} ELSE ${V} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const F=oe(R.findField(r.fields,E));F.name=Z,F.alias=Z,G=new W(F,N.create(`CASE WHEN (${E}='${d}') THEN ${I} ELSE ${E} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),ge=s.unVersion>=4?new de(R.findField(r.fields,h.get("PERCENTALONG").name)):new W(new M({name:"percentalong",alias:"percentalong",type:"double"}),N.create("0",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{b=`((${I}='${d}') OR ( ${E}='${d}')) AND (${j} IN (4,6))`,J.codefield=N.create(`CASE WHEN (${I}='${d}') THEN ${$} ELSE ${V} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const F=oe(R.findField(r.fields,E));F.name=Z,F.alias=Z,G=new W(F,N.create(`CASE WHEN (${E}='${d}') THEN ${I} ELSE ${E} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),Ie=new W(new M({name:"side",alias:"side",type:"string"}),N.create(`CASE WHEN (${j}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let F=`${I}='@T'`,Fe=`${E}='@T'`;m!==null&&(F+=` AND ${Y}=@A`,Fe+=` AND ${S}=@A`),b="(("+F+") OR ("+Fe+"))",b=ee(b,"@T",d??""),F=ee(F,"@T",d??""),m!==null&&(F=ee(F,"@A",m.toString()),b=ee(b,"@A",m.toString())),J.codefield=N.create("CASE WHEN "+F+` THEN ${$} ELSE ${V} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const re=oe(R.findField(r.fields,E));re.name=Z,re.alias=Z,G=new W(re,N.create("CASE WHEN "+F+` THEN ${E} ELSE ${I} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"container":b=`${I}='${d}' AND ${j} = 2`,m!==null&&(b+=` AND ${Y} = `+m.toString()),J.codefield=$,b="( "+b+" )",G=new te(R.findField(r.fields,E),Z,Z);break;case"content":b=`(${E}='${d}' AND ${j} = 2)`,m!==null&&(b+=` AND ${S} = `+m.toString()),J.codefield=V,b="( "+b+" )",G=new te(R.findField(r.fields,I),Z,Z);break;case"structure":b=`(${I}='${d}' AND ${j} = 3)`,m!==null&&(b+=` AND ${Y} = `+m.toString()),J.codefield=$,b="( "+b+" )",G=new te(R.findField(r.fields,E),Z,he);break;case"attached":b=`(${E}='${d}' AND ${j} = 3)`,m!==null&&(b+=` AND ${S} = `+m.toString()),J.codefield=V,b="( "+b+" )",G=new te(R.findField(r.fields,I),Z,he);break;default:throw new p(t,y.InvalidParameter,a)}return v&&(b="1 <> 1"),new R({parentfeatureset:r,adaptedFields:[new de(R.findField(r.fields,Pe)),new de(R.findField(r.fields,ae)),G,Ie,J,ge],extraFilter:b?N.create(b,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}):null})})},n.signatures.push({name:"featuresetbyassociation",min:2,max:6}),n.functions.groupby=function(t,a){return n.standardFunctionAsync(t,a,async(w,g,e)=>{if(D(e,3,3,t,a),!L(e[0]))throw new p(t,y.InvalidParameter,a);const i=await e[0].load(),o=[],l=[];let f=!1,u=[];if(U(e[1]))u.push(e[1]);else if(e[1]instanceof O)u.push(e[1]);else if(A(e[1]))u=e[1];else{if(!q(e[1]))throw new p(t,y.InvalidParameter,a);u=e[1].toArray()}for(const s of u)if(U(s)){const r=N.create(x(s),{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),d=Ae(r)===!0?x(s):"%%%%FIELDNAME";o.push({name:d,expression:r}),d==="%%%%FIELDNAME"&&(f=!0)}else{if(!(s instanceof O))throw new p(t,y.InvalidParameter,a);{const r=s.hasField("name")?s.field("name"):"%%%%FIELDNAME",d=s.hasField("expression")?s.field("expression"):"";if(r==="%%%%FIELDNAME"&&(f=!0),!r)throw new p(t,y.InvalidParameter,a);o.push({name:r,expression:N.create(d||r,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(u=[],U(e[2]))u.push(e[2]);else if(A(e[2]))u=e[2];else if(q(e[2]))u=e[2].toArray();else{if(!(e[2]instanceof O))throw new p(t,y.InvalidParameter,a);u.push(e[2])}for(const s of u){if(!(s instanceof O))throw new p(t,y.InvalidParameter,a);{const r=s.hasField("name")?s.field("name"):"",d=s.hasField("statistic")?s.field("statistic"):"",m=s.hasField("expression")?s.field("expression"):"";if(!r||!d||!m)throw new p(t,y.InvalidParameter,a);l.push({name:r,statistic:d.toLowerCase(),expression:N.create(m,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(f){const s={};for(const d of i.fields)s[d.name.toLowerCase()]=1;for(const d of o)d.name!=="%%%%FIELDNAME"&&(s[d.name.toLowerCase()]=1);for(const d of l)d.name!=="%%%%FIELDNAME"&&(s[d.name.toLowerCase()]=1);let r=0;for(const d of o)if(d.name==="%%%%FIELDNAME"){for(;s["field_"+r.toString()]===1;)r++;s["field_"+r.toString()]=1,d.name="FIELD_"+r.toString()}}for(const s of o)ce(s.expression,n,t);for(const s of l)ce(s.expression,n,t);return e[0].groupby(o,l)})},n.signatures.push({name:"groupby",min:3,max:3}),n.functions.distinct=function(t,a){return n.standardFunctionAsync(t,a,async(w,g,e)=>{if(L(e[0])){D(e,2,2,t,a);const i=await e[0].load(),o=[];let l=[];if(U(e[1]))l.push(e[1]);else if(e[1]instanceof O)l.push(e[1]);else if(A(e[1]))l=e[1];else{if(!q(e[1]))throw new p(t,y.InvalidParameter,a);l=e[1].toArray()}let f=!1;for(const u of l)if(U(u)){const s=N.create(x(u),{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),r=Ae(s)===!0?x(u):"%%%%FIELDNAME";o.push({name:r,expression:s}),r==="%%%%FIELDNAME"&&(f=!0)}else{if(!(u instanceof O))throw new p(t,y.InvalidParameter,a);{const s=u.hasField("name")?u.field("name"):"%%%%FIELDNAME",r=u.hasField("expression")?u.field("expression"):"";if(s==="%%%%FIELDNAME"&&(f=!0),!s)throw new p(t,y.InvalidParameter,a);o.push({name:s,expression:N.create(r||s,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(f){const u={};for(const r of i.fields)u[r.name.toLowerCase()]=1;for(const r of o)r.name!=="%%%%FIELDNAME"&&(u[r.name.toLowerCase()]=1);let s=0;for(const r of o)if(r.name==="%%%%FIELDNAME"){for(;u["field_"+s.toString()]===1;)s++;u["field_"+s.toString()]=1,r.name="FIELD_"+s.toString()}}for(const u of o)ce(u.expression,n,t);return e[0].groupby(o,[])}return gt(e)})},n.functions.getfeaturesetinfo=function(t,a){return n.standardFunctionAsync(t,a,async(w,g,e)=>{if(D(e,1,1,t,a),!L(e[0]))return null;const i=await e[0].getFeatureSetInfo();return i?O.convertObjectToArcadeDictionary({layerId:i.layerId,layerName:i.layerName,itemId:i.itemId,serviceLayerUrl:i.serviceLayerUrl,webMapLayerId:i.webMapLayerId??null,webMapLayerTitle:i.webMapLayerTitle??null,className:null,objectClassId:null},De(t),!1,!1):null})},n.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),n.functions.filterbysubtypecode=function(t,a){return n.standardFunctionAsync(t,a,async(w,g,e)=>{if(D(e,2,2,t,a),L(e[0])){const i=await e[0].load(),o=e[1];if(!qe(o))throw new p(t,y.InvalidParameter,a);if(i.subtypeField){const f=N.create(`${i.subtypeField}= ${e[1]}`,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC});return new ue({parentfeatureset:e[0],whereclause:f})}if(i.typeIdField===null||i.typeIdField==="")throw new p(t,y.FeatureSetDoesNotHaveSubtypes,a);const l=N.create(`${i.typeIdField}= ${e[1]}`,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC});return new ue({parentfeatureset:e[0],whereclause:l})}throw new p(t,y.InvalidParameter,a)})},n.signatures.push({name:"filterbysubtypecode",min:2,max:2}))}export{Lt as registerFunctions};
