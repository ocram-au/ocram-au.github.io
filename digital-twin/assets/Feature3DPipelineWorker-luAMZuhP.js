import{g as fe,f9 as Y,jU as ge,j6 as pe,cz as se,d5 as _e,cT as Z,d3 as we,p as xe,r as w,m as I,a as ie,q4 as M,cC as ae,wT as oe,pb as ye,g2 as Q,q3 as be,mi as Ie,x9 as Ce,ay as k,xq as ve,F as $e,xr as Ae,xs as Se,xt as Re,fR as Te,en as Oe,o as W,xu as Ee,c3 as Me,bY as F,eP as Fe,xv as Be,n1 as Pe,bF as g,k_ as je,xw as Le,bN as Ge,gj as ke,r5 as Ne,bP as De,wk as Qe,xx as We,xy as ze,d9 as Ue,gF as He,eG as V,gE as qe,xz as Je,jg as Ye,w5 as Ze,xA as Ve,bZ as Xe,c0 as A,ar as X,a9 as K,nc as Ke,aN as et,gt as tt,dd as rt,e as nt,P as st}from"./index-Bmji7YKu.js";import{L as it}from"./QueryEngine-CIqjg9ay.js";import{s as at,E as de}from"./PooledRBush-GdX1dTZ5.js";import{R as ot}from"./FeaturePipelineRenderManager-C-R-tp_d.js";import"./WhereClauseCache-C_V6N-iD.js";import"./WhereClause-Cnx4wT50.js";import"./FixedIntervalBinParameters-B90WFk4v.js";import"./json-Wa8cmqdu.js";import"./QueryEngineCapabilities-B_pTbIiR.js";import"./utils-Cmxu2nYF.js";import"./utils-Du92bfD6.js";import"./ClassBreaksDefinition-CDWAACCF.js";import"./quickselect-QQC62dOK.js";import"./LodRenderer-RuCiKklE.js";let _=class extends fe{constructor(e){super(e),this._updatingCount=0,this._tileHandles=new Y,this._wanted=new Y}destroy(){for(const e of this._tileHandles.values())e.abort();this._tileHandles.clear(),this._wanted.clear()}get updating(){return this._updatingCount>0}get _boundingRect(){const{extent:e}=this;return e==null?null:ge(e)}get _missingTiles(){const e=new Array,t=this._wanted;for(const r of this._tileHandles.values())t.has(r.id)&&!E(r)&&e.push(r);return e}async onTileTreeChange(e){++this._updatingCount;try{const{added:t,removed:r}=e,n=this._tileHandles,{_boundingRect:s}=this,a=s!=null?t.filter(c=>pe(s,c.extent)):t,o=this._wanted,l=new Array;for(const c of r){const{id:d}=c;if(o.delete(d),t.some(f=>$(f,c)||$(c,f)))continue;const u=n.get(d);u!=null&&l.push(this._removeTile(u))}for(const c of a)o.set(c.id,c),l.push(this._addTile(c));await Promise.allSettled(l)}finally{--this._updatingCount}}async _removeTile(e){this._tileHandles.delete(e.id),e.abort(),this._validate();const{tile:t}=e,r=new T(e.untilSettled(),t!=null?this.createRemoveTileCommand(t):null);e.nextEvent=null;const{command:n}=await r.getCommand();n==null||n.execute()}async _addTile(e){const{_tileHandles:t}=this,r=t.get(e.id);if(r!=null)return!E(r)||r.tile.isComplete||(r.tile=r.tile.reset(),r.nextEvent=this._onTileLoad(r)),void await r.untilSettled();const n=new dt(e);this._tileHandles.set(n.id,n);const s=this.loadTile(e,n.signal);n.nextEvent=s;const a=await s;if(n.aborted)throw se();n.tile=a,lt(n),n.nextEvent=this._onTileLoad(n),await n.untilSettled()}async _onTileLoad(e){const{_wanted:t,_tileHandles:r,_missingTiles:n}=this,s=e.descriptor,a=new Array,o=new Array,l=new Set;for(const d of r.values()){if(d===e)continue;const{descriptor:u,id:f}=d;if(t.has(f)||n.some(({descriptor:h})=>$(h,u)||$(u,h))){if(E(d)){if($(s,u)){const h=d.tile;for(const m of h.objectIds())l.add(m)}if($(u,s)){const h=e.tile,m=new Set(h.objectIds()),p=d.tile,x=p.exclude(m);d.tile=x;const y=AbortSignal.any([d.signal,e.signal]),b=d.untilSettled();a.push(new T(b,this.createRemoveTileCommand(p))),a.push(new T(b,this.createAddTileCommand(x,y),y)),o.push(d),this._validateRemoval(x,m)}}}else{d.abort(),r.delete(f);const{tile:h}=d;h!=null&&a.push(new T(d.untilSettled(),this.createRemoveTileCommand(h))),d.nextEvent=null}}l.size>0&&(e.tile=e.tile.exclude(l),this._validateRemoval(e.tile,l)),a.push(new T(e.untilSettled(),this.createAddTileCommand(e.tile,e.signal),e.signal)),o.push(e),this._validate();const c=this._joinCommands(a);for(const d of o)d.nextEvent=c;await c}async _joinCommands(e){const t=(await Promise.allSettled(e.map(async r=>r.getCommand()))).map(r=>{var n;return r.status!=="fulfilled"||(n=r.value.signal)!=null&&n.aborted?null:r.value.command}).filter(_e);t.length!==0&&t.reduce((r,n)=>(r.append(n),r)).execute()}_validate(){if(!Z("feature-pipeline-3d-test-validation"))return;const e=new Array;for(const t of this._tileHandles.values()){if(!E(t))continue;const{tile:r}=t,n=r.featureCount,s=new Uint32Array(n);r.readObjectIds(s),e.push({tile:r,objectIds:new Set(s)})}for(let t=0;t<e.length;++t){const{tile:r,objectIds:n}=e[t];for(let s=t+1;s<e.length;++s){const{tile:a,objectIds:o}=e[s];for(const l of o)if(n.has(l)){const c=$(a.descriptor,r.descriptor),d=$(r.descriptor,a.descriptor);throw new Error(`${r.descriptor.id} and ${a.descriptor.id} both contain ${l}. aInB: ${c}; bInA: ${d}`)}}}}_validateRemoval(e,t){if(Z("feature-pipeline-3d-test-validation")){for(const r of e.objectIds())if(t.has(r))throw new Error(`Failed to remove ${r} from ${e.descriptor.id}!`)}}};function $({lij:[i,e,t]},{lij:[r,n,s]}){const a=r-i;return a>=0&&e===n>>a&&t===s>>a}w([I()],_.prototype,"updating",null),w([I({constructOnly:!0})],_.prototype,"loadTile",void 0),w([I({constructOnly:!0})],_.prototype,"createAddTileCommand",void 0),w([I({constructOnly:!0})],_.prototype,"createRemoveTileCommand",void 0),w([I()],_.prototype,"_updatingCount",void 0),w([I()],_.prototype,"extent",void 0),w([I()],_.prototype,"_boundingRect",null),w([I()],_.prototype,"_missingTiles",null),_=w([ie("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],_);let dt=class{constructor(e){this.descriptor=e,this._controller=new AbortController,this._tile=we(null),this.nextEvent=null}get id(){return this.descriptor.id}get tile(){return this._tile.value}set tile(e){this._tile.value=e}get signal(){return this._controller.signal}abort(){this._controller.abort()}get aborted(){return this._controller.signal.aborted}async untilSettled(){try{await this.nextEvent}catch(e){xe(e)||console.error(e)}}};function E(i){return i.tile!=null}function lt(i){if(!E(i))throw new Error}let T=class{constructor(e,t,r){this.previousEventSettled=e,this.commandPromise=t,this.signal=r}async getCommand(){const{previousEventSettled:e,commandPromise:t,signal:r}=this,[n]=await Promise.all([t,e]);if(r!=null&&r.aborted)throw se();return{command:n,signal:r}}},ct=class z{constructor(e,t){this.tile=e,this._tileIndices=t}get id(){return this.tile.id}get featureCount(){var e;return((e=this._tileIndices)==null?void 0:e.length)??this.tile.featureCount}get usedMemory(){var e;return M+(((e=this._tileIndices)==null?void 0:e.byteLength)??0)}get extent(){return this.tile.descriptor.extent}readObjectIds(e,t){const{_tileIndices:r,tile:n}=this;return n.readObjectIds(e,r,t)}readCoordinates(e,t){const{_tileIndices:r,tile:n}=this;return n.readCoordinates(e,r,t)}subset(e){const{_tileIndices:t,tile:r}=this;if(t==null)return new z(r,e);const n=new Uint32Array(e.length);for(let s=0;s<n.length;++s)n[s]=t[e[s]];return new z(r,n)}},ut=class{constructor(){this._tileToFeatureData=new Map}add(e){this._tileToFeatureData.set(e.tile,e)}remove(e){this._tileToFeatureData.delete(e)}get(e){return this._tileToFeatureData.get(e)}},U=class{constructor(e,t){this._index=e,this._view=t}get usedMemory(){return M+oe}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(e){return this._view.getAttribute(this._index,e)}getAttributeAsTimestamp(e){return this._view.getAttributeAsTimestamp(this._index,e)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(e){return this._view.getCentroid(this._index,e)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(e){return new ht(this._index,this._view,e)}},ht=class extends U{constructor(e,t,r){super(e,t),this._geometryOverride=r}getOptimizedGeometry(){return this._geometryOverride}getCentroid(e){return ye(new Q,this._geometryOverride,e.hasZ,e.hasM)}};class mt{constructor(){this._tileBounds=new Map,this.events=new ae,this.featureAdapter=H.shared}get usedMemory(){return M+M*this._tileBounds.size}addTile(e){const{featureCount:t}=e;if(t===0)return;const r=new at(9,s=>e.getBounds(s)),n=new Array;for(let s=0;s<t;++s)n[s]=s;r.load(n),this._tileBounds.set(e,r),this.events.emit("changed")}removeTile(e){this._tileBounds.delete(e),this.events.emit("changed")}clear(){this._tileBounds.clear(),this.events.emit("changed")}forEach(e){for(const[t,r]of this._tileBounds)r.all(n=>e(new U(n,t)))}forEachInBounds(e,t){O.minX=e[0],O.minY=e[1],O.maxX=e[2],O.maxY=e[3];for(const[r,n]of this._tileBounds)n.search(O,s=>t(new U(s,r)))}forEachBounds(e,t){for(const r of e)t(r.getBoundingBox())}getFullExtent(e){let t=1/0,r=1/0,n=-1/0,s=-1/0;for(const a of this._tileBounds.values()){const{minX:o,minY:l,maxX:c,maxY:d}=a.toJSON();t=Math.min(t,o),r=Math.min(r,l),n=Math.min(n,c),s=Math.min(s,d)}return{xmin:t,ymin:r,xmax:n,ymax:s,spatialReference:e}}}let H=class{getObjectId(e){return e.getObjectId()}getAttribute(e,t){return e.getAttribute(t)}getAttributeAsTimestamp(e,t){return e.getAttributeAsTimestamp(t)}getAttributes(e){return e.getAttributes()}getGeometry(e){return e.getOptimizedGeometry()}getCentroid(e,t){return e.getCentroid(t)}cloneWithGeometry(e,t){return e.cloneWithGeometry(t)}};H.shared=new H;const O=new de;let ft=class q{constructor(e,t,r=gt(t)){this.descriptor=e,this._pages=t,this._addressTable=r;const n=be+t.reduce((o,{usedMemory:l})=>o+l,0),s=3*oe,a=Ie(r);this.usedMemory=M+n+s+a,this.featureCount=Math.floor(this._addressTable.length/2),this.isComplete=this.featureCount===t.reduce((o,l)=>o+l.featureCount,0)}get id(){return this.descriptor.id}getObjectId(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getObjectId(r)}getAttribute(e,t){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getAttribute(n,t)}getAttributeAsTimestamp(e,t){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getAttributeAsTimestamp(n,t)}getAttributes(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getAttributes(r)}getCoordinates(e,t,r){const{pageIndex:n,featurePageIndex:s}=this._translateIndex(e);this._pages[n].getCoordinates(s,t,r)}getOptimizedGeometry(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getOptimizedGeometry(r)}getCentroid(e,t){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getCentroid(n,t)}getBounds(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getBounds(r)}getBoundingBox(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getBoundingBox(r)}readObjectIds(e,t=this._allFeatureIndices(),r=0){let n=r;for(const{page:s,indices:a}of this._batchPageIndices(t))n=s.readObjectIds(e,a,n);return n}readCoordinates(e,t=this._allFeatureIndices(),r=0){let n=r;for(const{page:s,indices:a}of this._batchPageIndices(t))n=s.readCoordinates(e,a,n);return n}*objectIds(e=this._allFeatureIndices()){for(const{page:t,indices:r}of this._batchPageIndices(e))for(const n of t.objectIds(r))yield n}exclude(e){if(e.size===0)return this;const{_addressTable:t,featureCount:r}=this,n=new Array;for(let s=0;s<r;++s){const a=this.getObjectId(s);e.has(a)||(n.push(t[2*s]),n.push(t[2*s+1]))}return new q(this.descriptor,this._pages,n)}reset(){const{isComplete:e,_pages:t}=this;return e?this:new q(this.descriptor,t)}*_allFeatureIndices(){const{featureCount:e}=this;for(let t=0;t<e;++t)yield t}_translateIndex(e){const{_addressTable:t}=this;return{pageIndex:t[2*e],featurePageIndex:t[2*e+1]}}*_batchPageIndices(e){const t=new Array;{let n=0,s=new Array;for(const a of e){const{pageIndex:o,featurePageIndex:l}=this._translateIndex(a);n!==o&&(s.length!==0&&t.push({pageIndex:n,indices:s}),n=o,s=[]),s.push(l)}s.length!==0&&t.push({pageIndex:n,indices:s})}const{_pages:r}=this;for(const{pageIndex:n,indices:s}of t)yield{page:r[n],indices:s}}};function gt(i){const e=i.reduce((n,{featureCount:s})=>n+s,0),t=new Array;if(e===0)return t;const r=i[0].featureCount;for(let n=0;n<e;++n)t[2*n]=Math.floor(n/r),t[2*n+1]=n%r;return t}let pt=class{constructor(e){this._reader=new Ce(new Uint8Array(e),new DataView(e)),this._index=_t(this._reader)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}get usedMemory(){return this._reader.usedMemory}getObjectId(e){return this.getAttribute(e,this._index.objectIdFieldName)}getAttribute(e,t){var l;const{_index:{fieldsIndex:r,attributeIndices:n}}=this,s=(l=r.get(t))==null?void 0:l.index;if(s==null)return;const a=n[e*r.fields.length+s],o=this._reader;return o.move(a),B(o)}getAttributeAsTimestamp(e,t){const r=this.getAttribute(e,t);return typeof r=="string"?new Date(r).getTime():typeof r=="number"||r==null?r:null}getAttributes(e){const{_index:{fieldsIndex:t,attributeIndices:r}}=this,n=e*t.fields.length,s=this._reader,a={};for(const o of t.fields){const l=r[n+o.index];s.move(l),a[o.name]=B(s)}return a}getCoordinates(e,t,r=0){const n=this._reader,{transform:s,featureIndices:a}=this._index,{scale:o,translate:l}=s;n.move(a[e]),this._readCoordinates(o,l,t,r)}getOptimizedGeometry(e){const t=k();return this.getCoordinates(e,t),new Q([],t)}getCentroid(e,{hasZ:t,hasM:r}){this.getCoordinates(e,S);const[n,s,a]=S,o=[n,s];return t&&(o[3]=a),r&&(o[t?4:3]=0),new Q([],o)}getBounds(e){this.getCoordinates(e,S);const[t,r]=S,n=new de;return n.minX=t,n.minY=r,n.maxX=t,n.maxY=r,n}getBoundingBox(e){this.getCoordinates(e,S);const[t,r,n]=S;return ve(t,r,n,t,r,n)}readObjectIds(e,t=this._allFeatureIndices(),r=0){const n=this._reader,{objectIdFieldName:s,attributeIndices:a,fieldsIndex:o}=this._index,l=o.get(s).index,c=o.fields.length;for(const d of t){const u=a[d*c+l];n.move(u),e[r++]=B(n)}return r}readCoordinates(e,t=this._allFeatureIndices(),r=0){const n=this._reader,{transform:s,featureIndices:a}=this._index,{scale:o,translate:l}=s;for(const c of t){const d=a[c];n.move(d),r=this._readCoordinates(o,l,e,r)}return r}*objectIds(e=this._allFeatureIndices()){const t=this._reader,{objectIdFieldName:r,attributeIndices:n,fieldsIndex:s}=this._index,a=s.get(r).index,o=s.fields.length;for(const l of e){const c=n[l*o+a];t.move(c),yield B(t)}}*_allFeatureIndices(){const{featureCount:e}=this;for(let t=0;t<e;++t)yield t}_readCoordinates([e,t,r],[n,s,a],o,l){const u=this._reader,f=u.getLength(),h=u.pos()+f;for(;u.pos()<h&&u.next();)switch(u.tag()){case 2:{const m=u.getLength(),p=u.pos()+m;for(;u.pos()<p&&u.next();)u.tag()===3?(u.getUInt32(),o[l++]=n+e*u.getSInt64(),o[l++]=s+t*u.getSInt64(),o[l++]=a+r*u.getSInt64()):u.skip();break}default:u.skip()}return l}};function _t(i){for(;i.next();){if(i.tag()===2)return wt(i.getMessage());i.skip()}G()}function wt(i){for(;i.next();){if(i.tag()===1)return xt(i.getMessage());i.skip()}G()}function xt(i){let d,u,f=!1,h=!1,m=0;const p=new Array,x=new Array,y=new Array;for(;i.next();)switch(i.tag()){case 1:u=i.getString();break;case 7:i.getEnum()!==0&&G();break;case 9:f=i.getBool()??!1;break;case 12:d=Se(i.processMessage(Re));break;case 13:{const C=i.processMessage(Ae);C.index=m++,p.push(C);break}case 15:{x.push(i.pos());const C=i.getUInt32(),N=i.pos()+C;for(;i.pos()<N&&i.next();)i.tag()===1&&y.push(i.pos()),i.skip();break}case 10:h=i.getBool()??!1;break;default:i.skip()}const b=new Te(p);return d!=null&&h&&u!=null&&b.has(u)||G(),{transform:d,exceededTransferLimit:f,fieldsIndex:b,objectIdFieldName:u,featureIndices:x,attributeIndices:y}}function G(){const i=new $e("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(i),i}function B(i){const d=i.getLength(),u=i.pos()+d;for(;i.pos()<u&&i.next();)switch(i.tag()){case 1:return i.getString();case 2:return i.getFloat();case 3:return i.getDouble();case 4:return i.getSInt32();case 5:return i.getUInt32();case 6:return i.getInt64();case 7:return i.getUInt64();case 8:return i.getSInt64();case 9:return i.getBool();default:return i.skip(),null}return null}const S=k(),ee=8e3,yt=4,bt=4;let It=class{constructor(e,t,r,n,s){this.spatialReference=e,this.url=r,this.objectIdField=n,this.capabilities=s;const{supportsMaxRecordCountFactor:a,maxRecordCount:o}=this.capabilities.query,l=a?yt:1,c=(o??ee)*l;this._pageSize=Math.min(ee,c);const d=t.clone();d.cacheHint=!0,d.resultType="tile",d.outSpatialReference=e,d.returnGeometry=!0,d.returnZ=!0,d.maxRecordCountFactor=l,d.num=this._pageSize,d.outFields=[n],this._baseQuery=d}async fetch(e,t){const{spatialReference:r}=this,n=Oe(e.extent,r),s=this._baseQuery.clone();s.geometry=n;const a=new Array;let o=0,l=!1,c=1;for(;!l;){const d=[];for(let f=0;f<c;++f)d.push(this._fetchPage(s,o++,t));const u=await Promise.all(d);W(t);for(const f of u){const h=f.featureCount!==0;l||(l=!f.exceededTransferLimit||!h),h&&a.push(f)}c=Math.min(c+1,bt)}return new ft(e,a)}async _fetchPage(e,t,r){const n=e.clone();n.start=t*this._pageSize;const s=(await Ee(this.url,n,{signal:r})).data;return W(r),new pt(s)}},te=class{constructor(e){this._bufferWriter=null,this._bufferWriter=e.createBufferWriter()}createBuffer(e,t){const r=this._bufferWriter;let n=null;if(e.transformation&&t)Me(R,e.transformation),R[12]-=t[0],R[13]-=t[1],R[14]-=t[2],n=R;else{if(t)throw new Error("not implemented");e.transformation&&(n=e.transformation)}let s=null;n&&(Fe(P,R),Be(P,P),s=P);const a=e.attributes,o=r.elementCount(a),l=r.vertexBufferLayout.stride/4;o>Math.floor(Ct/l)&&console.warn("geometry with very large number of elements encountered");const c=r.vertexBufferLayout.createBuffer(o);return r.write(n,s,a,e.objectAndLayerIdColor,c,0),{data:c.buffer,elementCount:o}}};const R=F(),P=F(),Ct=16777216/4;let vt=class{constructor(e){this._context=e,this._commands=[],this._transferables=new Set}createMaterial(e){const t=this._context,r=t.generateId("material");switch(e){case"default":{const n=new Pe({},{spherical:this._context.globalViewingMode,doublePrecisionRequiresObfuscation:!0}),s=new te(n);t.registerRenderGeometryBufferWriter(r,s)}break;case"hud":{const n=ot(null,this._context.globalViewingMode)[0],s=new te(n);t.registerRenderGeometryBufferWriter(r,s)}}return this._commands.push({id:"create-material",type:e,materialId:r}),r}createDirectRenderer(e){const t=this._context.generateId("material-renderer");return this._commands.push({id:"create-direct-renderer",materialRendererId:t,materialId:e}),t}addDirectRendererGeometry(e,t,r){const n=t.materialId,s=this._context.getRenderGeometryBufferWriter(n);if(s==null)throw new Error(`no bufferwriter found for material ${n}`);const a=s.createBuffer(t,r);this._transferables.add(a.data),this._commands.push({id:"add-direct-renderer-geometry",renderGeometryId:e,materialId:n,renderGeometryBuffer:a,localOrigin:r})}removeDirectRendererGeometry(e){this._commands.push({id:"remove-direct-renderer-geometry",renderGeometryId:e})}createLodRenderer(e){const t=this._context.generateId("lod-renderer"),r={levels:e.levels.map(n=>({components:n.components.map(s=>{const a=s.attributes.get(g.POSITION);if(!a||a.indices.length===0)throw new Error("positions attribute expected");const o=3,l=je(a.indices.length/o),c=new Le(l,o,a),d=this._context.getRenderGeometryBufferWriter(s.materialId);if(d==null)throw new Error("writer not found");const u=d.createBuffer(s,null);return this._transferables.add(u.data),{materialId:s.materialId,renderGeometryBuffer:u,boundingInfo:{bbMax:c.bbMax,bbMin:c.bbMin}}}),minScreenSpaceRadius:n.minScreenSpaceRadius}))};return this._commands.push({id:"create-lod-renderer",lodRendererId:t,lodRenderGeometry:r}),t}addLodInstances(e,t){this._commands.push({id:"add-lod-instances",lodRendererId:e,data:t}),this._transferables.add(t.featureIds.buffer),this._transferables.add(t.globalTransforms.buffer),this._transferables.add(t.localTransforms.buffer)}removeLodInstances(e,t){this._commands.push({id:"remove-lod-instances",lodRendererId:e,featureIds:t}),this._transferables.add(t.buffer)}append(e){if(e._context!==this._context)throw new Error("Cannot append encoders from different contexts");const{_commands:t,_transferables:r}=this;for(const n of e._commands)t.push(n);for(const n of e._transferables)r.add(n)}async dispatch(){const e=this._commands,t=Array.from(this._transferables);this._clearCommandBuffer(),await this._context.dispatchRenderCommands(e,t)}_clearCommandBuffer(){this._commands=[],this._transferables.clear()}};class $t{constructor(e){this._idCounter=0,this._bufferWriters=new Map,this._dispatchRenderCommandsCallback=async()=>{},this.globalViewingMode=!1,this.globalViewingMode=e.viewingMode===Ge.Global,this._dispatchRenderCommandsCallback=e.dispatchRenderCommandsCallback}generateId(e=""){return`${e}${this._idCounter++}`}createEncoder(){return new vt(this)}async dispatchRenderCommands(e,t){e.length!==0&&await this._dispatchRenderCommandsCallback(e,t)}registerRenderGeometryBufferWriter(e,t){this._bufferWriters.set(e,t)}getRenderGeometryBufferWriter(e){return this._bufferWriters.get(e)}}let D=class{constructor(e,t){this._renderCommands=e,this._pipelineStateCommands=t}append(e){this.appendRenderCommands(e._renderCommands),this.appendPipelineStateCommands(e._pipelineStateCommands)}appendRenderCommands(e){this._renderCommands.append(e)}appendPipelineStateCommand(e){this._pipelineStateCommands.push(e)}appendPipelineStateCommands(e){const{_pipelineStateCommands:t}=this;for(const r of e)t.push(r)}execute(){for(const e of this._pipelineStateCommands)e();this._renderCommands.dispatch()}};function J(i,e){const{featureCount:t}=i;if(t===0)return new Uint32Array;const r=new Uint32Array(t);return i.readObjectIds(r),r}function le(i,e){const{featureCount:t}=i;if(t===0)return new Float64Array;const r=new Float64Array(3*t);return i.readCoordinates(r),r}function At(i,e){const{featureCount:t}=i;if(t===0)return new Float64Array;const r=le(i),n=e.viewSpatialReference,s=e.renderSpatialReference,a=new Float64Array(3*t);if(!ke(r,n,0,a,s,0,t))throw new Error("Failed to project coordinates");return a}function St(i,e){const t=e.viewSpatialReference,r=e.renderSpatialReference,{extent:n}=i,s=Ne(n),a=k();return De([s[0],s[1],0],t,a,r),a}function ce(i){const e=new Map;for(const[t,r]of i)e.set(t,{...r,indices:Qe(r.indices)});return e}function Rt(i,e){const t=(r,n,s=!1)=>({levels:r.map(a=>{const o=ce(n(a.tesselation));return s&&Tt(o),{components:[{attributes:o,objectAndLayerIdColor:void 0,transformation:null,materialId:e}],minScreenSpaceRadius:a.minScreenSpaceRadius}})});switch(i){case"cone":return t(Ot,r=>ze(1,.5,r,!1),!0);case"sphere":case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}function Tt(i){const e=i,t=e.get(g.POSITION).data,r=e.get(g.NORMAL).data;if(r){const n=re(i,g.NORMAL).data;for(let s=0;s<r.length;s+=3){const a=r[s+1];n[s+1]=-r[s+2],n[s+2]=a}}if(t){const n=re(i,g.POSITION).data;for(let s=0;s<t.length;s+=3){const a=t[s+1];n[s+1]=-t[s+2],n[s+2]=a}}}function re(i,e){let t=i.get(e);return t&&!t.exclusive&&(t={...t,exclusive:!0,data:We(t.data)},i.set(e,t)),t}const Ot=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];class Et{constructor(e){this._context=e,this.lodRendererId=null,this._loaded=!1,this._loadingPromise=null,this._primitive="cone"}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const e=this._context.renderCommandContext.createEncoder(),t=e.createMaterial("default"),r=Rt(this._primitive,t);this.lodRendererId=e.createLodRenderer(r),await e.dispatch(),this._loaded=!0}async createAddCommand(e){const t=this._context.renderCommandContext.createEncoder();if(this.lodRendererId==null)throw new Error("expected lod renderer id to not be null");const{featureCount:r}=e;if(r===0)return t;const n=!0,s=Ue(He(this._primitive)),a=V(qe(s)),o=V(Je(a,{isPrimitive:n,width:100,depth:null,height:null})),l=new Float64Array(16*r),c=new Float64Array(16*r),d=le(e,this._context);for(let h=0;h<r;++h){const m=h,p=d[3*h+0],x=d[3*h+1],y=d[3*h+2],b=this._computeGlobalTransform(p,x,y,this._context.viewSpatialReference,Ft),C=this._computeLocalTransform(o,a,Mt);this._writeMatrixToTypedBuffer(l,m,C),this._writeMatrixToTypedBuffer(c,m,b)}const u=J(e,this._context),f={featureIds:new Uint32Array(u),localTransforms:l,globalTransforms:c};return t.addLodInstances(this.lodRendererId,f),t}async createRemoveCommand(e){const t=this._context.renderCommandContext.createEncoder();if(this.lodRendererId==null)return t;const r=J(e,this._context);return t.removeLodInstances(this.lodRendererId,r),t}_writeMatrixToTypedBuffer(e,t,r){let n=16*t;for(let s=0;s<16;s++)e[n++]=r[s]}_computeGlobalTransform(e,t,r,n,s){return j[0]=e,j[1]=t,j[2]=r,Ye(n,j,s,this._context.renderSpatialReference),s}_computeLocalTransform(e,t,r){return Ze(r),this._applyObjectScale(e,t,r),r}_applyObjectScale(e,t,r){const n=Ve(e,e,t,this._context.renderCoordsHelper.unitInMeters);n[0]===1&&n[1]===1&&n[2]===1||Xe(r,r,n)}}const j=k(),Mt=F(),Ft=F();class Bt{constructor(e){this._context=e,this.materialId=null,this._loaded=!1,this._loadingPromise=null}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const e=this._context.renderCommandContext.createEncoder();this.materialId=e.createMaterial("hud"),e.createDirectRenderer(this.materialId),await e.dispatch(),this._loaded=!0}async createAddCommand(e){const t=this._context.renderCommandContext.createEncoder();if(this.materialId==null)throw new Error("expected material not to be null");const{featureCount:r,id:n}=e;if(r===0)return t;const s=At(e,this._context),a=St(e,this._context),o=new Float64Array([0,0,1]),l=new Float64Array([255,255,255,255]),c=new Float64Array([24,24]),d=new Float64Array([0,0,0,1]),u=new Float64Array([0,0]),f=new Float64Array([0]),h=new Uint32Array(r);for(let v=0;v<r;++v)h[v]=v;const m=new Uint32Array(r);for(let v=0;v<r;++v)m[v]=0;const p=new A(s,h,3,!0),x=new A(o,m,3,!0),y=new A(u,m,2,!0),b=new A(l,m,4,!0),C=new A(f,m,1,!0),N=new A(c,m,2,!0),ue=new A(d,m,4,!0),he=[[g.POSITION,p],[g.NORMAL,x],[g.UV0,y],[g.COLOR,b],[g.ROTATION,C],[g.SIZE,N],[g.CENTEROFFSETANDDISTANCE,ue]],me={attributes:ce(he),objectAndLayerIdColor:void 0,transformation:F(),materialId:this.materialId};return t.addDirectRendererGeometry(n,me,a),t}async createRemoveCommand(e){const t=this._context.renderCommandContext.createEncoder();return t.removeDirectRendererGeometry(e.id),t}}class Pt{constructor(e){this._symbols=new Array,this._featureDataPartitioning=new Map,this._context=e}async load(){this._symbols[0]=new Bt(this._context),this._symbols[1]=new Et(this._context)}async createAddCommand(e){const t=this._partition(e),r=await Promise.all(t.map(async({index:s,features:a})=>{const o=await this._provisionSymbol(s);return await(o==null?void 0:o.createAddCommand(a))})),n=this._context.renderCommandContext.createEncoder();for(const s of r)s!=null&&n.append(s);return new D(n,[()=>{this._featureDataPartitioning.set(e,t)}])}async createRemoveCommand(e){const{_featureDataPartitioning:t}=this,r=t.get(e),n=this._context.renderCommandContext.createEncoder();if(r==null)return new D(this._context.renderCommandContext.createEncoder(),[]);const s=await Promise.all(r.map(async({index:a,features:o})=>{const l=this._getLoadedSymbol(a);return await(l==null?void 0:l.createRemoveCommand(o))}));for(const a of s)a!=null&&n.append(a);return new D(n,[()=>{t.delete(e)}])}async _provisionSymbol(e){if(e==null)return null;const t=this._symbols[e];return t?(t.loaded||await t.load(),t):null}_getLoadedSymbol(e){if(e==null)return null;const t=this._symbols[e];return t!=null&&t.loaded?t:null}_partition(e){const t=J(e,this._context);if(t==null)throw new Error("unable to fetch objectIds");const{featureCount:r}=e,n=[[],[]];for(let s=0;s<r;++s)n[t[s]%2].push(s);return n.map((s,a)=>new jt(a,e.subset(new Uint32Array(s)))).filter(s=>s.features.featureCount>0)}}class jt{constructor(e,t){this.index=e,this.features=t}}let L=class extends ae.EventedAccessor{constructor(){super(...arguments),this.remoteClient=null,this._featureDataStore=new ut,this._featureStore=new mt,this._tileManager=null,this._renderer=null,this._fetcher=null,this._queryEngine=null,this._defaultQueryJSON=null}get updating(){return this._tileManager.updating}destroy(){var i;this._featureStore.clear(),(i=this._tileManager)==null||i.destroy()}async setup({viewSpatialReference:i,renderSpatialReference:e,viewingMode:t,baseQuery:r,url:n,objectIdField:s,capabilities:a,fieldsIndex:o,timeInfo:l,fullExtent:c}){const d=X.fromJSON(i),u=X.fromJSON(e);this._fetcher=new It(d,K.fromJSON(r),n,s,a),this._queryEngine=new it({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",objectIdField:s,fieldsIndex:o,availableFields:[s],spatialReference:i,featureStore:this._featureStore,timeInfo:l}),this._renderer=new Pt({viewSpatialReference:d,renderSpatialReference:u,renderCoordsHelper:Ke.create(t,u),renderCommandContext:new $t({viewingMode:t,dispatchRenderCommandsCallback:(h,m)=>this.remoteClient.invoke("dispatchRenderCommands",h,{transferList:m})})}),this._defaultQueryJSON=new K({outSpatialReference:d}).toJSON();let f=null;if(c!=null){const h=et.fromJSON(c);await tt(h.spatialReference,d),f=rt(h,d)}return this._tileManager=new _({loadTile:(h,m)=>this._fetcher.fetch(h,m),createAddTileCommand:(h,m)=>this._createAddTileCommand(h,m),createRemoveTileCommand:h=>this._createRemoveTileCommand(h),extent:f}),this.addHandles(nt(()=>this.updating,h=>{this.emit("notify-updating",{updating:h})}),st),await this._renderer.load(),ne}async executeQuery(i,e){return{result:await this._queryEngine.executeQuery(this._ensureQuery(i),e)}}async executeQueryForIds(i,e){const t=await this._queryEngine.executeQueryForIdSet(this._ensureQuery(i),e);return{result:Array.from(t)}}async executeQueryForCount(i,e){return{result:await this._queryEngine.executeQueryForCount(this._ensureQuery(i),e)}}async executeQueryForExtent(i,e){return{result:await this._queryEngine.executeQueryForExtent(this._ensureQuery(i),e)}}async executeQueryForLatestObservations(i,e){return{result:await this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(i),e)}}async onTileTreeChange(i){return await this._tileManager.onTileTreeChange(i),ne}async _createAddTileCommand(i,e){const t=new ct(i),r=await this._renderer.createAddCommand(t);return W(e),r.appendPipelineStateCommand(()=>{this._featureDataStore.add(t),this._featureStore.addTile(i)}),r}async _createRemoveTileCommand(i){const e=this._featureStore,t=this._featureDataStore,r=this._renderer,n=t.get(i);if(n==null)return null;const s=await r.createRemoveCommand(n);return s.appendPipelineStateCommand(()=>{t.remove(i),e.removeTile(i)}),s}_ensureQuery(i){return i??this._defaultQueryJSON}};w([I()],L.prototype,"updating",null),L=w([ie("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],L);const lr=L,ne={result:void 0};export{lr as default};
